<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ““ ãƒãƒ¼ãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&family=Noto+Serif+JP:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: 'Noto Sans JP', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #4a4a50; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #5a5a60; }
    .resizer { width: 4px; cursor: col-resize; background: transparent; transition: background 0.2s; }
    .resizer:hover { background: #8b7355; }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .mobile-nav { 
        position: fixed !important; 
        bottom: 0 !important; 
        left: 0 !important; 
        right: 0 !important; 
        height: 60px !important; 
        width: 100% !important;
        flex-direction: row !important; 
        justify-content: space-around !important;
        z-index: 1000;
        border-top: 1px solid #3a3a40;
        border-right: none !important;
      }
      .mobile-nav > div:first-child { display: none !important; }
      .mobile-sidebar {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 60px !important;
        width: 100% !important;
        z-index: 999;
      }
      .mobile-main {
        padding-bottom: 60px !important;
      }
    }
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useLayoutEffect, useRef, useCallback, useMemo } = React;

    // ==================== ã‚¢ã‚¤ã‚³ãƒ³ ====================
    const Icons = {
      Home: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
      Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      Book: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
      FileText: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
      Folder: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
      File: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>,
      Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      X: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ChevronDown: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
      ChevronRight: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
      ChevronLeft: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
      Sun: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
      Moon: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
      Settings: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
      Play: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
      Pause: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
      RotateCcw: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,
      Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
      Check: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
      Eye: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
      EyeOff: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
      ExternalLink: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
      GripVertical: () => <svg width="10" height="16" viewBox="0 0 10 16" fill="currentColor"><circle cx="2" cy="2" r="1.5"/><circle cx="8" cy="2" r="1.5"/><circle cx="2" cy="8" r="1.5"/><circle cx="8" cy="8" r="1.5"/><circle cx="2" cy="14" r="1.5"/><circle cx="8" cy="14" r="1.5"/></svg>,
      Download: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
      Upload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
      Lightbulb: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>,
      Archive: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
      Tag: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
      Calendar: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      Film: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>,
      Lock: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      Cloud: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
      CloudUpload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
      CloudDownload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/></svg>,
      Shield: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
    };

    // ==================== å®‰å®šã—ãŸTextareaã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ====================
    // è¦ªã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«å½±éŸ¿ã•ã‚Œãªã„
    const StableTextarea = React.memo(({ id, initialValue, onChange, onSelect, onMouseUp, placeholder, style }) => {
      const ref = useRef(null);
      
      // åˆæœŸå€¤ã‚’è¨­å®šï¼ˆä¸€åº¦ã ã‘ï¼‰
      useEffect(() => {
        if (ref.current && ref.current.value === '') {
          ref.current.value = initialValue || '';
        }
      }, []);
      
      // idãŒå¤‰ã‚ã£ãŸã‚‰å€¤ã‚’æ›´æ–°
      useEffect(() => {
        if (ref.current) {
          ref.current.value = initialValue || '';
        }
      }, [id]);
      
      const handleChange = useCallback((e) => {
        onChange(e.target.value);
      }, [onChange]);
      
      return (
        <textarea
          ref={ref}
          defaultValue={initialValue}
          onChange={handleChange}
          onSelect={onSelect}
          onMouseUp={onMouseUp}
          placeholder={placeholder}
          style={style}
        />
      );
    }, (prev, next) => {
      // idãŒåŒã˜ãªã‚‰å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„
      return prev.id === next.id;
    });

    // ==================== æš—å·åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====================
    const CryptoUtils = {
      // Web Crypto APIãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      isAvailable() {
        if (!window.crypto || !window.crypto.subtle) {
          return { available: false, reason: 'Web Crypto APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“' };
        }
        
        // iOS Safariã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
        try {
          // localStorageã®ãƒ†ã‚¹ãƒˆ
          const test = '__crypto_test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return { available: true };
        } catch (e) {
          return { available: false, reason: 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚' };
        }
      },
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æš—å·åŒ–ã‚­ãƒ¼ã‚’ç”Ÿæˆ
      async deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          'raw', encoder.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
        );
        return crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
          keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
        );
      },
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
      async encrypt(data, password) {
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await this.deriveKey(password, salt);
        const encoder = new TextEncoder();
        
        // å®‰å…¨ã«JSONæ–‡å­—åˆ—åŒ–
        const jsonString = typeof data === 'string' ? data : JSON.stringify(data);
        
        const encrypted = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv }, key, encoder.encode(jsonString)
        );
        // salt + iv + encrypted data ã‚’Base64ã§è¿”ã™
        const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
        combined.set(salt, 0);
        combined.set(iv, salt.length);
        combined.set(new Uint8Array(encrypted), salt.length + iv.length);
        
        // å¤§ããªãƒ‡ãƒ¼ã‚¿ã§ã‚‚ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã—ãªã„ã‚ˆã†ã«ãƒãƒ£ãƒ³ã‚¯å‡¦ç†
        let binary = '';
        const chunkSize = 8192;
        for (let i = 0; i < combined.length; i += chunkSize) {
          const chunk = combined.subarray(i, Math.min(i + chunkSize, combined.length));
          binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary);
      },
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·
      async decrypt(encryptedBase64, password) {
        try {
          // å¤§ããªãƒ‡ãƒ¼ã‚¿ã§ã‚‚å®‰å…¨ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
          const binaryStr = atob(encryptedBase64);
          const combined = new Uint8Array(binaryStr.length);
          for (let i = 0; i < binaryStr.length; i++) {
            combined[i] = binaryStr.charCodeAt(i);
          }
          const salt = combined.slice(0, 16);
          const iv = combined.slice(16, 28);
          const encrypted = combined.slice(28);
          const key = await this.deriveKey(password, salt);
          const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
          return JSON.parse(new TextDecoder().decode(decrypted));
        } catch (e) {
          throw new Error('å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
        }
      },
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥ï¼ˆæ¤œè¨¼ç”¨ï¼‰
      async hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password + 'noteapp-salt-v1');
        const hash = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode(...new Uint8Array(hash)));
      }
    };

    // ==================== GitHub Gist API ====================
    const GistAPI = {
      async saveToGist(token, gistId, encryptedData, passwordHash) {
        const content = JSON.stringify({ encrypted: encryptedData, hash: passwordHash, version: 2 });
        const body = {
          description: 'NoteApp Backup (Encrypted)',
          public: false,
          files: { 'noteapp-backup.json': { content } }
        };
        
        const url = gistId 
          ? `https://api.github.com/gists/${gistId}`
          : 'https://api.github.com/gists';
        
        const response = await fetch(url, {
          method: gistId ? 'PATCH' : 'POST',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Gistã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        return response.json();
      },
      
      async loadFromGist(token, gistId) {
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Gistã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const gist = await response.json();
        const file = gist.files['noteapp-backup.json'];
        if (!file) throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        
        return JSON.parse(file.content);
      }
    };

    // ==================== ãƒ†ãƒ¼ãƒ ====================
    const getTheme = (dark) => ({
      bg: dark ? '#1a1a1f' : '#f8f7f4',
      bgSecondary: dark ? '#232328' : '#ffffff',
      bgTertiary: dark ? '#2a2a30' : '#f0efe9',
      text: dark ? '#e8e6e3' : '#2d2d2d',
      textSecondary: dark ? '#9a9a9a' : '#666666',
      border: dark ? '#3a3a40' : '#e0ddd5',
      accent: dark ? '#8b7355' : '#6b5344',
      accentLight: dark ? '#a08060' : '#8b7355',
      highlight: dark ? '#3d3a35' : '#fff9e6',
      success: '#4ade80',
      warning: '#fbbf24',
      error: '#f87171',
      tagColors: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'],
    });

    // ==================== åˆæœŸãƒ‡ãƒ¼ã‚¿ ====================
    const initialData = {
      creative: {
        inProgress: [{ id: 'work-1', name: 'æ–°è¦ä½œå“', tags: [], expanded: true, targetCount: 0, items: [
          { id: 'item-1', type: 'chapter', name: '1è©±', content: '' },
          { id: 'item-2', type: 'memo', name: 'ãƒ—ãƒ­ãƒƒãƒˆ', content: '# ç¬¬ä¸€ç« \n## ã‚·ãƒ¼ãƒ³1\nã“ã“ã«å†…å®¹' },
        ]}],
        completed: [],
        onHold: [], // åˆ¶ä½œä¸­æ–­ï¼ˆä½œå“å˜ä½ï¼‰
        holdItems: [], // ä¿ç•™ï¼ˆè©±å˜ä½ï¼‰
        ideas: [], // ãƒã‚¿ä¿ç®¡åº«
        stickies: [], // å…¨ä½“ä»˜ç®‹
      },
      daily: [], // æ—¥å¸¸ãƒ¡ãƒ¢
      input: [], // Inputï¼ˆèª­æ›¸ãƒ»æ˜ ç”»ãªã©ï¼‰
      reminders: [],
      tags: ['BL', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'ãƒ›ãƒ©ãƒ¼', 'ãƒ„ã‚¤ãƒãƒ™', 'ã‚ªãƒ¡ã‚¬ãƒãƒ¼ã‚¹'],
      dailyTags: ['ä»•äº‹', 'è²·ã„ç‰©', 'ã‚¢ã‚¤ãƒ‡ã‚¢', 'æ—¥è¨˜'],
      inputTags: ['å°èª¬', 'æ¼«ç”»', 'Audible', 'æ˜ ç”»', 'ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'YouTube'],
      stickyColors: ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'],
      progress: {},
      progressAdjustments: {}, // æ‰‹å‹•èª¿æ•´ï¼ˆã‚³ãƒ”ãƒšåˆ†ã‚’ãƒã‚¤ãƒŠã‚¹ãªã©ï¼‰
      settings: { 
        pomodoroWork: 55, 
        pomodoroBreak: 5, 
        calendarEmbed: '',
        sidebarWidth: 280,
      },
      widgetLayout: [
        { id: 'weather', x: 0, y: 0, w: 2, h: 2 },
        { id: 'todayProgress', x: 2, y: 0, w: 2, h: 2 },
        { id: 'reminders', x: 4, y: 0, w: 8, h: 2 },
        { id: 'calendar', x: 0, y: 2, w: 6, h: 4 },
        { id: 'weeklyChart', x: 6, y: 2, w: 6, h: 2 },
        { id: 'links', x: 6, y: 4, w: 6, h: 2 },
      ],
      collapsedSections: { completed: true, onHold: true, holdItems: true }, // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹
    };

    // ==================== ã‚¿ã‚¤ãƒãƒ¼ ====================
    const PomodoroTimer = ({ theme, settings }) => {
      const [mode, setMode] = useState('work');
      const [timeLeft, setTimeLeft] = useState(settings.pomodoroWork * 60);
      const [isRunning, setIsRunning] = useState(false);
      const [customWork, setCustomWork] = useState(settings.pomodoroWork);
      const [customBreak, setCustomBreak] = useState(settings.pomodoroBreak);
      const audioContextRef = useRef(null);

      const playSound = useCallback((type) => {
        try {
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }
          const ctx = audioContextRef.current;
          
          // çµ‚äº†éŸ³ï¼š3å›é³´ã‚‰ã™
          const playBeep = (freq, delay) => {
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.8, ctx.currentTime + delay);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + delay + 0.3);
            oscillator.start(ctx.currentTime + delay);
            oscillator.stop(ctx.currentTime + delay + 0.3);
          };
          
          if (type === 'workEnd') {
            // ä½œæ¥­çµ‚äº†ï¼šé«˜ã„éŸ³3å›
            playBeep(880, 0);
            playBeep(880, 0.4);
            playBeep(1046.5, 0.8);
          } else if (type === 'breakEnd') {
            // ä¼‘æ†©çµ‚äº†ï¼šä½ã‚ã®éŸ³3å›
            playBeep(523.25, 0);
            playBeep(523.25, 0.4);
            playBeep(659.25, 0.8);
          }
        } catch (e) { console.log('Audio not supported'); }
      }, []);

      useEffect(() => {
        let interval;
        if (isRunning && timeLeft > 0) {
          interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
        } else if (timeLeft === 0 && isRunning) {
          if (mode === 'work') {
            playSound('workEnd');
            setTimeout(() => { setMode('break'); setTimeLeft(customBreak * 60); }, 1500);
          } else {
            playSound('breakEnd');
            setTimeout(() => { setMode('work'); setTimeLeft(customWork * 60); }, 1500);
          }
        }
        return () => clearInterval(interval);
      }, [isRunning, timeLeft, mode, customWork, customBreak, playSound]);

      const toggleTimer = () => {
        setIsRunning(!isRunning);
      };

      const resetTimer = () => { setIsRunning(false); setMode('work'); setTimeLeft(customWork * 60); };
      const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
      const progress = mode === 'work' ? (1 - timeLeft / (customWork * 60)) * 100 : (1 - timeLeft / (customBreak * 60)) * 100;

      return (
        <div style={{ padding: '16px', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
            <span style={{ fontSize: '12px', color: theme.textSecondary }}>{mode === 'work' ? 'ğŸ”¥ ä½œæ¥­ä¸­' : 'â˜• ä¼‘æ†©ä¸­'}</span>
            <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>
              <input type="number" value={customWork} onChange={(e) => { setCustomWork(Number(e.target.value)); if (!isRunning && mode === 'work') setTimeLeft(Number(e.target.value) * 60); }} style={{ width: '36px', padding: '2px 4px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, textAlign: 'center' }} />
              <span style={{ fontSize: '11px', color: theme.textSecondary }}>/</span>
              <input type="number" value={customBreak} onChange={(e) => { setCustomBreak(Number(e.target.value)); if (!isRunning && mode === 'break') setTimeLeft(Number(e.target.value) * 60); }} style={{ width: '36px', padding: '2px 4px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, textAlign: 'center' }} />
              <span style={{ fontSize: '11px', color: theme.textSecondary }}>åˆ†</span>
            </div>
          </div>
          <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ fontSize: '36px', fontWeight: '600', fontFamily: 'monospace', color: mode === 'work' ? theme.accent : theme.success }}>{formatTime(timeLeft)}</div>
          </div>
          <div style={{ height: '4px', background: theme.bgTertiary, borderRadius: '2px', marginBottom: '12px', overflow: 'hidden' }}>
            <div style={{ height: '100%', width: `${progress}%`, background: mode === 'work' ? theme.accent : theme.success, transition: 'width 1s linear' }} />
          </div>
          <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>
            <button onClick={toggleTimer} style={{ padding: '8px 20px', background: isRunning ? theme.warning : theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}>
              {isRunning ? <Icons.Pause /> : <Icons.Play />}{isRunning ? 'ä¸€æ™‚åœæ­¢' : 'ã‚¹ã‚¿ãƒ¼ãƒˆ'}
            </button>
            <button onClick={resetTimer} style={{ padding: '8px 12px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '6px', cursor: 'pointer', display: 'flex', alignItems: 'center' }}><Icons.RotateCcw /></button>
          </div>
        </div>
      );
    };

    // ==================== ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ ====================
    const FloatingPomodoro = ({ theme, onClose }) => {
      // localStorageã‹ã‚‰åˆæœŸçŠ¶æ…‹ã‚’å¾©å…ƒ
      const getSavedState = () => {
        try {
          const saved = localStorage.getItem('pomodoroState');
          if (saved) {
            const state = JSON.parse(saved);
            // ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ãŸå ´åˆã€çµŒéæ™‚é–“ã‚’è¨ˆç®—
            if (state.isRunning && state.lastUpdateTime) {
              const elapsed = Math.floor((Date.now() - state.lastUpdateTime) / 1000);
              state.timeLeft = Math.max(0, state.timeLeft - elapsed);
            }
            return state;
          }
        } catch (e) {
          console.log('Failed to load pomodoro state');
        }
        return null;
      };

      const savedState = getSavedState();
      const [mode, setMode] = useState(savedState?.mode || 'work');
      const [timeLeft, setTimeLeft] = useState(savedState?.timeLeft || 55 * 60);
      const [isRunning, setIsRunning] = useState(savedState?.isRunning || false);
      const [customWork, setCustomWork] = useState(savedState?.customWork || 55);
      const [customBreak, setCustomBreak] = useState(savedState?.customBreak || 5);
      const [isMinimized, setIsMinimized] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      
      // éŸ³å£°è¨­å®š
      const [bgmEnabled, setBgmEnabled] = useState(true);
      const [sfxEnabled, setSfxEnabled] = useState(true);
      const [bgmVolume, setBgmVolume] = useState(0.3);
      const [sfxVolume, setSfxVolume] = useState(0.7);
      const [workBgm, setWorkBgm] = useState('rain'); // ä½œæ¥­ç”¨BGM
      const [breakBgm, setBreakBgm] = useState('houkagonoyuzora'); // ä¼‘æ†©ç”¨BGM
      const [workBgmCategory, setWorkBgmCategory] = useState('all'); // ä½œæ¥­ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const [breakBgmCategory, setBreakBgmCategory] = useState('all'); // ä¼‘æ†©ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      
      // Audio refs
      const bgmRef = useRef(null);
      const countdownRef = useRef(null);
      const isFadingRef = useRef(false);
      
      // BGMã‚«ãƒ†ã‚´ãƒª
      const bgmCategories = [
        { id: 'all', name: 'ğŸµ ã™ã¹ã¦' },
        { id: 'env', name: 'ğŸŒ¿ ç’°å¢ƒéŸ³' },
        { id: 'sad', name: 'ğŸ’§ åˆ‡ãªã„' },
        { id: 'fantasy', name: 'âœ¨ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼' },
        { id: 'dark', name: 'ğŸŒ™ ã»ã®æš—ã„' },
        { id: 'dirty', name: 'ğŸ° ãƒ€ãƒ¼ãƒ†ã‚£' },
        { id: 'horror', name: 'ğŸ‘» ãƒ›ãƒ©ãƒ¼' },
        { id: 'comic', name: 'ğŸª ã‚³ãƒŸã‚«ãƒ«' },
      ];
      
      // åˆ©ç”¨å¯èƒ½ãªBGM
      const bgmOptions = [
        { id: 'none', name: 'ğŸ”‡ ãªã—', category: 'all' },
        // ç’°å¢ƒéŸ³
        { id: 'rain', name: 'ğŸŒ§ï¸ é›¨éŸ³', category: 'env' },
        { id: 'water', name: 'ğŸ’§ æ°´ã®ä¸­', category: 'env' },
        { id: 'summermountain1', name: 'â›°ï¸ å¤ã®å±±ï¼‘', category: 'env' },
        { id: 'summermountain2', name: 'â›°ï¸ å¤ã®å±±ï¼’', category: 'env' },
        { id: 'summer', name: 'ğŸŒ¾ å¤ã®ç”°èˆé“', category: 'env' },
        { id: 'summernight', name: 'ğŸŒ™ å¤ã®ç”°èˆã®å¤œ', category: 'env' },
        // åˆ‡ãªã„
        { id: 'painfulpiano', name: 'ğŸ¹ åˆ‡ãªã„ãƒ”ã‚¢ãƒæ›²ï¼‘', category: 'sad' },
        { id: 'painfulpiano2', name: 'ğŸ¹ åˆ‡ãªã„ãƒ”ã‚¢ãƒæ›²ï¼’', category: 'sad' },
        { id: 'summermemory', name: 'ğŸŒ» å¤ã®æ€ã„å‡º', category: 'sad' },
        { id: 'Moment', name: 'â³ Moment', category: 'sad' },
        { id: 'natsunokiri', name: 'ğŸŒ«ï¸ å¤ã®éœ§', category: 'sad' },
        { id: 'noel1', name: 'ğŸ„ ãƒã‚¨ãƒ«', category: 'sad' },
        { id: 'tsumetainamida', name: 'â„ï¸ å†·ãŸã„æ¶™', category: 'sad' },
        { id: 'houkagonoyuzora', name: 'ğŸŒ‡ æ”¾èª²å¾Œã®å¤•ç©º', category: 'sad' },
        { id: 'quietworld', name: 'ğŸ¤« é™å¯‚ã®ä¸–ç•Œã¸', category: 'sad' },
        // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼
        { id: 'basharoad', name: 'ğŸ´ é¦¬è»Šé“', category: 'fantasy' },
        { id: 'denshounooka', name: 'ğŸ€ ä¼æ‰¿ã®ä¸˜', category: 'fantasy' },
        { id: 'magiccity', name: 'ğŸ° é­”æ³•éƒ½å¸‚ã®ç¹è¯è¡—', category: 'fantasy' },
        { id: 'sinarioofdestiny', name: 'âš”ï¸ å®¿å‘½ã®ã‚·ãƒŠãƒªã‚ª', category: 'fantasy' },
        { id: 'newworld', name: 'ğŸŒ… æ–°ãŸãªå¤§åœ°', category: 'fantasy' },
        // ã»ã®æš—ã„
        { id: 'frouts', name: 'ğŸ æœç‰©å±‹', category: 'dark' },
        { id: 'myakudou', name: 'ğŸ’“ è„ˆå‹•', category: 'dark' },
        { id: 'serious', name: 'ğŸ˜ ã‚·ãƒªã‚¢ã‚¹', category: 'dark' },
        { id: 'kobuneniyurerushallot', name: 'ğŸš£ å°èˆŸã«æºã‚Œã‚‹ã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒˆ', category: 'dark' },
        { id: 'andalusiawaltz', name: 'ğŸ’ƒ ã‚¢ãƒ³ãƒ€ãƒ«ã‚·ã‚¢ãƒ»ãƒ¯ãƒ«ãƒ„', category: 'dark' },
        // ãƒ€ãƒ¼ãƒ†ã‚£
        { id: 'casino', name: 'ğŸ° ã‚«ã‚¸ãƒæ›²', category: 'dirty' },
        { id: 'fishy', name: 'ğŸŸ æ€ªã—ã„æ›²', category: 'dirty' },
        { id: 'jazztown', name: 'ğŸ· ã‚¸ãƒ£ã‚¸ãƒ¼ãªç”ºã®æ›²', category: 'dirty' },
        // ãƒ›ãƒ©ãƒ¼
        { id: 'izanauwarabeuta', name: 'ğŸ‘§ ã‚¤ã‚¶ãƒŠã‚¦ãƒ¯ãƒ©ãƒ™', category: 'horror' },
        { id: 'dethoflondon', name: 'ğŸ‡¬ğŸ‡§ ãƒ­ãƒ³ãƒ‰ãƒ³ã®æ­»', category: 'horror' },
        { id: 'coffeemaker', name: 'â˜• ãƒ–ãƒªã‚­ã®ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼', category: 'horror' },
        // ã‚³ãƒŸã‚«ãƒ«
        { id: 'dacing', name: 'ğŸŒ¿ è‰åŸãƒ€ãƒ³ã‚¹ã‚£ãƒ³ã‚°', category: 'comic' },
        { id: 'youkinamafia', name: 'ğŸ•º é™½æ°—ãªãƒãƒ•ã‚£ã‚¢', category: 'comic' },
        { id: 'raribou', name: 'ğŸ˜µ ãƒ©ãƒªåŠ', category: 'comic' },
      ];
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸBGMãƒªã‚¹ãƒˆï¼ˆä½œæ¥­ç”¨ï¼‰
      const filteredWorkBgmOptions = workBgmCategory === 'all' 
        ? bgmOptions 
        : bgmOptions.filter(b => b.category === workBgmCategory || b.id === 'none');
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸBGMãƒªã‚¹ãƒˆï¼ˆä¼‘æ†©ç”¨ï¼‰
      const filteredBreakBgmOptions = breakBgmCategory === 'all' 
        ? bgmOptions 
        : bgmOptions.filter(b => b.category === breakBgmCategory || b.id === 'none');
      
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†
      const fadeOut = useCallback((audio, duration = 2000) => {
        return new Promise((resolve) => {
          if (!audio || audio.paused) { resolve(); return; }
          const startVolume = audio.volume;
          const steps = 20;
          const stepTime = duration / steps;
          const volumeStep = startVolume / steps;
          let currentStep = 0;
          
          const fadeInterval = setInterval(() => {
            currentStep++;
            audio.volume = Math.max(0, startVolume - (volumeStep * currentStep));
            if (currentStep >= steps) {
              clearInterval(fadeInterval);
              audio.pause();
              audio.volume = startVolume;
              resolve();
            }
          }, stepTime);
        });
      }, []);
      
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å‡¦ç†
      const fadeIn = useCallback((audio, targetVolume, duration = 2000) => {
        if (!audio) return;
        audio.volume = 0;
        audio.play().catch(() => {});
        const steps = 20;
        const stepTime = duration / steps;
        const volumeStep = targetVolume / steps;
        let currentStep = 0;
        
        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.min(targetVolume, volumeStep * currentStep);
          if (currentStep >= steps) {
            clearInterval(fadeInterval);
          }
        }, stepTime);
      }, []);
      
      // BGMå†ç”Ÿ
      const playBgm = useCallback((bgmId, fade = true) => {
        if (!bgmEnabled || bgmId === 'none') {
          if (bgmRef.current) bgmRef.current.pause();
          return;
        }
        
        const url = `https://mi0424.github.io/note/sounds/${bgmId}.mp3`;
        if (bgmRef.current) {
          bgmRef.current.pause();
        }
        bgmRef.current = new Audio(url);
        bgmRef.current.loop = true;
        if (fade) {
          fadeIn(bgmRef.current, bgmVolume);
        } else {
          bgmRef.current.volume = bgmVolume;
          bgmRef.current.play().catch(() => {});
        }
      }, [bgmEnabled, bgmVolume, fadeIn]);
      
      // ä½œæ¥­ä¸­ã«BGMå¤‰æ›´ã—ãŸå ´åˆã€å³åº§ã«åˆ‡ã‚Šæ›¿ãˆ
      const handleWorkBgmChange = (newBgm) => {
        setWorkBgm(newBgm);
        if (isRunning && mode === 'work') {
          playBgm(newBgm, false);
        }
      };
      
      const handleBreakBgmChange = (newBgm) => {
        setBreakBgm(newBgm);
        if (isRunning && mode === 'break') {
          playBgm(newBgm, false);
        }
      };
      
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³åŠ¹æœéŸ³å†ç”Ÿ
      const playCountdown = useCallback(() => {
        if (!sfxEnabled) return;
        try {
          countdownRef.current = new Audio('https://mi0424.github.io/note/sounds/countdown.mp3');
          countdownRef.current.volume = sfxVolume;
          countdownRef.current.play().catch(() => {});
        } catch (e) {
          console.log('Countdown SFX not available');
        }
      }, [sfxEnabled, sfxVolume]);
      
      // 3ç§’å‰ã®å‡¦ç†
      useEffect(() => {
        if (isRunning && timeLeft === 3 && !isFadingRef.current) {
          isFadingRef.current = true;
          // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³åŠ¹æœéŸ³ã‚’å†ç”Ÿ
          playCountdown();
          // BGMã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          if (bgmRef.current) {
            fadeOut(bgmRef.current, 2500);
          }
        }
      }, [timeLeft, isRunning, playCountdown, fadeOut]);
      
      // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã®å‡¦ç†
      useEffect(() => {
        if (isRunning) {
          isFadingRef.current = false;
          const currentBgm = mode === 'work' ? workBgm : breakBgm;
          playBgm(currentBgm);
        }
      }, [mode, isRunning]);
      
      // é–‹å§‹/åœæ­¢æ™‚ã®å‡¦ç†
      useEffect(() => {
        if (isRunning && bgmEnabled) {
          const currentBgm = mode === 'work' ? workBgm : breakBgm;
          if (currentBgm !== 'none') {
            playBgm(currentBgm);
          }
        } else {
          if (bgmRef.current) {
            bgmRef.current.pause();
          }
        }
        return () => {
          if (bgmRef.current) bgmRef.current.pause();
        };
      }, [isRunning, bgmEnabled]);
      
      // éŸ³é‡å¤‰æ›´æ™‚
      useEffect(() => {
        if (bgmRef.current && !isFadingRef.current) {
          bgmRef.current.volume = bgmVolume;
        }
      }, [bgmVolume]);

      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
      useEffect(() => {
        let interval;
        if (isRunning && timeLeft > 0) {
          interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
        } else if (timeLeft === 0 && isRunning) {
          // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
          setTimeout(() => {
            isFadingRef.current = false;
            if (mode === 'work') {
              setMode('break');
              setTimeLeft(customBreak * 60);
            } else {
              setMode('work');
              setTimeLeft(customWork * 60);
            }
          }, 500);
        }
        return () => clearInterval(interval);
      }, [isRunning, timeLeft, mode, customWork, customBreak]);

      const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
      const progress = mode === 'work' ? (1 - timeLeft / (customWork * 60)) * 100 : (1 - timeLeft / (customBreak * 60)) * 100;

      // çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
      useEffect(() => {
        try {
          const state = {
            mode,
            timeLeft,
            isRunning,
            customWork,
            customBreak,
            lastUpdateTime: Date.now()
          };
          localStorage.setItem('pomodoroState', JSON.stringify(state));
        } catch (e) {
          console.log('Failed to save pomodoro state');
        }
      }, [mode, timeLeft, isRunning, customWork, customBreak]);

      // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
      const handleReset = () => {
        setIsRunning(false);
        setMode('work');
        setTimeLeft(customWork * 60);
        isFadingRef.current = false;
        if (bgmRef.current) bgmRef.current.pause();
        if (countdownRef.current) countdownRef.current.pause();
        // localStorageã‚‚ã‚¯ãƒªã‚¢
        localStorage.removeItem('pomodoroState');
      };

      // æœ€å°åŒ–æ™‚
      if (isMinimized) {
        return (
          <div 
            onClick={() => setIsMinimized(false)}
            style={{ 
              position: 'fixed', bottom: '80px', right: '20px', zIndex: 1001,
              background: mode === 'work' ? theme.accent : theme.success, 
              color: '#fff', borderRadius: '50%', width: '56px', height: '56px',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              cursor: 'pointer', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
              flexDirection: 'column', fontSize: '11px', fontWeight: '600'
            }}
          >
            <span style={{ fontSize: '14px' }}>{isRunning ? 'ğŸ”¥' : 'â¸ï¸'}</span>
            <span style={{ fontFamily: 'monospace' }}>{formatTime(timeLeft)}</span>
          </div>
        );
      }

      return (
        <div style={{ 
          position: 'fixed', bottom: '80px', right: '20px', zIndex: 1001,
          background: theme.bgSecondary, borderRadius: '16px', padding: '16px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.3)', border: `1px solid ${theme.border}`,
          width: showSettings ? '300px' : '200px', maxHeight: '80vh', overflow: 'auto'
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
            <span style={{ fontSize: '12px', color: theme.textSecondary }}>{mode === 'work' ? 'ğŸ”¥ ä½œæ¥­ä¸­' : 'â˜• ä¼‘æ†©'}</span>
            <div style={{ display: 'flex', gap: '4px' }}>
              <button onClick={() => setShowSettings(!showSettings)} style={{ background: showSettings ? theme.accent : 'none', border: 'none', color: showSettings ? '#fff' : theme.textSecondary, cursor: 'pointer', padding: '4px', borderRadius: '4px' }} title="éŸ³å£°è¨­å®š">
                ğŸ”Š
              </button>
              <button onClick={() => setIsMinimized(true)} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px' }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </button>
              <button onClick={onClose} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px' }}><Icons.X /></button>
            </div>
          </div>
          
          {showSettings ? (
            <div style={{ marginBottom: '12px', padding: '12px', background: theme.bgTertiary, borderRadius: '8px' }}>
              {/* BGM ON/OFF */}
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                <span style={{ fontSize: '11px', color: theme.textSecondary }}>ğŸµ BGM</span>
                <button onClick={() => setBgmEnabled(!bgmEnabled)} style={{ padding: '2px 8px', fontSize: '10px', background: bgmEnabled ? theme.accent : theme.bgSecondary, color: bgmEnabled ? '#fff' : theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>
                  {bgmEnabled ? 'ON' : 'OFF'}
                </button>
              </div>
              
              {/* ä½œæ¥­ç”¨BGM */}
              <div style={{ marginBottom: '14px', padding: '10px', background: theme.bg, borderRadius: '6px', border: `1px solid ${theme.accent}40` }}>
                <span style={{ fontSize: '10px', color: theme.accent, fontWeight: '600', display: 'block', marginBottom: '6px' }}>ğŸ”¥ ä½œæ¥­ç”¨BGM {isRunning && mode === 'work' && '(å†ç”Ÿä¸­)'}</span>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '3px', marginBottom: '6px' }}>
                  {bgmCategories.filter(c => c.id !== 'other').map(cat => (
                    <button 
                      key={cat.id} 
                      onClick={() => setWorkBgmCategory(cat.id)}
                      style={{ 
                        padding: '2px 6px', 
                        fontSize: '8px', 
                        background: workBgmCategory === cat.id ? theme.accent : 'transparent', 
                        color: workBgmCategory === cat.id ? '#fff' : theme.textSecondary, 
                        border: `1px solid ${workBgmCategory === cat.id ? theme.accent : theme.border}`, 
                        borderRadius: '3px', 
                        cursor: 'pointer' 
                      }}
                    >
                      {cat.name}
                    </button>
                  ))}
                </div>
                <select 
                  value={workBgm} 
                  onChange={(e) => handleWorkBgmChange(e.target.value)} 
                  disabled={!bgmEnabled} 
                  style={{ width: '100%', padding: '6px', fontSize: '11px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text }}
                >
                  {filteredWorkBgmOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}
                </select>
              </div>
              
              {/* ä¼‘æ†©ç”¨BGM */}
              <div style={{ marginBottom: '12px', padding: '10px', background: theme.bg, borderRadius: '6px', border: `1px solid ${theme.success}40` }}>
                <span style={{ fontSize: '10px', color: theme.success, fontWeight: '600', display: 'block', marginBottom: '6px' }}>â˜• ä¼‘æ†©ç”¨BGM {isRunning && mode === 'break' && '(å†ç”Ÿä¸­)'}</span>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '3px', marginBottom: '6px' }}>
                  {bgmCategories.filter(c => c.id !== 'other').map(cat => (
                    <button 
                      key={cat.id} 
                      onClick={() => setBreakBgmCategory(cat.id)}
                      style={{ 
                        padding: '2px 6px', 
                        fontSize: '8px', 
                        background: breakBgmCategory === cat.id ? theme.success : 'transparent', 
                        color: breakBgmCategory === cat.id ? '#fff' : theme.textSecondary, 
                        border: `1px solid ${breakBgmCategory === cat.id ? theme.success : theme.border}`, 
                        borderRadius: '3px', 
                        cursor: 'pointer' 
                      }}
                    >
                      {cat.name}
                    </button>
                  ))}
                </div>
                <select 
                  value={breakBgm} 
                  onChange={(e) => handleBreakBgmChange(e.target.value)} 
                  disabled={!bgmEnabled} 
                  style={{ width: '100%', padding: '6px', fontSize: '11px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text }}
                >
                  {filteredBreakBgmOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}
                </select>
              </div>
              
              {/* éŸ³é‡ */}
              <div style={{ marginBottom: '10px' }}>
                <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸµ BGMéŸ³é‡</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '4px' }}>
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸ”ˆ</span>
                  <input type="range" min="0" max="1" step="0.1" value={bgmVolume} onChange={(e) => setBgmVolume(Number(e.target.value))} disabled={!bgmEnabled} style={{ flex: 1 }} />
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸ”Š</span>
                </div>
              </div>
              
              {/* åŠ¹æœéŸ³ */}
              <div>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸ”” ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³åŠ¹æœéŸ³</span>
                  <button onClick={() => setSfxEnabled(!sfxEnabled)} style={{ padding: '2px 8px', fontSize: '10px', background: sfxEnabled ? theme.accent : theme.bgSecondary, color: sfxEnabled ? '#fff' : theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>
                    {sfxEnabled ? 'ON' : 'OFF'}
                  </button>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸ”ˆ</span>
                  <input type="range" min="0" max="1" step="0.1" value={sfxVolume} onChange={(e) => setSfxVolume(Number(e.target.value))} disabled={!sfxEnabled} style={{ flex: 1 }} />
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>ğŸ”Š</span>
                </div>
              </div>
            </div>
          ) : (
            <>
              <div style={{ textAlign: 'center', marginBottom: '12px' }}>
                <div style={{ fontSize: '32px', fontWeight: '600', fontFamily: 'monospace', color: mode === 'work' ? theme.accent : theme.success }}>
                  {formatTime(timeLeft)}
                </div>
              </div>
              
              <div style={{ height: '4px', background: theme.bgTertiary, borderRadius: '2px', marginBottom: '12px', overflow: 'hidden' }}>
                <div style={{ height: '100%', width: `${progress}%`, background: mode === 'work' ? theme.accent : theme.success, transition: 'width 1s linear' }} />
              </div>
            </>
          )}
          
          <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>
            <button onClick={() => setIsRunning(!isRunning)} style={{ padding: '8px 16px', background: isRunning ? theme.warning : theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px' }}>
              {isRunning ? <Icons.Pause /> : <Icons.Play />}
            </button>
            <button onClick={handleReset} style={{ padding: '8px 10px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '6px', cursor: 'pointer' }}>
              <Icons.RotateCcw />
            </button>
          </div>
          
          <div style={{ display: 'flex', gap: '4px', alignItems: 'center', justifyContent: 'center', marginTop: '12px' }}>
            <input type="number" value={customWork} onChange={(e) => { setCustomWork(Number(e.target.value)); if (!isRunning && mode === 'work') setTimeLeft(Number(e.target.value) * 60); }} style={{ width: '36px', padding: '2px 4px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, textAlign: 'center' }} />
            <span style={{ fontSize: '11px', color: theme.textSecondary }}>/</span>
            <input type="number" value={customBreak} onChange={(e) => { setCustomBreak(Number(e.target.value)); if (!isRunning && mode === 'break') setTimeLeft(Number(e.target.value) * 60); }} style={{ width: '36px', padding: '2px 4px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, textAlign: 'center' }} />
            <span style={{ fontSize: '11px', color: theme.textSecondary }}>åˆ†</span>
          </div>
          
          {/* ç¾åœ¨ã®éŸ³å£°çŠ¶æ…‹è¡¨ç¤º */}
          <div style={{ display: 'flex', gap: '8px', justifyContent: 'center', marginTop: '8px', fontSize: '10px', color: theme.textSecondary }}>
            {bgmEnabled && isRunning && (
              <span>ğŸµ {bgmOptions.find(b => b.id === (mode === 'work' ? workBgm : breakBgm))?.name}</span>
            )}
            {sfxEnabled && <span>ğŸ””</span>}
            {!bgmEnabled && !sfxEnabled && <span>ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ</span>}
          </div>
        </div>
      );
    };

    // ==================== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ ====================
    const RemindersWidget = ({ reminders, setReminders, theme }) => {
      const [newReminder, setNewReminder] = useState('');
      const addReminder = () => { if (newReminder.trim()) { setReminders([...reminders, { id: Date.now(), text: newReminder, done: false }]); setNewReminder(''); } };

      return (
        <div style={{ padding: '12px', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
            <input type="text" value={newReminder} onChange={(e) => setNewReminder(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addReminder()} placeholder="å¿˜ã‚Œã¡ã‚ƒã„ã‘ãªã„ã“ã¨..." style={{ flex: 1, padding: '8px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none' }} />
            <button onClick={addReminder} style={{ padding: '8px 12px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer' }}><Icons.Plus /></button>
          </div>
          <div style={{ flex: 1, overflow: 'auto' }}>
            {reminders.map(r => (
              <div key={r.id} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px', marginBottom: '4px', background: r.done ? 'transparent' : theme.highlight, borderRadius: '6px', opacity: r.done ? 0.5 : 1 }}>
                <button onClick={() => setReminders(reminders.map(x => x.id === r.id ? {...x, done: !x.done} : x))} style={{ width: '20px', height: '20px', borderRadius: '4px', border: `2px solid ${r.done ? theme.success : theme.border}`, background: r.done ? theme.success : 'transparent', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff', flexShrink: 0 }}>{r.done && <Icons.Check />}</button>
                <span style={{ flex: 1, fontSize: '13px', color: theme.text, textDecoration: r.done ? 'line-through' : 'none' }}>{r.text}</span>
                <button onClick={() => setReminders(reminders.filter(x => x.id !== r.id))} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '4px', opacity: 0.6 }}><Icons.X /></button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ==================== ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé¡ ====================
    const TodayProgressWidget = ({ progress, progressAdjustments = {}, theme, onAdjust }) => {
      const [showAdjust, setShowAdjust] = useState(false);
      const [adjustValue, setAdjustValue] = useState('');
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜ã‚’å–å¾—
      const now = new Date();
      const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      const rawProgress = progress[today] || 0;
      const adjustment = progressAdjustments[today] || 0;
      const todayProgress = Math.max(0, rawProgress + adjustment);
      const goal = 2000;
      
      const handleAdjust = (value) => {
        if (onAdjust && !isNaN(value)) {
          onAdjust(today, (progressAdjustments[today] || 0) + value);
        }
        setAdjustValue('');
        setShowAdjust(false);
      };
      
      return (
        <div style={{ padding: '16px', height: '100%', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
          <div style={{ textAlign: 'center', marginBottom: '12px' }}>
            <div style={{ fontSize: '28px', fontWeight: '600', color: theme.accent, whiteSpace: 'nowrap' }}>{todayProgress.toLocaleString()} å­—</div>
            <div style={{ fontSize: '12px', color: theme.textSecondary, whiteSpace: 'nowrap' }}>ç›®æ¨™: {goal.toLocaleString()} å­—</div>
            {adjustment !== 0 && (
              <div style={{ fontSize: '10px', color: adjustment < 0 ? theme.error : theme.success, marginTop: '2px' }}>
                ({adjustment > 0 ? '+' : ''}{adjustment.toLocaleString()} èª¿æ•´)
              </div>
            )}
          </div>
          <div style={{ height: '8px', background: theme.bgTertiary, borderRadius: '4px', overflow: 'hidden', marginBottom: '8px' }}>
            <div style={{ height: '100%', width: `${Math.min((todayProgress / goal) * 100, 100)}%`, background: todayProgress >= goal ? theme.success : theme.accent, transition: 'width 0.3s' }} />
          </div>
          {showAdjust ? (
            <div style={{ display: 'flex', gap: '4px', alignItems: 'center', justifyContent: 'center' }}>
              <input 
                type="number" 
                value={adjustValue}
                onChange={(e) => setAdjustValue(e.target.value)}
                placeholder="-500"
                style={{ width: '70px', padding: '4px 6px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, textAlign: 'center' }}
              />
              <button onClick={() => handleAdjust(parseInt(adjustValue) || 0)} style={{ padding: '4px 8px', fontSize: '10px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>OK</button>
              <button onClick={() => setShowAdjust(false)} style={{ padding: '4px 6px', fontSize: '10px', background: theme.bgTertiary, color: theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>âœ•</button>
            </div>
          ) : (
            <button 
              onClick={() => setShowAdjust(true)}
              style={{ alignSelf: 'center', padding: '2px 8px', fontSize: '9px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}
            >
              Â± èª¿æ•´
            </button>
          )}
        </div>
      );
    };

    const WeeklyChartWidget = ({ progress, progressAdjustments = {}, theme }) => {
      const [period, setPeriod] = useState(7); // 7, 14, 30, 90æ—¥
      const [offset, setOffset] = useState(0); // éå»ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚ªãƒ•ã‚»ãƒƒãƒˆ
      
      const days = [];
      const startOffset = offset * period;
      for (let i = period - 1 + startOffset; i >= startOffset; i--) {
        const date = new Date(); date.setDate(date.getDate() - i);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const rawValue = progress[key] || 0;
        const adjustment = progressAdjustments[key] || 0;
        const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
        const label = period <= 14 ? dayOfWeek : `${date.getMonth()+1}/${date.getDate()}`;
        days.push({ label, value: Math.max(0, rawValue + adjustment), isToday: i === 0, date: key });
      }
      const maxValue = Math.max(...days.map(d => d.value), 1000);
      const maxBarHeight = 80;
      const totalChars = days.reduce((sum, d) => sum + d.value, 0);
      
      // æœŸé–“ã®ãƒ©ãƒ™ãƒ«
      const getPeriodLabel = () => {
        if (offset === 0) return 'ç¾åœ¨';
        const endDate = new Date(); endDate.setDate(endDate.getDate() - offset * period);
        const startDate = new Date(); startDate.setDate(startDate.getDate() - (offset + 1) * period + 1);
        return `${startDate.getMonth()+1}/${startDate.getDate()}ã€œ${endDate.getMonth()+1}/${endDate.getDate()}`;
      };
      
      return (
        <div style={{ padding: '12px', height: '100%', display: 'flex', flexDirection: 'column' }}>
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', flexWrap: 'wrap', gap: '4px' }}>
            <div style={{ display: 'flex', gap: '4px' }}>
              {[7, 14, 30, 90].map(p => (
                <button key={p} onClick={() => { setPeriod(p); setOffset(0); }} style={{ padding: '2px 6px', fontSize: '9px', background: period === p ? theme.accent : theme.bgTertiary, color: period === p ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                  {p === 7 ? '1é€±' : p === 14 ? '2é€±' : p === 30 ? '1ãƒ¶æœˆ' : '3ãƒ¶æœˆ'}
                </button>
              ))}
            </div>
            <span style={{ fontSize: '10px', color: theme.accent, fontWeight: '600' }}>è¨ˆ {totalChars.toLocaleString()}å­—</span>
          </div>
          {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
            <button onClick={() => setOffset(o => o + 1)} style={{ padding: '2px 8px', fontSize: '10px', background: theme.bgTertiary, border: 'none', borderRadius: '4px', cursor: 'pointer', color: theme.textSecondary }}>â—€ å‰</button>
            <span style={{ fontSize: '10px', color: theme.textSecondary }}>{getPeriodLabel()}</span>
            <button onClick={() => setOffset(o => Math.max(0, o - 1))} disabled={offset === 0} style={{ padding: '2px 8px', fontSize: '10px', background: offset === 0 ? theme.bgTertiary : theme.bgTertiary, border: 'none', borderRadius: '4px', cursor: offset === 0 ? 'not-allowed' : 'pointer', color: theme.textSecondary, opacity: offset === 0 ? 0.5 : 1 }}>æ¬¡ â–¶</button>
          </div>
          {/* ã‚°ãƒ©ãƒ• */}
          <div style={{ flex: 1, display: 'flex', alignItems: 'flex-end', gap: period <= 14 ? '4px' : '2px', overflow: 'hidden' }}>
            {days.map((d, i) => {
              const barHeight = Math.max((d.value / maxValue) * maxBarHeight, d.value > 0 ? 4 : 2);
              return (
                <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', minWidth: 0 }}>
                  <span style={{ fontSize: '8px', color: d.isToday ? theme.accent : theme.textSecondary, fontWeight: d.value > 0 ? '500' : '400', minHeight: '12px', overflow: 'hidden' }}>
                    {d.value > 0 ? (d.value >= 1000 ? `${(d.value/1000).toFixed(1)}k` : d.value) : ''}
                  </span>
                  <div style={{ width: '100%', height: `${barHeight}px`, background: d.isToday ? theme.accent : d.value > 0 ? theme.accentLight : theme.bgTertiary, borderRadius: '2px 2px 0 0' }} title={`${d.date}: ${d.value.toLocaleString()}å­—`} />
                  <span style={{ fontSize: period <= 14 ? '9px' : '7px', color: d.isToday ? theme.accent : theme.textSecondary, fontWeight: d.isToday ? '600' : '400', overflow: 'hidden', textOverflow: 'ellipsis' }}>{d.label}</span>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    const WeatherWidget = ({ theme }) => (
      <div style={{ width: '100%', height: '100%', overflow: 'hidden' }}>
        <iframe src="https://indify.co/widgets/live/weather/tvvsqN4o7AvPl8J62E6R" style={{ width: '100%', height: '100%', border: 'none' }} title="Weather" />
      </div>
    );

    const LinksWidget = ({ theme }) => {
      const links = [
        { name: 'Claude', url: 'https://claude.ai', color: '#d4a574' },
        { name: 'ChatGPT', url: 'https://chat.openai.com', color: '#74aa9c' },
        { name: 'ä¹—æ›æ¡ˆå†…', url: 'https://transit.yahoo.co.jp/', color: '#6366f1' },
      ];
      return (
        <div style={{ padding: '12px', display: 'flex', flexWrap: 'wrap', gap: '8px', alignItems: 'center', height: '100%' }}>
          {links.map(l => (
            <a key={l.name} href={l.url} target="_blank" rel="noopener noreferrer" style={{ padding: '10px 16px', background: l.color, color: '#fff', borderRadius: '8px', textDecoration: 'none', fontSize: '13px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}>
              {l.name}<Icons.ExternalLink />
            </a>
          ))}
        </div>
      );
    };

    const CalendarWidget = ({ embedCode, theme }) => {
      if (!embedCode) {
        return (
          <div style={{ padding: '20px', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary, fontSize: '13px', textAlign: 'center' }}>
            è¨­å®šç”»é¢ã§Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®<br/>åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã­
          </div>
        );
      }
      // iframeã®srcã‚’æŠ½å‡º
      const srcMatch = embedCode.match(/src="([^"]+)"/);
      if (!srcMatch) {
        return (
          <div style={{ padding: '20px', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.error, fontSize: '13px' }}>
            åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„ã‚ˆ
          </div>
        );
      }
      return (
        <iframe src={srcMatch[1]} style={{ width: '100%', height: '100%', border: 'none' }} title="Calendar" />
      );
    };

    // ==================== ãƒ›ãƒ¼ãƒ  ====================
    const HomeScreen = ({ data, setData, theme }) => {
      const handleProgressAdjust = (date, newAdjustment) => {
        setData({
          ...data,
          progressAdjustments: {
            ...data.progressAdjustments,
            [date]: newAdjustment
          }
        });
      };
      
      const widgets = {
        weather: { title: 'ğŸŒ¤ï¸ å¤©æ°—', component: <WeatherWidget theme={theme} /> },
        timer: { title: 'â±ï¸ ã‚¿ã‚¤ãƒãƒ¼', component: <PomodoroTimer theme={theme} settings={data.settings} /> },
        todayProgress: { title: 'âœï¸ ä»Šæ—¥ã®åŸ·ç­†', component: <TodayProgressWidget progress={data.progress} progressAdjustments={data.progressAdjustments} theme={theme} onAdjust={handleProgressAdjust} /> },
        weeklyChart: { title: 'ğŸ“Š é€±é–“ã‚°ãƒ©ãƒ•', component: <WeeklyChartWidget progress={data.progress} progressAdjustments={data.progressAdjustments} theme={theme} /> },
        reminders: { title: 'ğŸ“Œ å¿˜ã‚Œã¡ã‚ƒã„ã‘ãªã„ã“ã¨', component: <RemindersWidget reminders={data.reminders} setReminders={(r) => setData({...data, reminders: r})} theme={theme} /> },
        links: { title: 'ğŸ”— ãƒªãƒ³ã‚¯', component: <LinksWidget theme={theme} /> },
        calendar: { title: 'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', component: <CalendarWidget embedCode={data.settings.calendarEmbed} theme={theme} /> },
      };
      
      const isMobileView = window.innerWidth <= 768;
      
      return (
        <div style={{ padding: isMobileView ? '16px' : '24px', height: '100%', overflow: 'auto' }}>
          <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '20px', color: theme.text }}>ğŸ  ãƒ›ãƒ¼ãƒ </h2>
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: isMobileView ? '1fr' : 'repeat(12, 1fr)', 
            gap: isMobileView ? '12px' : '16px', 
            gridAutoRows: isMobileView ? 'auto' : '120px' 
          }}>
            {data.widgetLayout.map(w => {
              const widget = widgets[w.id];
              if (!widget) return null;
              return (
                <div key={w.id} style={{ 
                  gridColumn: isMobileView ? 'span 1' : `span ${w.w}`, 
                  gridRow: isMobileView ? 'span 1' : `span ${w.h}`, 
                  background: theme.bgSecondary, 
                  borderRadius: '12px', 
                  border: `1px solid ${theme.border}`, 
                  overflow: 'hidden', 
                  display: 'flex', 
                  flexDirection: 'column',
                  minHeight: isMobileView ? '150px' : 'auto'
                }}>
                  <div style={{ padding: '8px 12px', borderBottom: `1px solid ${theme.border}`, fontSize: '12px', fontWeight: '500', color: theme.textSecondary, display: 'flex', alignItems: 'center', gap: '6px', flexShrink: 0 }}>
                    <Icons.GripVertical />{widget.title}
                  </div>
                  <div style={{ flex: 1, overflow: 'hidden', minHeight: 0 }}>{widget.component}</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ==================== ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ ====================
    const OutlineEditor = ({ content, onChange, theme }) => {
      const [collapsed, setCollapsed] = useState({});
      const [draggedId, setDraggedId] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      const [contentCollapsed, setContentCollapsed] = useState({}); // å†…å®¹éƒ¨åˆ†ã®æŠ˜ã‚ŠãŸãŸã¿
      const scrollContainerRef = useRef(null);
      const scrollPositionRef = useRef(0);

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
      const saveScrollPosition = () => {
        if (scrollContainerRef.current) {
          scrollPositionRef.current = scrollContainerRef.current.scrollTop;
        }
      };

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
      useEffect(() => {
        if (scrollContainerRef.current && scrollPositionRef.current > 0) {
          scrollContainerRef.current.scrollTop = scrollPositionRef.current;
        }
      });

      const autoResize = (textarea) => {
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = Math.max(60, textarea.scrollHeight) + 'px';
        }
      };

      const parseOutline = (text) => {
        if (!text) return [];
        const lines = text.split('\n');
        const sections = [];
        let current = null;
        let buffer = [];

        const save = () => {
          if (current) {
            current.content = buffer.join('\n');
            sections.push(current);
          }
        };

        lines.forEach((line, i) => {
          const h1 = line.match(/^# (.*)$/);
          const h2 = line.match(/^## (.*)$/);
          const h3 = line.match(/^### (.*)$/);
          if (h1 || h2 || h3) {
            save();
            current = { id: `section-${sections.length}`, level: h1 ? 1 : h2 ? 2 : 3, title: h1?.[1] || h2?.[1] || h3?.[1] || '', content: '' };
            buffer = [];
          } else {
            buffer.push(line);
          }
        });
        save();

        if (sections.length === 0 && text.trim()) {
          sections.push({ id: 'section-0', level: 0, title: '', content: text });
        }
        return sections;
      };

      const sections = parseOutline(content);

      const rebuildContent = (sectionList) => {
        const newContent = sectionList.map(s => {
          if (s.level === 0) return s.content;
          const prefix = '#'.repeat(s.level) + ' ' + s.title;
          return s.content ? prefix + '\n' + s.content : prefix;
        }).join('\n');
        onChange(newContent);
      };

      const updateSection = (sectionId, field, value) => {
        saveScrollPosition();
        const newSections = sections.map(s => s.id === sectionId ? { ...s, [field]: value } : s);
        rebuildContent(newSections);
      };

      const addSectionAfter = (afterId, level) => {
        const idx = sections.findIndex(s => s.id === afterId);
        const newSection = { id: `section-new-${Date.now()}`, level, title: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³', content: '' };
        const newSections = [...sections];
        newSections.splice(idx + 1, 0, newSection);
        rebuildContent(newSections);
      };

      const addChildSection = (parentId) => {
        const idx = sections.findIndex(s => s.id === parentId);
        const parentLevel = sections[idx].level;
        // æœ€å¤§3éšå±¤ã¾ã§
        if (parentLevel >= 3) return;
        const newSection = { id: `section-new-${Date.now()}`, level: parentLevel + 1, title: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³', content: '' };
        const newSections = [...sections];
        newSections.splice(idx + 1, 0, newSection);
        rebuildContent(newSections);
      };

      const addSection = (level) => {
        const newSection = { id: `section-new-${Date.now()}`, level, title: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³', content: '' };
        rebuildContent([...sections, newSection]);
      };

      const deleteSection = (sectionId) => {
        if (confirm('ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          rebuildContent(sections.filter(s => s.id !== sectionId));
        }
      };

      const handleDragStart = (e, id) => { 
        setDraggedId(id); 
        e.dataTransfer.effectAllowed = 'move';
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
        saveScrollPosition();
      };
      const handleDragOver = (e, id) => { 
        e.preventDefault();
        e.stopPropagation();
        if (id !== draggedId) setDragOverId(id);
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å›ºå®š
        if (scrollContainerRef.current && scrollPositionRef.current !== null) {
          scrollContainerRef.current.scrollTop = scrollPositionRef.current;
        }
      };
      const handleDragLeave = () => { setDragOverId(null); };
      const handleDrop = (e, targetId) => {
        e.preventDefault();
        if (draggedId && targetId && draggedId !== targetId) {
          const draggedIdx = sections.findIndex(s => s.id === draggedId);
          const targetIdx = sections.findIndex(s => s.id === targetId);
          if (draggedIdx !== -1 && targetIdx !== -1) {
            const newSections = [...sections];
            const [dragged] = newSections.splice(draggedIdx, 1);
            newSections.splice(targetIdx, 0, dragged);
            rebuildContent(newSections);
          }
        }
        setDraggedId(null);
        setDragOverId(null);
      };
      const handleDragEnd = () => { 
        setDraggedId(null); 
        setDragOverId(null); 
        scrollPositionRef.current = 0; // ãƒªã‚»ãƒƒãƒˆ
      };

      const hasChildren = (idx) => idx + 1 < sections.length && sections[idx + 1].level > sections[idx].level;
      const isHidden = (idx) => {
        const s = sections[idx];
        for (let i = idx - 1; i >= 0; i--) {
          const prev = sections[i];
          if (prev.level < s.level && prev.level > 0 && collapsed[prev.id]) return true;
          if (prev.level > 0 && prev.level < s.level) break;
        }
        return false;
      };
      const toggleCollapse = (id) => { setCollapsed(prev => ({ ...prev, [id]: !prev[id] })); };

      if (sections.length === 0 || (sections.length === 1 && sections[0].level === 0 && !sections[0].content?.trim())) {
        return (
          <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
            <div style={{ padding: '8px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', background: theme.bgSecondary }}>
              <span style={{ fontSize: '11px', color: theme.textSecondary }}>ğŸ’¡ # å¤§é …ç›® / ## ä¸­é …ç›® / ### å°é …ç›® ã§éšå±¤åŒ–</span>
              <div style={{ flex: 1 }} />
              <button onClick={() => addSection(1)} style={{ padding: '4px 8px', fontSize: '11px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>+ å¤§é …ç›®</button>
              <button onClick={() => addSection(2)} style={{ padding: '4px 8px', fontSize: '11px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>+ ä¸­é …ç›®</button>
            </div>
            <textarea value={content || ''} onChange={(e) => onChange(e.target.value)} placeholder="ã“ã“ã«ãƒ—ãƒ­ãƒƒãƒˆã‚’æ›¸ã..." style={{ flex: 1, padding: '20px 24px', background: theme.bg, border: 'none', outline: 'none', resize: 'none', fontSize: '15px', lineHeight: '2', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
          </div>
        );
      }

      return (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ padding: '8px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', background: theme.bgSecondary, flexShrink: 0, flexWrap: 'wrap' }}>
            <button onClick={() => addSection(1)} style={{ padding: '4px 10px', fontSize: '11px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>+ å¤§é …ç›®</button>
            <button onClick={() => addSection(2)} style={{ padding: '4px 10px', fontSize: '11px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>+ ä¸­é …ç›®</button>
            <button onClick={() => addSection(3)} style={{ padding: '4px 10px', fontSize: '11px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>+ å°é …ç›®</button>
            <div style={{ flex: 1 }} />
            <button onClick={() => {
              // ãƒ—ãƒ­ãƒƒãƒˆå…¨ä½“ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ”ãƒ¼
              const plainText = sections.map(s => {
                if (s.level === 0) return s.content;
                const prefix = s.level === 1 ? 'â–  ' : s.level === 2 ? 'ã€€â— ' : 'ã€€ã€€ãƒ» ';
                return prefix + s.title + (s.content.trim() ? '\n' + s.content : '');
              }).join('\n\n');
              navigator.clipboard.writeText(plainText);
              alert('ãƒ—ãƒ­ãƒƒãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }} style={{ padding: '4px 10px', fontSize: '11px', background: theme.success, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
              ğŸ“‹ å…¨ä½“ã‚³ãƒ”ãƒ¼
            </button>
            <span style={{ fontSize: '10px', color: theme.textSecondary }}>â¬ ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ</span>
            <button onClick={() => {
              const allIds = sections.filter(s => s.level > 0).map(s => s.id);
              const allCollapsed = allIds.every(id => collapsed[id]);
              const newCollapsed = {};
              allIds.forEach(id => { newCollapsed[id] = !allCollapsed; });
              setCollapsed(newCollapsed);
            }} style={{ padding: '4px 10px', fontSize: '11px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }} title="å­é …ç›®ã‚‚å«ã‚ã¦å…¨éƒ¨æŠ˜ã‚ŠãŸãŸã¿">
              {Object.values(collapsed).filter(Boolean).length > 0 ? 'ğŸ“‚ å…¨é–‹ã' : 'ğŸ“ å…¨é–‰ã˜ã‚‹'}
            </button>
            <button onClick={() => {
              const allIds = sections.filter(s => s.level > 0).map(s => s.id);
              const allContentCollapsed = allIds.every(id => contentCollapsed[id]);
              const newContentCollapsed = {};
              allIds.forEach(id => { newContentCollapsed[id] = !allContentCollapsed; });
              setContentCollapsed(newContentCollapsed);
            }} style={{ padding: '4px 10px', fontSize: '11px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }} title="å†…å®¹ã ã‘æŠ˜ã‚ŠãŸãŸã¿ï¼ˆå­é …ç›®ã¯æ®‹ã‚‹ï¼‰">
              {Object.values(contentCollapsed).filter(Boolean).length > 0 ? 'ğŸ“ å†…å®¹é–‹ã' : 'ğŸ“„ å†…å®¹é–‰ã˜ã‚‹'}
            </button>
          </div>

          <div ref={scrollContainerRef} style={{ flex: 1, overflow: 'auto', padding: '12px', background: theme.bg }}>
            {sections.map((s, idx) => {
              if (isHidden(idx)) return null;
              const indent = s.level > 0 ? (s.level - 1) * 24 : 0;
              const isCollapsedItem = collapsed[s.id];
              const isDragging = draggedId === s.id;
              const isDragOver = dragOverId === s.id;

              if (s.level === 0) {
                return (
                  <div key={s.id} style={{ marginBottom: '8px' }}>
                    <textarea value={s.content} onChange={(e) => { updateSection(s.id, 'content', e.target.value); autoResize(e.target); }} ref={(el) => el && autoResize(el)} style={{ width: '100%', minHeight: '60px', padding: '12px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '8px', color: theme.text, fontSize: '14px', lineHeight: '1.8', resize: 'none', outline: 'none', fontFamily: '"Noto Serif JP", serif', overflow: 'hidden' }} />
                  </div>
                );
              }

              return (
                <div key={s.id} draggable onDragStart={(e) => handleDragStart(e, s.id)} onDragOver={(e) => handleDragOver(e, s.id)} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, s.id)} onDragEnd={handleDragEnd} style={{ marginLeft: indent, marginBottom: '6px', opacity: isDragging ? 0.5 : 1, transform: isDragOver ? 'translateY(4px)' : 'none', transition: 'transform 0.15s, opacity 0.15s' }}>
                  {isDragOver && <div style={{ height: '3px', background: theme.accent, borderRadius: '2px', marginBottom: '4px' }} />}
                  <div style={{ background: theme.bgSecondary, borderRadius: '8px', border: `1px solid ${isDragOver ? theme.accent : theme.border}`, borderLeft: s.level === 1 ? `4px solid ${theme.accent}` : s.level === 2 ? `4px solid ${theme.accentLight}` : `4px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: isCollapsedItem ? theme.bgTertiary : 'transparent', borderBottom: (isCollapsedItem || contentCollapsed[s.id]) ? 'none' : `1px solid ${theme.border}` }}>
                      <span style={{ cursor: 'grab', color: theme.textSecondary, display: 'flex', padding: '2px' }} title="ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•"><Icons.GripVertical /></span>
                      <span onClick={() => toggleCollapse(s.id)} style={{ color: theme.textSecondary, display: 'flex', transform: isCollapsedItem ? 'rotate(0deg)' : 'rotate(90deg)', transition: 'transform 0.2s', cursor: 'pointer', padding: '2px' }} title="å­é …ç›®ã‚‚å«ã‚ã¦æŠ˜ã‚ŠãŸãŸã¿"><Icons.ChevronRight /></span>
                      <input type="text" value={s.title} onChange={(e) => updateSection(s.id, 'title', e.target.value)} placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..." style={{ flex: 1, background: 'transparent', border: 'none', outline: 'none', fontSize: s.level === 1 ? '15px' : '14px', fontWeight: s.level === 1 ? '600' : '500', color: s.level === 1 ? theme.accent : theme.text, padding: '4px' }} />
                      {(isCollapsedItem || contentCollapsed[s.id]) && s.content.trim() && <span style={{ fontSize: '11px', color: theme.textSecondary, maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{s.content.trim().substring(0, 25)}...</span>}
                      <div style={{ display: 'flex', gap: '2px' }}>
                        <button onClick={() => setContentCollapsed(prev => ({ ...prev, [s.id]: !prev[s.id] }))} style={{ padding: '2px 6px', fontSize: '10px', background: contentCollapsed[s.id] ? theme.accent : theme.bgTertiary, color: contentCollapsed[s.id] ? '#fff' : theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }} title="å†…å®¹ã ã‘æŠ˜ã‚ŠãŸãŸã¿">
                          {contentCollapsed[s.id] ? 'ğŸ“' : 'ğŸ“„'}
                        </button>
                        <button onClick={() => addSectionAfter(s.id, s.level)} style={{ padding: '2px 6px', fontSize: '10px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }} title="ä¸‹ã«åŒãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ ">+</button>
                        {s.level < 3 && (
                          <button onClick={() => addChildSection(s.id)} style={{ padding: '2px 6px', fontSize: '10px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }} title="ä¸‹ã®éšå±¤ã«è¿½åŠ ">â†³</button>
                        )}
                        <button onClick={() => deleteSection(s.id)} style={{ padding: '2px 6px', fontSize: '10px', background: 'transparent', color: theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer', opacity: 0.6 }} title="å‰Šé™¤"><Icons.Trash /></button>
                      </div>
                    </div>
                    {!isCollapsedItem && !contentCollapsed[s.id] && (
                      <textarea value={s.content} onChange={(e) => { updateSection(s.id, 'content', e.target.value); autoResize(e.target); }} ref={(el) => el && autoResize(el)} placeholder="å†…å®¹ã‚’å…¥åŠ›..." style={{ width: '100%', minHeight: '60px', padding: '12px', background: 'transparent', border: 'none', outline: 'none', color: theme.text, fontSize: '14px', lineHeight: '1.8', resize: 'none', overflow: 'hidden', fontFamily: '"Noto Serif JP", serif' }} />
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ==================== æ—¥å¸¸ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ====================
    const DailySection = ({ data, setData, theme }) => {
      const [selectedMemo, setSelectedMemo] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [tagFilter, setTagFilter] = useState('all');

      const addMemo = () => {
        const newMemo = { id: `daily-${Date.now()}`, title: 'æ–°ã—ã„ãƒ¡ãƒ¢', content: '', tags: [], createdAt: new Date().toISOString() };
        setData({ ...data, daily: [newMemo, ...data.daily] });
        setSelectedMemo(newMemo);
      };

      const updateMemo = (id, field, value) => {
        setData({ ...data, daily: data.daily.map(m => m.id === id ? { ...m, [field]: value } : m) });
        if (selectedMemo?.id === id) setSelectedMemo({ ...selectedMemo, [field]: value });
      };

      const deleteMemo = (id) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setData({ ...data, daily: data.daily.filter(m => m.id !== id) });
          if (selectedMemo?.id === id) setSelectedMemo(null);
        }
      };

      const addTagToMemo = (memoId, tag) => {
        const memo = data.daily.find(m => m.id === memoId);
        if (memo && !memo.tags.includes(tag)) {
          updateMemo(memoId, 'tags', [...memo.tags, tag]);
        }
      };

      const removeTagFromMemo = (memoId, tag) => {
        const memo = data.daily.find(m => m.id === memoId);
        if (memo) {
          updateMemo(memoId, 'tags', memo.tags.filter(t => t !== tag));
        }
      };

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      const filteredMemos = tagFilter === 'all' 
        ? data.daily 
        : data.daily.filter(m => m.tags.includes(tagFilter));

      // ä½¿ç”¨ä¸­ã®ã‚¿ã‚°ã‚’åé›†
      const usedTags = [...new Set(data.daily.flatMap(m => m.tags))];

      const isMobileView = window.innerWidth <= 768;

      return (
        <div style={{ display: 'flex', height: '100%', flexDirection: isMobileView ? 'column' : 'row' }}>
          {/* ãƒªã‚¹ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§é¸æŠæ¸ˆã¿ã®å ´åˆã¯éè¡¨ç¤ºï¼‰ */}
          {(!isMobileView || !selectedMemo) && (
            <div style={{ width: isMobileView ? '100%' : '300px', borderRight: isMobileView ? 'none' : `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', background: theme.bgSecondary, flex: isMobileView ? 1 : 'none' }}>
              <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <span style={{ fontWeight: '600' }}>ğŸ—’ï¸ æ—¥å¸¸ãƒ¡ãƒ¢</span>
                  <button onClick={addMemo} style={{ padding: '6px 12px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> è¿½åŠ </button>
                </div>
                {/* ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  <button onClick={() => setTagFilter('all')} style={{ padding: '4px 8px', fontSize: '10px', background: tagFilter === 'all' ? theme.accent : theme.bgTertiary, color: tagFilter === 'all' ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>All</button>
                  {usedTags.map(tag => (
                    <button key={tag} onClick={() => setTagFilter(tag)} style={{ padding: '4px 8px', fontSize: '10px', background: tagFilter === tag ? theme.accent : theme.bgTertiary, color: tagFilter === tag ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>{tag}</button>
                  ))}
                </div>
              </div>
              <div style={{ flex: 1, overflow: 'auto', padding: '8px' }}>
                {filteredMemos.map(memo => (
                  <div key={memo.id} onClick={() => setSelectedMemo(memo)} style={{ padding: '12px', marginBottom: '4px', borderRadius: '8px', cursor: 'pointer', background: selectedMemo?.id === memo.id ? theme.highlight : 'transparent', border: `1px solid ${selectedMemo?.id === memo.id ? theme.accent : 'transparent'}` }}>
                    {editingId === memo.id ? (
                      <input type="text" value={memo.title} onChange={(e) => updateMemo(memo.id, 'title', e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} autoFocus style={{ width: '100%', background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '4px 8px', color: theme.text, fontSize: '13px', outline: 'none', boxSizing: 'border-box' }} />
                    ) : (
                      <div onDoubleClick={() => setEditingId(memo.id)} style={{ fontWeight: '500', fontSize: '13px', marginBottom: '4px' }}>{memo.title}</div>
                    )}
                    <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                      {memo.tags.map(tag => (
                        <span key={tag} style={{ fontSize: '10px', padding: '2px 6px', background: theme.bgTertiary, borderRadius: '4px', color: theme.textSecondary }}>{tag}</span>
                      ))}
                    </div>
                  </div>
                ))}
                {filteredMemos.length === 0 && <div style={{ textAlign: 'center', color: theme.textSecondary, padding: '40px 20px', fontSize: '13px' }}>{tagFilter === 'all' ? 'ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“' : `ã€Œ${tagFilter}ã€ã‚¿ã‚°ã®ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“`}<br/>ã€Œ+ è¿½åŠ ã€ã§ä½œæˆã—ã¦ã­</div>}
              </div>
            </div>
          )}

          {/* ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§æœªé¸æŠã®å ´åˆã¯éè¡¨ç¤ºï¼‰ */}
          {(!isMobileView || selectedMemo) && (
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: theme.bg }}>
              {selectedMemo ? (
                <>
                  <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '12px', background: theme.bgSecondary, flexWrap: 'wrap' }}>
                    {isMobileView && (
                      <button onClick={() => setSelectedMemo(null)} style={{ padding: '6px 10px', background: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>â† æˆ»ã‚‹</button>
                    )}
                    {editingId === `title-${selectedMemo.id}` ? (
                      <input type="text" value={selectedMemo.title} onChange={(e) => updateMemo(selectedMemo.id, 'title', e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} autoFocus style={{ flex: 1, fontWeight: '500', fontSize: '15px', background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '4px 8px', color: theme.text, outline: 'none', minWidth: '100px', boxSizing: 'border-box' }} />
                    ) : (
                      <span onDoubleClick={() => setEditingId(`title-${selectedMemo.id}`)} style={{ fontWeight: '500', fontSize: '15px', cursor: 'text', flex: 1 }}>{selectedMemo.title}</span>
                    )}
                    <button onClick={() => deleteMemo(selectedMemo.id)} style={{ padding: '6px 12px', background: theme.error, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>å‰Šé™¤</button>
                  </div>
                  {/* ã‚¿ã‚° */}
                  <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap', background: theme.bgSecondary }}>
                    <Icons.Tag />
                    {selectedMemo.tags.map(tag => (
                      <span key={tag} style={{ fontSize: '11px', padding: '4px 8px', background: theme.accent, color: '#fff', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        {tag}
                        <button onClick={() => removeTagFromMemo(selectedMemo.id, tag)} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex' }}><Icons.X /></button>
                      </span>
                    ))}
                    <select value="" onChange={(e) => { if (e.target.value) addTagToMemo(selectedMemo.id, e.target.value); }} style={{ padding: '4px 8px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, cursor: 'pointer' }}>
                      <option value="">+ ã‚¿ã‚°è¿½åŠ </option>
                      {(data.dailyTags || ['ä»•äº‹', 'è²·ã„ç‰©', 'ã‚¢ã‚¤ãƒ‡ã‚¢', 'æ—¥è¨˜']).filter(t => !selectedMemo.tags.includes(t)).map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                  </div>
                  <textarea value={selectedMemo.content} onChange={(e) => updateMemo(selectedMemo.id, 'content', e.target.value)} placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style={{ flex: 1, padding: '20px 24px', background: 'transparent', border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
                </>
              ) : (
                <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary }}>ãƒ¡ãƒ¢ã‚’é¸æŠã—ã¦ã­</div>
              )}
            </div>
          )}
        </div>
      );
    };

    // ==================== Inputã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ & è‡ªå‹•å®Œäº†ï¼‰ ====================
    const InputSection = ({ data, setData, theme }) => {
      const [selectedInput, setSelectedInput] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [filter, setFilter] = useState('all'); // all, reading, finished
      const [tagFilter, setTagFilter] = useState('all');
      const [showTagSelector, setShowTagSelector] = useState(false);

      const addInput = () => {
        const newInput = {
          id: `input-${Date.now()}`,
          title: 'æ–°ã—ã„ä½œå“',
          tags: [],
          startDate: '',
          finishDate: '',
          content: '',
          status: 'reading', // reading | finished
          createdAt: new Date().toISOString()
        };
        setData({ ...data, input: [newInput, ...data.input] });
        setSelectedInput(newInput);
      };

      const updateInput = (id, field, value) => {
        let updates = { [field]: value };
        
        // Finishæ—¥ä»˜ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«å®Œäº†ã«
        if (field === 'finishDate' && value) {
          updates.status = 'finished';
        }
        
        const newInput = data.input.map(i => i.id === id ? { ...i, ...updates } : i);
        setData({ ...data, input: newInput });
        if (selectedInput?.id === id) setSelectedInput({ ...selectedInput, ...updates });
      };

      const deleteInput = (id) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setData({ ...data, input: data.input.filter(i => i.id !== id) });
          if (selectedInput?.id === id) setSelectedInput(null);
        }
      };

      const addTagToInput = (inputId, tag) => {
        const input = data.input.find(i => i.id === inputId);
        if (input && !input.tags.includes(tag)) {
          updateInput(inputId, 'tags', [...input.tags, tag]);
        }
      };

      const removeTagFromInput = (inputId, tag) => {
        const input = data.input.find(i => i.id === inputId);
        if (input) {
          updateInput(inputId, 'tags', input.tags.filter(t => t !== tag));
        }
      };

      const filteredInputs = data.input.filter(i => {
        if (filter === 'reading' && i.status !== 'reading') return false;
        if (filter === 'finished' && i.status !== 'finished') return false;
        if (tagFilter !== 'all' && !i.tags.includes(tagFilter)) return false;
        return true;
      });

      // inputTagsãŒãªã„å ´åˆã®åˆæœŸåŒ–
      const inputTags = data.inputTags || ['å°èª¬', 'æ¼«ç”»', 'Audible', 'æ˜ ç”»', 'ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'YouTube'];

      const isMobileView = window.innerWidth <= 768;

      return (
        <div style={{ display: 'flex', height: '100%', flexDirection: isMobileView ? 'column' : 'row' }} onClick={() => setShowTagSelector(false)}>
          {/* ãƒªã‚¹ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§é¸æŠæ¸ˆã¿ã®å ´åˆã¯éè¡¨ç¤ºï¼‰ */}
          {(!isMobileView || !selectedInput) && (
            <div style={{ width: isMobileView ? '100%' : '320px', borderRight: isMobileView ? 'none' : `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', background: theme.bgSecondary, flex: isMobileView ? 1 : 'none' }}>
              <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <span style={{ fontWeight: '600' }}>ğŸ“– Input</span>
                  <button onClick={addInput} style={{ padding: '6px 12px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> è¿½åŠ </button>
                </div>
                {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                <div style={{ display: 'flex', gap: '4px', marginBottom: '8px' }}>
                  {['all', 'reading', 'finished'].map(f => (
                    <button key={f} onClick={() => setFilter(f)} style={{ flex: 1, padding: '6px', fontSize: '11px', background: filter === f ? theme.accent : theme.bgTertiary, color: filter === f ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      {f === 'all' ? 'ã™ã¹ã¦' : f === 'reading' ? 'é€²è¡Œä¸­' : 'å®Œäº†'}
                    </button>
                  ))}
                </div>
                {/* ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  <button onClick={() => setTagFilter('all')} style={{ padding: '4px 8px', fontSize: '10px', background: tagFilter === 'all' ? theme.accent : theme.bgTertiary, color: tagFilter === 'all' ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>All</button>
                  {inputTags.map(tag => (
                    <button key={tag} onClick={() => setTagFilter(tag)} style={{ padding: '4px 8px', fontSize: '10px', background: tagFilter === tag ? theme.accent : theme.bgTertiary, color: tagFilter === tag ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>{tag}</button>
                  ))}
                </div>
              </div>
              <div style={{ flex: 1, overflow: 'auto', padding: '8px' }}>
                {filteredInputs.map(input => (
                  <div key={input.id} onClick={() => setSelectedInput(input)} style={{ padding: '12px', marginBottom: '4px', borderRadius: '8px', cursor: 'pointer', background: selectedInput?.id === input.id ? theme.highlight : 'transparent', border: `1px solid ${selectedInput?.id === input.id ? theme.accent : 'transparent'}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                      {editingId === input.id ? (
                        <input type="text" value={input.title} onChange={(e) => updateInput(input.id, 'title', e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} autoFocus onClick={(e) => e.stopPropagation()} style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '2px 6px', color: theme.text, fontSize: '13px', outline: 'none', boxSizing: 'border-box' }} />
                      ) : (
                        <span onDoubleClick={(e) => { e.stopPropagation(); setEditingId(input.id); }} style={{ flex: 1, fontWeight: '500', fontSize: '13px' }}>{input.title}</span>
                      )}
                      <span style={{ fontSize: '10px', padding: '2px 6px', background: input.status === 'finished' ? theme.success : theme.warning, color: '#fff', borderRadius: '4px' }}>
                        {input.status === 'finished' ? 'å®Œäº†' : 'é€²è¡Œä¸­'}
                      </span>
                    </div>
                    {/* ã‚¿ã‚°è¡¨ç¤º */}
                    <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginBottom: '4px' }}>
                      {input.tags.map(tag => (
                        <span key={tag} style={{ fontSize: '10px', padding: '2px 6px', background: theme.bgTertiary, borderRadius: '4px', color: theme.textSecondary }}>{tag}</span>
                      ))}
                    </div>
                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                      {input.startDate && `START: ${input.startDate}`}
                      {input.finishDate && ` â†’ FINISH: ${input.finishDate}`}
                    </div>
                  </div>
                ))}
                {filteredInputs.length === 0 && <div style={{ textAlign: 'center', color: theme.textSecondary, padding: '40px 20px', fontSize: '13px' }}>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>}
              </div>
            </div>
          )}

          {/* ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§æœªé¸æŠã®å ´åˆã¯éè¡¨ç¤ºï¼‰ */}
          {(!isMobileView || selectedInput) && (
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: theme.bg }}>
              {selectedInput ? (
                <>
                  <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '12px', background: theme.bgSecondary, flexWrap: 'wrap' }}>
                    {isMobileView && (
                      <button onClick={() => setSelectedInput(null)} style={{ padding: '6px 10px', background: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>â† æˆ»ã‚‹</button>
                    )}
                    {editingId === `title-${selectedInput.id}` ? (
                      <input type="text" value={selectedInput.title} onChange={(e) => updateInput(selectedInput.id, 'title', e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} autoFocus style={{ flex: 1, fontWeight: '500', fontSize: '15px', background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '4px 8px', color: theme.text, outline: 'none', minWidth: '100px', boxSizing: 'border-box' }} />
                    ) : (
                      <span onDoubleClick={() => setEditingId(`title-${selectedInput.id}`)} style={{ fontWeight: '500', fontSize: '15px', cursor: 'text', flex: 1 }}>{selectedInput.title}</span>
                    )}
                    <select value={selectedInput.status} onChange={(e) => updateInput(selectedInput.id, 'status', e.target.value)} style={{ padding: '6px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '12px' }}>
                      <option value="reading">é€²è¡Œä¸­</option>
                      <option value="finished">å®Œäº†</option>
                    </select>
                    <button onClick={() => deleteInput(selectedInput.id)} style={{ padding: '6px 12px', background: theme.error, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>å‰Šé™¤</button>
                  </div>
                  {/* ã‚¿ã‚° */}
                  <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap', background: theme.bgSecondary }}>
                    <Icons.Tag />
                    {selectedInput.tags.map(tag => (
                      <span key={tag} style={{ fontSize: '11px', padding: '4px 8px', background: theme.accent, color: '#fff', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        {tag}
                        <button onClick={() => removeTagFromInput(selectedInput.id, tag)} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex' }}><Icons.X /></button>
                      </span>
                    ))}
                    <div style={{ position: 'relative' }} onClick={(e) => e.stopPropagation()}>
                      <button onClick={() => setShowTagSelector(!showTagSelector)} style={{ fontSize: '11px', padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px dashed ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>+ ã‚¿ã‚°è¿½åŠ </button>
                      {showTagSelector && (
                        <div style={{ position: 'absolute', top: '100%', left: 0, background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '6px', padding: '8px', zIndex: 100, minWidth: '120px', boxShadow: '0 4px 12px rgba(0,0,0,0.2)' }}>
                          {inputTags.filter(t => !selectedInput.tags.includes(t)).map(tag => (
                            <div key={tag} onClick={() => { addTagToInput(selectedInput.id, tag); setShowTagSelector(false); }} style={{ padding: '4px 8px', fontSize: '11px', cursor: 'pointer', borderRadius: '4px', color: theme.text }} onMouseOver={(e) => e.target.style.background = theme.bgTertiary} onMouseOut={(e) => e.target.style.background = 'transparent'}>{tag}</div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                  {/* æ—¥ä»˜ */}
                  <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: isMobileView ? '12px' : '24px', background: theme.bgSecondary, flexWrap: 'wrap' }}>
                    <div>
                      <label style={{ fontSize: '11px', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>START</label>
                      <input type="date" value={selectedInput.startDate} onChange={(e) => updateInput(selectedInput.id, 'startDate', e.target.value)} style={{ padding: '8px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px' }} />
                    </div>
                    <div>
                      <label style={{ fontSize: '11px', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>FINISH <span style={{ fontSize: '9px', color: theme.accent }}>ï¼ˆå…¥åŠ›ã§è‡ªå‹•å®Œäº†ï¼‰</span></label>
                      <input type="date" value={selectedInput.finishDate} onChange={(e) => updateInput(selectedInput.id, 'finishDate', e.target.value)} style={{ padding: '8px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px' }} />
                    </div>
                  </div>
                  <textarea value={selectedInput.content} onChange={(e) => updateInput(selectedInput.id, 'content', e.target.value)} placeholder="æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style={{ flex: 1, padding: '20px 24px', background: 'transparent', border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
                </>
              ) : (
                <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary }}>è¨˜éŒ²ã‚’é¸æŠã—ã¦ã­</div>
              )}
            </div>
          )}
        </div>
      );
    };

    // ==================== å‰µä½œã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ & ãƒã‚¿å¸³çµ±åˆï¼‰ ====================
    const CreativeSection = ({ data, setData, selectedItem, setSelectedItem, openInNewPane, theme, sidebarWidth, activeTab, setActiveTab }) => {
      const { creative } = data;
      const [editingItemId, setEditingItemId] = useState(null);
      const [editingProjectId, setEditingProjectId] = useState(null);
      const [draggedProject, setDraggedProject] = useState(null);
      const [dragOverStatus, setDragOverStatus] = useState(null);
      const [collapsedSections, setCollapsedSections] = useState(data.collapsedSections || { completed: true, onHold: true });
      const [showTagSelector, setShowTagSelector] = useState(null);
      const [tagFilter, setTagFilter] = useState('all');
      const [editingIdeaId, setEditingIdeaId] = useState(null);
      const [stickyColorFilter, setStickyColorFilter] = useState('all');
      const [collapsedStickies, setCollapsedStickies] = useState({});
      const [projectStickyFilter, setProjectStickyFilter] = useState({}); // ä½œå“åˆ¥ä»˜ç®‹ã®è‰²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const [ideaStatusFilter, setIdeaStatusFilter] = useState('all'); // ãƒã‚¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä¸€æ‹¬å‰Šé™¤ç”¨
      const [checkboxMode, setCheckboxMode] = useState(false);
      const [selectedStickies, setSelectedStickies] = useState([]);
      const [selectedIdeas, setSelectedIdeas] = useState([]);
      const [selectedItems, setSelectedItems] = useState({}); // ä½œå“åˆ¥: { projectId: [itemIds] }

      const ideas = creative.ideas || [];
      const stickies = creative.stickies || [];
      
      // textareaã®é«˜ã•è‡ªå‹•èª¿æ•´
      const autoResize = (textarea) => {
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = Math.max(60, textarea.scrollHeight) + 'px';
        }
      };
      
      // åŸç¨¿é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚·ãƒ¼ãƒ³é€£å‹•ï¼‰
      const progressLabels = { none: '', draft_done: 'ãƒ‰ãƒ©ãƒ•ãƒˆå®Œ', completed: 'åŸç¨¿å®Œäº†' };
      const progressColors = { none: '#9e9e9e', draft_done: '#2196f3', completed: '#4caf50' };
      const progressIcons = { none: 'â—‹', draft_done: 'â—', completed: 'â—' };

      const countChars = (project) => project.items.filter(i => i.type === 'chapter').reduce((sum, i) => sum + (i.content || '').replace(/[\s\n]/g, '').length, 0);
      const totalChars = () => [...creative.inProgress, ...creative.completed, ...creative.onHold].reduce((sum, p) => sum + countChars(p), 0);

      // ä½¿ç”¨ä¸­ã®ã‚¿ã‚°ã‚’åé›†
      const usedTags = [...new Set([
        ...creative.inProgress.flatMap(p => p.tags || []),
        ...creative.completed.flatMap(p => p.tags || []),
        ...creative.onHold.flatMap(p => p.tags || []),
        ...ideas.flatMap(i => i.tags || [])
      ])];

      const addProject = (status) => {
        const newProject = { id: `project-${Date.now()}`, name: 'æ–°è¦ä½œå“', tags: [], expanded: true, targetCount: 0, collapsedSections: {}, stickies: [], items: [
          { id: `item-${Date.now()}-1`, type: 'chapter', name: '1è©±', content: '', sectionId: null },
          { id: `item-${Date.now()}-2`, type: 'memo', name: 'ãƒ—ãƒ­ãƒƒãƒˆ', content: '' },
        ]};
        setData({...data, creative: {...creative, [status]: [...creative[status], newProject]}});
      };

      const addItem = (projectId, status, type, sectionId = null) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => {
          if (p.id === projectId) {
            if (type === 'section') {
              // æ—¢å­˜ã®ç« ã‹ã‚‰ã€Œâ—‹ç« ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ€å¤§ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
              const chapterPattern = /^(\d+)ç« $/;
              let maxNum = 0;
              p.items.filter(i => i.type === 'section').forEach(s => {
                const match = s.name.match(chapterPattern);
                if (match) {
                  maxNum = Math.max(maxNum, parseInt(match[1], 10));
                }
              });
              return {...p, items: [...p.items, { id: `section-${Date.now()}`, type: 'section', name: `${maxNum + 1}ç« `, expanded: true }]};
            }
            // è©±ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼šç« ã”ã¨ã«ã‚«ã‚¦ãƒ³ãƒˆ
            if (type === 'chapter') {
              let count;
              if (sectionId) {
                // ç« å†…ã®è©±æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                count = p.items.filter(i => i.type === 'chapter' && i.sectionId === sectionId).length;
              } else {
                // ç« ã«å±ã•ãªã„è©±æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                count = p.items.filter(i => i.type === 'chapter' && !i.sectionId).length;
              }
              const newItem = { id: `item-${Date.now()}`, type: 'chapter', name: `${count + 1}è©±`, content: '', sectionId, progress: 'not_started' };
              return {...p, items: [...p.items, newItem]};
            }
            // ãƒ¡ãƒ¢ã®å ´åˆ
            const memoCount = p.items.filter(i => i.type === 'memo').length;
            const newItem = { id: `item-${Date.now()}`, type, name: `ãƒ¡ãƒ¢${memoCount > 0 ? memoCount + 1 : ''}`, content: '' };
            return {...p, items: [...p.items, newItem]};
          }
          return p;
        })}});
      };

      // ç« ã®æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
      const toggleChapterSection = (projectId, sectionId, status) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => {
          if (p.id === projectId) {
            return {...p, items: p.items.map(i => i.id === sectionId ? {...i, expanded: !i.expanded} : i)};
          }
          return p;
        })}});
      };

      // è©±ã‚’ç« ã«ç§»å‹•ï¼ˆç§»å‹•å¾Œã«è©±æ•°ã‚’æŒ¯ã‚Šç›´ã—ï¼‰
      const moveItemToSection = (projectId, itemId, newSectionId, status) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => {
          if (p.id === projectId) {
            // ã¾ãšç§»å‹•
            let items = p.items.map(i => i.id === itemId ? {...i, sectionId: newSectionId} : i);
            
            // è©±æ•°ã®è‡ªå‹•æŒ¯ã‚Šç›´ã—ï¼ˆç« ã”ã¨ã«ç‹¬ç«‹ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰
            const renumberPattern = /^(\d+)è©±$/;
            let noSectionNum = 1;
            const sectionCounters = {};
            items.filter(i => i.type === 'section').forEach(s => { sectionCounters[s.id] = 1; });
            
            items = items.map(item => {
              if (item.type === 'chapter' && renumberPattern.test(item.name)) {
                if (item.sectionId) {
                  return { ...item, name: `${sectionCounters[item.sectionId]++}è©±` };
                } else {
                  return { ...item, name: `${noSectionNum++}è©±` };
                }
              }
              return item;
            });
            
            return {...p, items};
          }
          return p;
        })}});
      };

      // ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸¦ã¹æ›¿ãˆ
      const reorderItems = (projectId, status, draggedId, targetId, position) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => {
          if (p.id === projectId) {
            const items = [...p.items];
            const draggedIdx = items.findIndex(i => i.id === draggedId);
            const targetIdx = items.findIndex(i => i.id === targetId);
            if (draggedIdx === -1 || targetIdx === -1) return p;
            const [dragged] = items.splice(draggedIdx, 1);
            const insertIdx = position === 'before' ? targetIdx : targetIdx + 1;
            items.splice(draggedIdx < targetIdx ? insertIdx - 1 : insertIdx, 0, dragged);
            
            // è©±æ•°ã®è‡ªå‹•æŒ¯ã‚Šç›´ã—ï¼ˆç« ã”ã¨ã«ç‹¬ç«‹ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰
            const renumberPattern = /^(\d+)è©±$/;
            
            // ç« ã«å±ã•ãªã„è©±ã‚’æŒ¯ã‚Šç›´ã—
            let noSectionNum = 1;
            // å„ç« ã”ã¨ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ç”¨æ„
            const sectionCounters = {};
            items.filter(i => i.type === 'section').forEach(s => { sectionCounters[s.id] = 1; });
            
            const renumberedItems = items.map(item => {
              if (item.type === 'chapter' && renumberPattern.test(item.name)) {
                if (item.sectionId) {
                  // ç« ã«å±ã™ã‚‹è©±
                  return { ...item, name: `${sectionCounters[item.sectionId]++}è©±` };
                } else {
                  // ç« ã«å±ã•ãªã„è©±
                  return { ...item, name: `${noSectionNum++}è©±` };
                }
              }
              return item;
            });
            
            return {...p, items: renumberedItems};
          }
          return p;
        })}});
      };
      
      // ç« åŒå£«ã®ä¸¦ã¹æ›¿ãˆ
      const reorderSections = (projectId, status, draggedSectionId, targetSectionId, position) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => {
          if (p.id === projectId) {
            const items = [...p.items];
            const sections = items.filter(i => i.type === 'section');
            const nonSections = items.filter(i => i.type !== 'section');
            
            const draggedIdx = sections.findIndex(s => s.id === draggedSectionId);
            const targetIdx = sections.findIndex(s => s.id === targetSectionId);
            if (draggedIdx === -1 || targetIdx === -1) return p;
            
            const [dragged] = sections.splice(draggedIdx, 1);
            const insertIdx = position === 'before' ? targetIdx : targetIdx + 1;
            sections.splice(draggedIdx < targetIdx ? insertIdx - 1 : insertIdx, 0, dragged);
            
            // ç« ç•ªå·ã®æŒ¯ã‚Šç›´ã—ï¼ˆã€Œâ—‹ç« ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ï¼‰
            const renumberPattern = /^(\d+)ç« $/;
            const renumberedSections = sections.map((section, idx) => {
              if (renumberPattern.test(section.name)) {
                return { ...section, name: `${idx + 1}ç« ` };
              }
              return section;
            });
            
            // éç« ã‚¢ã‚¤ãƒ†ãƒ  + ç« ã®é †ã§çµåˆ
            return {...p, items: [...nonSections, ...renumberedSections]};
          }
          return p;
        })}});
      };

      const toggleProject = (projectId, status) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => p.id === projectId ? {...p, expanded: !p.expanded} : p)}});
      };

      const renameItem = (projectId, itemId, status, newName) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => p.id === projectId ? {...p, items: p.items.map(i => i.id === itemId ? {...i, name: newName} : i)} : p)}});
        if (selectedItem?.id === itemId) setSelectedItem({...selectedItem, name: newName});
      };

      // åŸç¨¿ã®é€²æ—ã‚’æ›´æ–°
      const updateItemProgress = (projectId, itemId, status, newProgress) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => p.id === projectId ? {...p, items: p.items.map(i => i.id === itemId ? {...i, progress: newProgress} : i)} : p)}});
        if (selectedItem?.id === itemId) setSelectedItem({...selectedItem, progress: newProgress});
      };

      const deleteItem = (projectId, itemId, status) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setData({...data, creative: {...creative, [status]: creative[status].map(p => {
            if (p.id === projectId) {
              const deletedItem = p.items.find(i => i.id === itemId);
              let newItems = p.items.filter(i => i.id !== itemId);
              // ç« ã‚’å‰Šé™¤ã—ãŸå ´åˆã€ãã®ç« ã«å±ã—ã¦ã„ãŸè©±ã®sectionIdã‚’nullã«ã™ã‚‹
              if (deletedItem && deletedItem.type === 'section') {
                newItems = newItems.map(i => i.sectionId === itemId ? {...i, sectionId: null} : i);
              }
              return {...p, items: newItems};
            }
            return p;
          })}});
          if (selectedItem?.id === itemId) setSelectedItem(null);
        }
      };

      const renameProject = (projectId, status, newName) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => p.id === projectId ? {...p, name: newName} : p)}});
      };

      // ã‚¿ã‚°é–¢é€£
      const addTagToProject = (projectId, status, tag) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => 
          p.id === projectId && !p.tags.includes(tag) ? {...p, tags: [...p.tags, tag]} : p
        )}});
      };

      const removeTagFromProject = (projectId, status, tag) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => 
          p.id === projectId ? {...p, tags: p.tags.filter(t => t !== tag)} : p
        )}});
      };

      // ç›®æ¨™æ–‡å­—æ•°æ›´æ–°
      const updateProjectTarget = (projectId, status, targetCount) => {
        setData({...data, creative: {...creative, [status]: creative[status].map(p => 
          p.id === projectId ? {...p, targetCount} : p
        )}});
      };

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
      const handleProjectDragStart = (e, project, fromStatus) => {
        setDraggedProject({ project, fromStatus });
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleStatusDragOver = (e, status) => {
        e.preventDefault();
        setDragOverStatus(status);
      };

      const handleStatusDrop = (e, toStatus) => {
        e.preventDefault();
        if (draggedProject && draggedProject.fromStatus !== toStatus) {
          const { project, fromStatus } = draggedProject;
          setData({
            ...data,
            creative: {
              ...creative,
              [fromStatus]: creative[fromStatus].filter(p => p.id !== project.id),
              [toStatus]: [...creative[toStatus], project]
            }
          });
        }
        setDraggedProject(null);
        setDragOverStatus(null);
      };

      const handleDragEnd = () => {
        setDraggedProject(null);
        setDragOverStatus(null);
      };

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚ŠãŸãŸã¿
      const toggleSection = (section) => {
        const newCollapsed = { ...collapsedSections, [section]: !collapsedSections[section] };
        setCollapsedSections(newCollapsed);
        setData({ ...data, collapsedSections: newCollapsed });
      };

      // ãƒã‚¿é–¢é€£
      const addIdea = () => {
        const newIdea = { id: `idea-${Date.now()}`, title: 'æ–°ã—ã„ãƒã‚¿', content: '', tags: [], status: 'unused', createdAt: new Date().toISOString() };
        setData({ ...data, creative: { ...creative, ideas: [newIdea, ...ideas] } });
        setSelectedItem({ ...newIdea, isIdea: true });
      };

      const updateIdea = (id, field, value) => {
        const newIdeas = ideas.map(i => i.id === id ? { ...i, [field]: value } : i);
        setData({ ...data, creative: { ...creative, ideas: newIdeas } });
        if (selectedItem?.id === id) setSelectedItem({ ...selectedItem, [field]: value });
      };

      const deleteIdea = (id) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setData({ ...data, creative: { ...creative, ideas: ideas.filter(i => i.id !== id) } });
          if (selectedItem?.id === id) setSelectedItem(null);
        }
      };

      // ãƒã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆã«å¤‰æ›
      const convertIdeaToProject = (idea) => {
        const newProject = {
          id: `project-${Date.now()}`,
          name: idea.title,
          tags: idea.tags || [],
          expanded: true,
          targetCount: 0,
          items: [
            { id: `item-${Date.now()}-1`, type: 'chapter', name: '1è©±', content: '' },
            { id: `item-${Date.now()}-2`, type: 'memo', name: 'ãƒ—ãƒ­ãƒƒãƒˆ', content: idea.content || '' },
          ]
        };
        // ãƒã‚¿ã‚’ä½¿ç”¨æ¸ˆã¿ã«å¤‰æ›´ã—ã€ä½œå“ã‚’è¿½åŠ 
        const newIdeas = ideas.map(i => i.id === idea.id ? { ...i, status: 'used' } : i);
        setData({
          ...data,
          creative: {
            ...creative,
            inProgress: [...creative.inProgress, newProject],
            ideas: newIdeas
          }
        });
        setActiveTab('works');
      };

      // ä½œå“å‰Šé™¤
      const deleteProject = (projectId, status) => {
        if (confirm('ä½œå“å…¨ä½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè©±ãƒ»ãƒ¡ãƒ¢ã‚‚ã™ã¹ã¦æ¶ˆãˆã¾ã™ï¼‰')) {
          setData({...data, creative: {...creative, [status]: creative[status].filter(p => p.id !== projectId)}});
        }
      };

      // ä½œå“ã‚’TXTã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const downloadProjectAsTxt = (project) => {
        let txtContent = '';
        txtContent += 'â•'.repeat(50) + '\n';
        txtContent += `ã€${project.name}ã€‘\n`;
        txtContent += 'â•'.repeat(50) + '\n\n';
        const chapters = project.items.filter(i => i.type === 'chapter');
        chapters.forEach(chapter => {
          txtContent += `â”€â”€ ${chapter.name} â”€â”€\n\n`;
          txtContent += (chapter.content || '') + '\n\n';
        });
        const blob = new Blob([txtContent], { type: 'text/plain; charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${project.name}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // è©±ã‚’ä¿ç•™ã«ç§»å‹•
      const moveItemToHold = (projectId, item, status) => {
        const project = creative[status].find(p => p.id === projectId);
        const holdItem = {
          ...item,
          id: `hold-${Date.now()}`,
          originalProjectId: projectId,
          originalProjectName: project?.name || 'ä¸æ˜',
          originalStatus: status,
          movedAt: new Date().toISOString()
        };
        const holdItems = creative.holdItems || [];
        setData({
          ...data,
          creative: {
            ...creative,
            [status]: creative[status].map(p => p.id === projectId ? {...p, items: p.items.filter(i => i.id !== item.id)} : p),
            holdItems: [...holdItems, holdItem]
          }
        });
      };

      // ä¿ç•™ã‹ã‚‰è©±ã‚’æˆ»ã™
      const moveItemFromHold = (holdItem) => {
        const { originalProjectId, originalStatus } = holdItem;
        const holdItems = creative.holdItems || [];
        
        // å…ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const originalProject = creative[originalStatus]?.find(p => p.id === originalProjectId);
        
        if (originalProject) {
          // å…ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™
          const restoredItem = { id: holdItem.id, type: holdItem.type, name: holdItem.name, content: holdItem.content };
          setData({
            ...data,
            creative: {
              ...creative,
              [originalStatus]: creative[originalStatus].map(p => 
                p.id === originalProjectId ? {...p, items: [...p.items, restoredItem]} : p
              ),
              holdItems: holdItems.filter(i => i.id !== holdItem.id)
            }
          });
        } else {
          alert('å…ƒã®ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\næ–°ã—ã„ä½œå“ã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        }
      };

      // ä¿ç•™ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
      const deleteHoldItem = (itemId) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          const holdItems = creative.holdItems || [];
          setData({...data, creative: {...creative, holdItems: holdItems.filter(i => i.id !== itemId)}});
        }
      };

      // ä¿ç•™ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
      const renameHoldItem = (itemId, newName) => {
        const holdItems = creative.holdItems || [];
        setData({...data, creative: {...creative, holdItems: holdItems.map(i => i.id === itemId ? {...i, name: newName} : i)}});
      };

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      const filterByTag = (projects) => {
        if (tagFilter === 'all') return projects;
        return projects.filter(p => (p.tags || []).includes(tagFilter));
      };

      const filteredIdeas = ideas.filter(i => {
        const matchTag = tagFilter === 'all' || (i.tags || []).includes(tagFilter);
        const matchStatus = ideaStatusFilter === 'all' || i.status === ideaStatusFilter;
        return matchTag && matchStatus;
      });

      const renderList = (projects, status, title, icon, collapsible = false) => {
        const filteredProjects = filterByTag(projects);
        const isCollapsed = collapsible && collapsedSections[status];
        
        return (
          <div 
            style={{ marginBottom: '16px' }}
            onDragOver={(e) => handleStatusDragOver(e, status)}
            onDrop={(e) => handleStatusDrop(e, status)}
          >
            <div 
              onClick={() => collapsible && toggleSection(status)}
              style={{ 
                display: 'flex', alignItems: 'center', justifyContent: 'space-between', 
                padding: '8px 12px', color: theme.textSecondary, fontSize: '11px', 
                textTransform: 'uppercase', letterSpacing: '0.5px', 
                background: dragOverStatus === status ? theme.highlight : 'transparent', 
                borderRadius: '6px', transition: 'background 0.2s',
                cursor: collapsible ? 'pointer' : 'default'
              }}
            >
              <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                {collapsible && (
                  <span style={{ transform: isCollapsed ? 'rotate(0deg)' : 'rotate(90deg)', transition: 'transform 0.2s', display: 'flex' }}>
                    <Icons.ChevronRight />
                  </span>
                )}
                {icon} {title} ({filteredProjects.length})
              </span>
              <button onClick={(e) => { e.stopPropagation(); addProject(status); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px' }}><Icons.Plus /></button>
            </div>
            
            {!isCollapsed && filteredProjects.map(p => (
              <div 
                key={p.id}
                draggable
                onDragStart={(e) => handleProjectDragStart(e, p, status)}
                onDragEnd={handleDragEnd}
              >
                <div style={{ display: 'flex', alignItems: 'center', padding: '8px 12px', margin: '0 8px', borderRadius: '6px', gap: '6px', background: p.expanded ? theme.bgTertiary : 'transparent', cursor: 'grab' }}>
                  <Icons.GripVertical />
                  <span onClick={() => toggleProject(p.id, status)} style={{ cursor: 'pointer', display: 'flex' }}>{p.expanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</span>
                  <Icons.Folder />
                  {editingProjectId === p.id ? (
                    <input type="text" value={p.name} onChange={(e) => renameProject(p.id, status, e.target.value)} onBlur={() => setEditingProjectId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingProjectId(null)} autoFocus style={{ flex: 1, fontSize: '13px', fontWeight: '500', background: theme.bg, border: `1px solid ${theme.accent}`, outline: 'none', color: theme.text, padding: '2px 6px', borderRadius: '4px' }} />
                  ) : (
                    <span onDoubleClick={() => setEditingProjectId(p.id)} style={{ flex: 1, fontSize: '13px', fontWeight: '500', cursor: 'default' }}>{p.name}</span>
                  )}
                  <span style={{ fontSize: '11px', color: theme.accent }}>{countChars(p).toLocaleString()}å­—</span>
                  {checkboxMode && selectedItems[p.id]?.length > 0 && (
                    <button onClick={(e) => {
                      e.stopPropagation();
                      if (confirm(`${selectedItems[p.id].length}å€‹ã®è©±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        setData({
                          ...data,
                          creative: {
                            ...creative,
                            [status]: creative[status].map(proj =>
                              proj.id === p.id
                                ? { ...proj, items: proj.items.filter(i => !selectedItems[p.id].includes(i.id)) }
                                : proj
                            )
                          }
                        });
                        setSelectedItems(prev => ({ ...prev, [p.id]: [] }));
                      }
                    }} style={{ padding: '2px 8px', fontSize: '9px', background: theme.error, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      ğŸ—‘ï¸ å‰Šé™¤ ({selectedItems[p.id].length})
                    </button>
                  )}
                  <button onClick={(e) => { 
                    e.stopPropagation(); 
                    setCheckboxMode(!checkboxMode);
                    if (checkboxMode) {
                      setSelectedItems(prev => ({ ...prev, [p.id]: [] }));
                    }
                  }} style={{ background: 'none', border: 'none', color: checkboxMode ? theme.accent : theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.8 }} title={checkboxMode ? "é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†" : "è©±ã‚’é¸æŠ"}>
                    {checkboxMode ? 'âœ“' : 'â˜‘ï¸'}
                  </button>
                  <button onClick={(e) => { e.stopPropagation(); downloadProjectAsTxt(p); }} style={{ background: 'none', border: 'none', color: theme.success, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="TXTãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"><Icons.Download /></button>
                  <button onClick={(e) => { e.stopPropagation(); deleteProject(p.id, status); }} style={{ background: 'none', border: 'none', color: theme.error, cursor: 'pointer', padding: '2px', opacity: 0.5 }} title="ä½œå“ã‚’å‰Šé™¤"><Icons.Trash /></button>
                </div>
                
                {/* ã‚¿ã‚° & ç›®æ¨™æ–‡å­—æ•° */}
                {p.expanded && (
                  <div style={{ padding: '4px 12px 6px 48px' }} onClick={(e) => e.stopPropagation()}>
                    {/* 1è¡Œç›®: ã‚¿ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ & ç›®æ¨™æ–‡å­—æ•° */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', flexWrap: 'wrap' }}>
                      <div style={{ position: 'relative' }}>
                        <button onClick={(e) => { e.stopPropagation(); setShowTagSelector(showTagSelector === p.id ? null : p.id); }} style={{ fontSize: '9px', padding: '2px 5px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px dashed ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }}>+ã‚¿ã‚°</button>
                        {showTagSelector === p.id && (
                          <div onClick={(e) => e.stopPropagation()} style={{ position: 'absolute', top: '100%', left: 0, background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '6px', padding: '8px', zIndex: 100, minWidth: '120px', boxShadow: '0 4px 12px rgba(0,0,0,0.2)' }}>
                            {(data.tags || []).filter(t => !(p.tags || []).includes(t)).map(tag => (
                              <div key={tag} onClick={(e) => { e.stopPropagation(); addTagToProject(p.id, status, tag); setShowTagSelector(null); }} style={{ padding: '4px 8px', fontSize: '11px', cursor: 'pointer', borderRadius: '4px', color: theme.text }} onMouseOver={(e) => e.target.style.background = theme.bgTertiary} onMouseOut={(e) => e.target.style.background = 'transparent'}>{tag}</div>
                            ))}
                            {(data.tags || []).filter(t => !(p.tags || []).includes(t)).length === 0 && (
                              <div style={{ padding: '4px 8px', fontSize: '11px', color: theme.textSecondary }}>{(data.tags || []).length === 0 ? 'âš™ï¸è¨­å®šã§ã‚¿ã‚°è¿½åŠ ' : 'å…¨ã‚¿ã‚°ä»˜ä¸æ¸ˆ'}</div>
                            )}
                          </div>
                        )}
                      </div>
                      
                      {/* åŒºåˆ‡ã‚Š */}
                      <span style={{ color: theme.border, margin: '0 2px' }}>|</span>
                      
                      {/* ç›®æ¨™æ–‡å­—æ•° */}
                      <span style={{ fontSize: '9px', color: theme.textSecondary }}>ç›®æ¨™:</span>
                      <input 
                        type="number" 
                        value={p.targetCount || ''} 
                        onChange={(e) => updateProjectTarget(p.id, status, parseInt(e.target.value) || 0)}
                        placeholder="0"
                        style={{ width: '50px', padding: '1px 3px', fontSize: '9px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '3px', color: theme.text, textAlign: 'right' }}
                      />
                      <span style={{ fontSize: '9px', color: theme.textSecondary }}>å­—</span>
                      {p.targetCount > 0 && (
                        <>
                          <div style={{ flex: 1, minWidth: '40px', maxWidth: '80px', height: '5px', background: theme.bgTertiary, borderRadius: '3px', overflow: 'hidden' }}>
                            <div style={{ width: `${Math.min(100, (countChars(p) / p.targetCount) * 100)}%`, height: '100%', background: countChars(p) >= p.targetCount ? theme.success : theme.accent, transition: 'width 0.3s' }} />
                          </div>
                          <span style={{ fontSize: '9px', color: countChars(p) >= p.targetCount ? theme.success : theme.textSecondary, fontWeight: '500' }}>
                            {Math.round((countChars(p) / p.targetCount) * 100)}%
                          </span>
                        </>
                      )}
                    </div>
                    
                    {/* 2è¡Œç›®: è¿½åŠ ã•ã‚ŒãŸã‚¿ã‚° */}
                    {(p.tags || []).length > 0 && (
                      <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginTop: '4px' }}>
                        {(p.tags || []).map(tag => (
                          <span key={tag} style={{ fontSize: '9px', padding: '2px 5px', background: theme.accent, color: '#fff', borderRadius: '3px', display: 'flex', alignItems: 'center', gap: '2px' }}>
                            {tag}
                            <button onClick={(e) => { e.stopPropagation(); removeTagFromProject(p.id, status, tag); }} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex', fontSize: '9px' }}>Ã—</button>
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {p.expanded && (
                  <div style={{ marginLeft: '16px' }}>
                    {/* ç« ã«å±ã•ãªã„è©±ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ï¼‰ */}
                    {p.items.some(i => i.type === 'section') && (
                      <div 
                        onDragOver={(e) => { e.preventDefault(); e.currentTarget.style.background = theme.highlight; }}
                        onDragLeave={(e) => { e.currentTarget.style.background = 'transparent'; }}
                        onDrop={(e) => { e.preventDefault(); e.currentTarget.style.background = 'transparent'; const draggedId = e.dataTransfer.getData('itemId'); const draggedItem = p.items.find(i => i.id === draggedId); if (draggedItem && draggedItem.type === 'chapter') moveItemToSection(p.id, draggedId, null, status); }}
                        style={{ padding: '4px 10px', margin: '0 6px 2px', fontSize: '10px', color: theme.textSecondary, borderRadius: '4px', border: `1px dashed ${theme.border}` }}
                      >
                        ğŸ“„ ç« ãªã—ï¼ˆã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã§ç« ã‹ã‚‰å¤–ã™ï¼‰
                      </div>
                    )}
                    {/* ç« ã«å±ã•ãªã„è©± */}
                    {p.items.filter(i => i.type === 'chapter' && !i.sectionId).map((item, idx) => {
                      const isSelected = selectedItems[p.id]?.includes(item.id);
                      return (
                      <div 
                        key={item.id} 
                        draggable={!checkboxMode}
                        onDragStart={(e) => { e.stopPropagation(); e.dataTransfer.setData('itemId', item.id); e.dataTransfer.setData('itemType', 'chapter'); e.dataTransfer.setData('projectId', p.id); e.dataTransfer.setData('status', status); }}
                        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderTop = `2px solid ${theme.accent}`; }}
                        onDragLeave={(e) => { e.currentTarget.style.borderTop = 'none'; }}
                        onDrop={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderTop = 'none'; const draggedId = e.dataTransfer.getData('itemId'); if (draggedId && draggedId !== item.id) reorderItems(p.id, status, draggedId, item.id, 'before'); }}
                        onClick={() => !checkboxMode && openInNewPane({...item, projectId: p.id, status})} 
                        style={{ display: 'flex', alignItems: 'center', padding: '5px 10px', margin: '1px 6px', borderRadius: '4px', cursor: checkboxMode ? 'pointer' : 'grab', gap: '6px', fontSize: '12px', background: selectedItem?.id === item.id ? theme.highlight : 'transparent', border: isSelected ? `2px solid ${theme.accent}` : 'none', position: 'relative' }}
                      >
                        {checkboxMode && (
                          <input 
                            type="checkbox" 
                            checked={isSelected}
                            onChange={(e) => {
                              e.stopPropagation();
                              const newSelected = isSelected
                                ? (selectedItems[p.id] || []).filter(id => id !== item.id)
                                : [...(selectedItems[p.id] || []), item.id];
                              setSelectedItems(prev => ({ ...prev, [p.id]: newSelected }));
                            }}
                            onClick={(e) => e.stopPropagation()}
                            style={{ width: '16px', height: '16px', cursor: 'pointer', marginRight: '4px' }}
                          />
                        )}
                        {!checkboxMode && <Icons.GripVertical />}
                        <select 
                          value={item.progress || 'none'} 
                          onChange={(e) => { e.stopPropagation(); updateItemProgress(p.id, item.id, status, e.target.value); }}
                          onClick={(e) => e.stopPropagation()}
                          style={{ 
                            padding: '1px 2px', fontSize: '9px', borderRadius: '3px', border: 'none', cursor: 'pointer',
                            background: progressColors[item.progress || 'none'], color: '#fff',
                            width: '24px', textAlign: 'center', appearance: 'none', WebkitAppearance: 'none'
                          }}
                          title={progressLabels[item.progress || 'none'] || ''}
                        >
                          {Object.entries(progressIcons).map(([key, icon]) => (
                            <option key={key} value={key}>{icon}</option>
                          ))}
                        </select>
                        {editingItemId === item.id ? (
                          <input type="text" value={item.name} onChange={(e) => renameItem(p.id, item.id, status, e.target.value)} onBlur={() => setEditingItemId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingItemId(null)} onClick={(e) => e.stopPropagation()} autoFocus style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, outline: 'none', color: theme.text, fontSize: '12px', padding: '2px 6px', borderRadius: '4px' }} />
                        ) : (
                          <span onDoubleClick={(e) => { e.stopPropagation(); setEditingItemId(item.id); }} style={{ flex: 1 }}>{item.name}</span>
                        )}
                        {/* ã‚·ãƒ¼ãƒ³é€²æ—ãƒãƒƒã‚¸ */}
                        {(() => {
                          const sceneCount = ((item.content || '').match(/^###\s+/gm) || []).length;
                          const sp = item.sceneProgress || {};
                          const draftCount = Object.values(sp).filter(s => s.draft).length;
                          const manuscriptCount = Object.values(sp).filter(s => s.manuscript).length;
                          if (sceneCount > 0) {
                            return (
                              <span style={{ fontSize: '8px', color: theme.textSecondary, display: 'flex', gap: '4px' }}>
                                <span style={{ color: '#2196f3' }} title="ãƒ‰ãƒ©ãƒ•ãƒˆå®Œäº†">D{draftCount}/{sceneCount}</span>
                                <span style={{ color: '#4caf50' }} title="åŸç¨¿å®Œäº†">M{manuscriptCount}/{sceneCount}</span>
                              </span>
                            );
                          }
                          return null;
                        })()}
                        <span style={{ fontSize: '10px', color: theme.accent, fontWeight: '500' }}>{(item.content || '').replace(/[\s\n]/g, '').length.toLocaleString()}å­—</span>
                        <button onClick={(e) => { e.stopPropagation(); openInNewPane({...item, projectId: p.id, status}); }} style={{ background: 'none', border: 'none', color: theme.success, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã"><Icons.Plus /></button>
                        <button onClick={(e) => { e.stopPropagation(); moveItemToHold(p.id, item, status); }} style={{ background: 'none', border: 'none', color: theme.warning, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="ä¿ç•™ã«ç§»å‹•"><Icons.Pause /></button>
                        <button onClick={(e) => { e.stopPropagation(); deleteItem(p.id, item.id, status); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.5 }}><Icons.Trash /></button>
                      </div>
                    );
                    })}
                    
                    {/* ç« ã¨ãã®ä¸­ã®è©± */}
                    {p.items.filter(i => i.type === 'section').map((section, sectionIdx) => {
                      const sectionChapters = p.items.filter(i => i.type === 'chapter' && i.sectionId === section.id);
                      const sectionCharCount = sectionChapters.reduce((sum, i) => sum + (i.content || '').replace(/[\s\n]/g, '').length, 0);
                      return (
                        <div key={section.id} style={{ marginTop: '6px' }}>
                          {/* ç« ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                          <div 
                            draggable
                            onDragStart={(e) => { e.stopPropagation(); e.dataTransfer.setData('itemId', section.id); e.dataTransfer.setData('itemType', 'section'); e.dataTransfer.setData('projectId', p.id); e.dataTransfer.setData('status', status); }}
                            onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderTop = `2px solid ${theme.accent}`; }}
                            onDragLeave={(e) => { e.currentTarget.style.borderTop = 'none'; }}
                            onDrop={(e) => { 
                              e.preventDefault(); 
                              e.stopPropagation(); 
                              e.currentTarget.style.borderTop = 'none';
                              const draggedId = e.dataTransfer.getData('itemId'); 
                              const draggedType = e.dataTransfer.getData('itemType');
                              const draggedItem = p.items.find(i => i.id === draggedId); 
                              if (draggedType === 'section' && draggedId !== section.id) {
                                // ç« åŒå£«ã®å…¥ã‚Œæ›¿ãˆ
                                reorderSections(p.id, status, draggedId, section.id, 'before');
                              } else if (draggedItem && draggedItem.type === 'chapter') {
                                // è©±ã‚’ç« ã«ãƒ‰ãƒ­ãƒƒãƒ—
                                moveItemToSection(p.id, draggedId, section.id, status);
                              }
                            }}
                            style={{ display: 'flex', alignItems: 'center', padding: '4px 8px', margin: '0 6px', borderRadius: '4px', gap: '4px', fontSize: '11px', background: theme.bgTertiary, cursor: 'grab', borderLeft: `3px solid ${theme.accent}` }}
                          >
                            <Icons.GripVertical />
                            <span onClick={(e) => { e.stopPropagation(); toggleChapterSection(p.id, section.id, status); }} style={{ cursor: 'pointer', display: 'flex', transform: section.expanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}><Icons.ChevronRight /></span>
                            {editingItemId === section.id ? (
                              <input type="text" value={section.name} onChange={(e) => renameItem(p.id, section.id, status, e.target.value)} onBlur={() => setEditingItemId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingItemId(null)} onClick={(e) => e.stopPropagation()} autoFocus style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, outline: 'none', color: theme.accent, fontSize: '11px', padding: '2px 6px', borderRadius: '4px', fontWeight: '600' }} />
                            ) : (
                              <span onDoubleClick={(e) => { e.stopPropagation(); setEditingItemId(section.id); }} style={{ flex: 1, fontWeight: '600', color: theme.accent }}>{section.name}</span>
                            )}
                            <span style={{ fontSize: '9px', color: theme.textSecondary }}>{sectionChapters.length}è©±</span>
                            <span style={{ fontSize: '9px', color: theme.accent }}>{sectionCharCount.toLocaleString()}å­—</span>
                            <button onClick={(e) => { e.stopPropagation(); deleteItem(p.id, section.id, status); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.5 }} title="ç« ã‚’å‰Šé™¤"><Icons.Trash /></button>
                          </div>
                          {/* ç« å†…ã®è©± */}
                          {section.expanded !== false && (
                            <div 
                              style={{ marginLeft: '12px', borderLeft: `1px dashed ${theme.border}`, marginTop: '2px' }}
                              onDragOver={(e) => { e.preventDefault(); }}
                              onDrop={(e) => { e.preventDefault(); const draggedId = e.dataTransfer.getData('itemId'); const draggedItem = p.items.find(i => i.id === draggedId); if (draggedItem && draggedItem.type === 'chapter') moveItemToSection(p.id, draggedId, section.id, status); }}
                            >
                              {sectionChapters.map(item => {
                                const isSelected = selectedItems[p.id]?.includes(item.id);
                                return (
                                <div 
                                  key={item.id} 
                                  draggable={!checkboxMode}
                                  onDragStart={(e) => { e.stopPropagation(); e.dataTransfer.setData('itemId', item.id); e.dataTransfer.setData('itemType', 'chapter'); e.dataTransfer.setData('projectId', p.id); e.dataTransfer.setData('status', status); }}
                                  onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderTop = `2px solid ${theme.accent}`; }}
                                  onDragLeave={(e) => { e.currentTarget.style.borderTop = 'none'; }}
                                  onDrop={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderTop = 'none'; const draggedId = e.dataTransfer.getData('itemId'); if (draggedId && draggedId !== item.id) reorderItems(p.id, status, draggedId, item.id, 'before'); }}
                                  onClick={() => !checkboxMode && openInNewPane({...item, projectId: p.id, status})} 
                                  style={{ display: 'flex', alignItems: 'center', padding: '5px 10px', margin: '1px 6px', borderRadius: '4px', cursor: checkboxMode ? 'pointer' : 'grab', gap: '6px', fontSize: '12px', background: selectedItem?.id === item.id ? theme.highlight : 'transparent', border: isSelected ? `2px solid ${theme.accent}` : 'none', position: 'relative' }}
                                >
                                  {checkboxMode && (
                                    <input 
                                      type="checkbox" 
                                      checked={isSelected}
                                      onChange={(e) => {
                                        e.stopPropagation();
                                        const newSelected = isSelected
                                          ? (selectedItems[p.id] || []).filter(id => id !== item.id)
                                          : [...(selectedItems[p.id] || []), item.id];
                                        setSelectedItems(prev => ({ ...prev, [p.id]: newSelected }));
                                      }}
                                      onClick={(e) => e.stopPropagation()}
                                      style={{ width: '16px', height: '16px', cursor: 'pointer', marginRight: '4px' }}
                                    />
                                  )}
                                  {!checkboxMode && <Icons.GripVertical />}
                                  <select 
                                    value={item.progress || 'none'} 
                                    onChange={(e) => { e.stopPropagation(); updateItemProgress(p.id, item.id, status, e.target.value); }}
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ 
                                      padding: '1px 2px', fontSize: '9px', borderRadius: '3px', border: 'none', cursor: 'pointer',
                                      background: progressColors[item.progress || 'none'], color: '#fff',
                                      width: '24px', textAlign: 'center', appearance: 'none', WebkitAppearance: 'none'
                                    }}
                                    title={progressLabels[item.progress || 'none'] || ''}
                                  >
                                    {Object.entries(progressIcons).map(([key, icon]) => (
                                      <option key={key} value={key}>{icon}</option>
                                    ))}
                                  </select>
                                  {editingItemId === item.id ? (
                                    <input type="text" value={item.name} onChange={(e) => renameItem(p.id, item.id, status, e.target.value)} onBlur={() => setEditingItemId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingItemId(null)} onClick={(e) => e.stopPropagation()} autoFocus style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, outline: 'none', color: theme.text, fontSize: '12px', padding: '2px 6px', borderRadius: '4px' }} />
                                  ) : (
                                    <span onDoubleClick={(e) => { e.stopPropagation(); setEditingItemId(item.id); }} style={{ flex: 1 }}>{item.name}</span>
                                  )}
                                  {/* ã‚·ãƒ¼ãƒ³é€²æ—ãƒãƒƒã‚¸ */}
                                  {(() => {
                                    const sceneCount = ((item.content || '').match(/^###\s+/gm) || []).length;
                                    const sp = item.sceneProgress || {};
                                    const draftCount = Object.values(sp).filter(s => s.draft).length;
                                    const manuscriptCount = Object.values(sp).filter(s => s.manuscript).length;
                                    if (sceneCount > 0) {
                                      return (
                                        <span style={{ fontSize: '8px', color: theme.textSecondary, display: 'flex', gap: '4px' }}>
                                          <span style={{ color: '#2196f3' }} title="ãƒ‰ãƒ©ãƒ•ãƒˆå®Œäº†">D{draftCount}/{sceneCount}</span>
                                          <span style={{ color: '#4caf50' }} title="åŸç¨¿å®Œäº†">M{manuscriptCount}/{sceneCount}</span>
                                        </span>
                                      );
                                    }
                                    return null;
                                  })()}
                                  <span style={{ fontSize: '10px', color: theme.accent, fontWeight: '500' }}>{(item.content || '').replace(/[\s\n]/g, '').length.toLocaleString()}å­—</span>
                                  <button onClick={(e) => { e.stopPropagation(); openInNewPane({...item, projectId: p.id, status}); }} style={{ background: 'none', border: 'none', color: theme.success, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã"><Icons.Plus /></button>
                                  <button onClick={(e) => { e.stopPropagation(); moveItemToHold(p.id, item, status); }} style={{ background: 'none', border: 'none', color: theme.warning, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="ä¿ç•™ã«ç§»å‹•"><Icons.Pause /></button>
                                  <button onClick={(e) => { e.stopPropagation(); deleteItem(p.id, item.id, status); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.5 }}><Icons.Trash /></button>
                                </div>
                              );
                              })}
                              {sectionChapters.length === 0 && (
                                <div style={{ padding: '8px 16px', fontSize: '10px', color: theme.textSecondary, opacity: 0.7 }}>è©±ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã“ã“ã«è¿½åŠ </div>
                              )}
                              <button onClick={() => addItem(p.id, status, 'chapter', section.id)} style={{ margin: '4px 6px', padding: '3px 8px', fontSize: '10px', background: 'transparent', border: `1px dashed ${theme.border}`, borderRadius: '4px', color: theme.textSecondary, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> ã“ã®ç« ã«è©±ã‚’è¿½åŠ </button>
                            </div>
                          )}
                        </div>
                      );
                    })}
                    
                    {/* ç« ã®è¿½åŠ ãƒœã‚¿ãƒ³ */}
                    <div style={{ display: 'flex', gap: '4px', padding: '6px 10px', marginTop: '4px' }}>
                      <button onClick={() => addItem(p.id, status, 'section')} style={{ padding: '4px 8px', fontSize: '10px', background: theme.accentLight, border: 'none', borderRadius: '4px', color: '#fff', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> ç« ã‚’è¿½åŠ </button>
                    </div>
                    
                    {/* ãƒ¡ãƒ¢ */}
                    {p.items.filter(i => i.type === 'memo').length > 0 && (
                      <div style={{ marginTop: '4px', paddingTop: '4px', borderTop: `1px dashed ${theme.border}`, marginRight: '6px' }}>
                        <div style={{ fontSize: '9px', color: theme.textSecondary, marginBottom: '2px', marginLeft: '10px' }}>ğŸ“ ãƒ¡ãƒ¢ãƒ»è³‡æ–™</div>
                        {p.items.filter(i => i.type === 'memo').map(item => (
                          <div key={item.id} onClick={() => setSelectedItem({...item, projectId: p.id, status})} style={{ display: 'flex', alignItems: 'center', padding: '5px 10px', margin: '1px 6px', borderRadius: '4px', cursor: 'pointer', gap: '6px', fontSize: '12px', background: selectedItem?.id === item.id ? theme.highlight : 'transparent', opacity: 0.85 }}>
                              <Icons.File />
                              {editingItemId === item.id ? (
                                <input type="text" value={item.name} onChange={(e) => renameItem(p.id, item.id, status, e.target.value)} onBlur={() => setEditingItemId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingItemId(null)} onClick={(e) => e.stopPropagation()} autoFocus style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, outline: 'none', color: theme.textSecondary, fontSize: '12px', padding: '2px 6px', borderRadius: '4px' }} />
                              ) : (
                                <span onDoubleClick={(e) => { e.stopPropagation(); setEditingItemId(item.id); }} style={{ flex: 1, color: theme.textSecondary }}>{item.name}</span>
                              )}
                              <button onClick={(e) => { e.stopPropagation(); openInNewPane({...item, projectId: p.id, status}); }} style={{ background: 'none', border: 'none', color: theme.success, cursor: 'pointer', padding: '2px', opacity: 0.6 }} title="æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã"><Icons.Plus /></button>
                              <button onClick={(e) => { e.stopPropagation(); deleteItem(p.id, item.id, status); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.5 }}><Icons.Trash /></button>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {/* ä½œå“åˆ¥ä»˜ç®‹ */}
                    {(p.stickies || []).length > 0 && (() => {
                      const projectStickies = p.stickies || [];
                      const currentFilter = projectStickyFilter[p.id] || 'all';
                      const filteredProjectStickies = currentFilter === 'all' ? projectStickies : projectStickies.filter(s => s.color === currentFilter);
                      const stickyColors = data.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'];
                      const colorNames = { '#FFEB3B': 'ğŸŸ¡', '#FF9800': 'ğŸŸ ', '#E91E63': 'ğŸ©·', '#4CAF50': 'ğŸŸ¢', '#2196F3': 'ğŸ”µ', '#9C27B0': 'ğŸŸ£' };
                      
                      return (
                        <div style={{ marginTop: '4px', paddingTop: '4px', borderTop: `1px dashed ${theme.border}`, marginRight: '6px' }}>
                          <div style={{ fontSize: '9px', color: theme.textSecondary, marginBottom: '4px', marginLeft: '10px', display: 'flex', alignItems: 'center', gap: '6px', flexWrap: 'wrap' }}>
                            <span>ğŸ“Œ ä»˜ç®‹ ({projectStickies.length})</span>
                            <button 
                              onClick={() => {
                                const allCollapsed = filteredProjectStickies.every(s => s.collapsed);
                                const updatedProjects = creative[status].map(proj => 
                                  proj.id === p.id 
                                    ? { ...proj, stickies: (proj.stickies || []).map(s => {
                                        if (currentFilter === 'all' || s.color === currentFilter) {
                                          return { ...s, collapsed: !allCollapsed };
                                        }
                                        return s;
                                      })}
                                    : proj
                                );
                                setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                              }}
                              style={{ padding: '1px 4px', fontSize: '8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }}
                            >
                              {filteredProjectStickies.every(s => s.collapsed) ? 'ğŸ“‚' : 'ğŸ“'}
                            </button>
                          </div>
                          {/* è‰²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                          <div style={{ marginLeft: '10px', marginBottom: '4px', display: 'flex', gap: '3px', flexWrap: 'wrap', alignItems: 'center' }}>
                            <button 
                              onClick={() => setProjectStickyFilter(prev => ({ ...prev, [p.id]: 'all' }))}
                              style={{ padding: '1px 5px', fontSize: '8px', background: currentFilter === 'all' ? theme.accent : theme.bgTertiary, color: currentFilter === 'all' ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}
                            >All</button>
                            {stickyColors.map(color => {
                              const count = projectStickies.filter(s => s.color === color).length;
                              if (count === 0) return null;
                              return (
                                <button 
                                  key={color}
                                  onClick={() => setProjectStickyFilter(prev => ({ ...prev, [p.id]: color }))}
                                  style={{ padding: '1px 5px', fontSize: '8px', background: currentFilter === color ? color : theme.bgTertiary, color: currentFilter === color ? '#333' : theme.textSecondary, border: currentFilter === color ? '1px solid #333' : 'none', borderRadius: '3px', cursor: 'pointer' }}
                                >
                                  {colorNames[color]}({count})
                                </button>
                              );
                            })}
                          </div>
                          {filteredProjectStickies.map(sticky => (
                            <div key={sticky.id} style={{ margin: '2px 6px', padding: sticky.collapsed ? '4px 8px' : '8px', borderRadius: '6px', background: sticky.color, position: 'relative' }}>
                              {sticky.collapsed ? (
                                <div 
                                  style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer' }}
                                  onClick={() => {
                                    const updatedProjects = creative[status].map(proj => 
                                      proj.id === p.id 
                                        ? { ...proj, stickies: (proj.stickies || []).map(s => s.id === sticky.id ? { ...s, collapsed: false } : s) }
                                        : proj
                                    );
                                    setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                                  }}
                                >
                                  <span style={{ color: '#333', fontSize: '10px' }}>â–¶</span>
                                  <span style={{ flex: 1, fontSize: '10px', color: '#333', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {sticky.content ? sticky.content.substring(0, 20) + (sticky.content.length > 20 ? '...' : '') : '(ç©º)'}
                                  </span>
                                </div>
                              ) : (
                                <>
                                  <div 
                                    style={{ fontSize: '9px', color: '#333', marginBottom: '4px', cursor: 'pointer', opacity: 0.7 }}
                                    onClick={() => {
                                      const updatedProjects = creative[status].map(proj => 
                                        proj.id === p.id 
                                          ? { ...proj, stickies: (proj.stickies || []).map(s => s.id === sticky.id ? { ...s, collapsed: true } : s) }
                                          : proj
                                      );
                                      setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                                    }}
                                  >â–¼</div>
                                  <textarea 
                                    value={sticky.content}
                                    onChange={(e) => {
                                      const updatedProjects = creative[status].map(proj => 
                                        proj.id === p.id 
                                          ? { ...proj, stickies: (proj.stickies || []).map(s => s.id === sticky.id ? { ...s, content: e.target.value } : s) }
                                          : proj
                                      );
                                      setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                                      autoResize(e.target);
                                    }}
                                    ref={(el) => el && autoResize(el)}
                                    placeholder="ãƒ¡ãƒ¢..."
                                    style={{ width: '100%', minHeight: '40px', background: 'rgba(255,255,255,0.3)', border: 'none', borderRadius: '4px', padding: '6px', fontSize: '11px', lineHeight: '1.5', color: '#333', resize: 'none', outline: 'none', overflow: 'hidden' }}
                                  />
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '4px' }}>
                                    <div style={{ display: 'flex', gap: '2px' }}>
                                      {stickyColors.map(color => (
                                        <button 
                                          key={color}
                                          onClick={() => {
                                            const updatedProjects = creative[status].map(proj => 
                                              proj.id === p.id 
                                                ? { ...proj, stickies: (proj.stickies || []).map(s => s.id === sticky.id ? { ...s, color } : s) }
                                                : proj
                                            );
                                            setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                                          }}
                                          style={{ width: '12px', height: '12px', background: color, border: sticky.color === color ? '2px solid #333' : '1px solid rgba(0,0,0,0.2)', borderRadius: '50%', cursor: 'pointer' }}
                                        />
                                      ))}
                                    </div>
                                    <button 
                                      onClick={() => {
                                        const updatedProjects = creative[status].map(proj => 
                                          proj.id === p.id 
                                            ? { ...proj, stickies: (proj.stickies || []).filter(s => s.id !== sticky.id) }
                                            : proj
                                        );
                                        setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                                      }}
                                      style={{ padding: '1px 4px', fontSize: '8px', background: 'rgba(0,0,0,0.2)', color: '#333', border: 'none', borderRadius: '3px', cursor: 'pointer' }}
                                    >ğŸ—‘ï¸</button>
                                  </div>
                                </>
                              )}
                            </div>
                          ))}
                          {filteredProjectStickies.length === 0 && currentFilter !== 'all' && (
                            <div style={{ padding: '8px 10px', fontSize: '10px', color: theme.textSecondary, textAlign: 'center' }}>
                              ã“ã®è‰²ã®ä»˜ç®‹ã¯ã‚ã‚Šã¾ã›ã‚“
                            </div>
                          )}
                        </div>
                      );
                    })()}
                    
                    {/* ãƒ¡ãƒ¢ãƒ»ä»˜ç®‹ã®è¿½åŠ ãƒœã‚¿ãƒ³ */}
                    <div style={{ display: 'flex', gap: '4px', padding: '4px 10px 6px', flexWrap: 'wrap' }}>
                      <button onClick={() => addItem(p.id, status, 'memo')} style={{ padding: '4px 8px', fontSize: '10px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.textSecondary, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> ãƒ¡ãƒ¢</button>
                      <button onClick={() => {
                        const colors = data.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'];
                        const newSticky = { id: `sticky-${Date.now()}`, content: '', color: colors[(p.stickies || []).length % colors.length], createdAt: new Date().toISOString() };
                        const updatedProjects = creative[status].map(proj => 
                          proj.id === p.id ? { ...proj, stickies: [...(proj.stickies || []), newSticky] } : proj
                        );
                        setData({ ...data, creative: { ...creative, [status]: updatedProjects } });
                      }} style={{ padding: '4px 8px', fontSize: '10px', background: '#FFEB3B', border: 'none', borderRadius: '4px', color: '#333', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>ğŸ“Œ ä»˜ç®‹</button>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      };

      // ä¿ç•™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè©±å˜ä½ï¼‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      const renderHoldItems = () => {
        const holdItems = creative.holdItems || [];
        const isCollapsed = collapsedSections.holdItems;

        return (
          <div style={{ marginBottom: '16px' }}>
            <div 
              onClick={() => toggleSection('holdItems')}
              style={{ 
                display: 'flex', alignItems: 'center', justifyContent: 'space-between', 
                padding: '8px 12px', color: theme.textSecondary, fontSize: '11px', 
                textTransform: 'uppercase', letterSpacing: '0.5px', 
                borderRadius: '6px', cursor: 'pointer'
              }}
            >
              <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <span style={{ transform: isCollapsed ? 'rotate(0deg)' : 'rotate(90deg)', transition: 'transform 0.2s', display: 'flex' }}>
                  <Icons.ChevronRight />
                </span>
                â¸ï¸ ä¿ç•™ï¼ˆè©±å˜ä½ï¼‰({holdItems.length})
              </span>
            </div>
            
            {!isCollapsed && holdItems.map(item => (
              <div key={item.id} onClick={() => setSelectedItem({ ...item, isHoldItem: true })} style={{ display: 'flex', alignItems: 'center', padding: '8px 12px', margin: '2px 8px', borderRadius: '6px', cursor: 'pointer', gap: '8px', fontSize: '13px', background: selectedItem?.id === item.id ? theme.highlight : theme.bgTertiary }}>
                <Icons.Pause />
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontWeight: '500', marginBottom: '2px' }}>{item.name}</div>
                  <div style={{ fontSize: '10px', color: theme.textSecondary, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                    å…ƒ: {item.originalProjectName}
                  </div>
                </div>
                <span style={{ fontSize: '11px', color: theme.accent, fontWeight: '500' }}>{(item.content || '').replace(/[\s\n]/g, '').length.toLocaleString()}å­—</span>
                <button onClick={(e) => { e.stopPropagation(); moveItemFromHold(item); }} style={{ padding: '2px 6px', fontSize: '9px', background: theme.success, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }} title="å…ƒã«æˆ»ã™">æˆ»ã™</button>
                <button onClick={(e) => { e.stopPropagation(); deleteHoldItem(item.id); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', opacity: 0.5 }}><Icons.Trash /></button>
              </div>
            ))}
            
            {!isCollapsed && holdItems.length === 0 && (
              <div style={{ padding: '12px 20px', color: theme.textSecondary, fontSize: '11px', opacity: 0.7 }}>
                è©±ã®æ¨ªã® â¸ï¸ ãƒœã‚¿ãƒ³ã§ä¿ç•™ã«ç§»å‹•ã§ãã¾ã™
              </div>
            )}
          </div>
        );
      };

      const statusLabels = { unused: 'æœªä½¿ç”¨', tweeted: 'ãƒ„ã‚¤ãƒãƒ™', posted: 'æŠ•ç¨¿æ¸ˆ', used: 'ä½¿ç”¨æ¸ˆ' };
      const statusColors = { unused: theme.accent, tweeted: theme.warning, posted: '#9b59b6', used: theme.success };

      return (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }} onClick={() => setShowTagSelector(null)}>
          {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
          <div style={{ display: 'flex', borderBottom: `1px solid ${theme.border}` }}>
            <button onClick={() => setActiveTab('works')} style={{ flex: 1, padding: '6px', fontSize: '11px', fontWeight: '500', background: activeTab === 'works' ? theme.bg : 'transparent', color: activeTab === 'works' ? theme.accent : theme.textSecondary, border: 'none', borderBottom: activeTab === 'works' ? `2px solid ${theme.accent}` : '2px solid transparent', cursor: 'pointer' }}>ğŸ“ ä½œå“</button>
            <button onClick={() => setActiveTab('ideas')} style={{ flex: 1, padding: '6px', fontSize: '11px', fontWeight: '500', background: activeTab === 'ideas' ? theme.bg : 'transparent', color: activeTab === 'ideas' ? theme.accent : theme.textSecondary, border: 'none', borderBottom: activeTab === 'ideas' ? `2px solid ${theme.accent}` : '2px solid transparent', cursor: 'pointer' }}>ğŸ’¡ ãƒã‚¿ ({ideas.length})</button>
            <button onClick={() => setActiveTab('stickies')} style={{ flex: 1, padding: '6px', fontSize: '11px', fontWeight: '500', background: activeTab === 'stickies' ? theme.bg : 'transparent', color: activeTab === 'stickies' ? theme.accent : theme.textSecondary, border: 'none', borderBottom: activeTab === 'stickies' ? `2px solid ${theme.accent}` : '2px solid transparent', cursor: 'pointer' }}>ğŸ“Œ ä»˜ç®‹ ({stickies.length})</button>
          </div>

          {/* ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä½œå“ãƒ»ãƒã‚¿ã‚¿ãƒ–ã®ã¿ï¼‰ */}
          {(activeTab === 'works' || activeTab === 'ideas') && (
            <div style={{ padding: '5px 10px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '3px', flexWrap: 'wrap' }}>
              <button onClick={() => setTagFilter('all')} style={{ padding: '2px 6px', fontSize: '9px', background: tagFilter === 'all' ? theme.accent : theme.bgTertiary, color: tagFilter === 'all' ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}>All</button>
              {usedTags.map(tag => (
                <button key={tag} onClick={() => setTagFilter(tag)} style={{ padding: '2px 6px', fontSize: '9px', background: tagFilter === tag ? theme.accent : theme.bgTertiary, color: tagFilter === tag ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}>{tag}</button>
              ))}
            </div>
          )}

          {activeTab === 'works' && (
            <div style={{ flex: 1, overflow: 'auto' }}>
              <div style={{ padding: '6px 10px', borderBottom: `1px solid ${theme.border}`, fontSize: '10px', color: theme.textSecondary }}>
                ç·æ–‡å­—æ•°: <span style={{ color: theme.accent, fontWeight: '600' }}>{totalChars().toLocaleString()}</span> å­—
              </div>
              {renderList(creative.inProgress, 'inProgress', 'åˆ¶ä½œä¸­', 'ğŸ“', false)}
              {renderHoldItems()}
              {renderList(creative.onHold, 'onHold', 'åˆ¶ä½œä¸­æ–­', 'ğŸš«', true)}
              {renderList(creative.completed, 'completed', 'å®Œäº†', 'âœ…', true)}
            </div>
          )}

          {activeTab === 'ideas' && (
            <div style={{ flex: 1, overflow: 'auto' }}>
              <div style={{ padding: '8px 10px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '4px' }}>
                <span style={{ fontSize: '10px', color: theme.textSecondary }}>ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†</span>
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  {!checkboxMode ? (
                    <>
                      <button onClick={() => setCheckboxMode(true)} style={{ padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer', fontSize: '9px' }}>
                        â˜‘ï¸ é¸æŠ
                      </button>
                      <button onClick={addIdea} style={{ padding: '4px 10px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> è¿½åŠ </button>
                    </>
                  ) : (
                    <>
                      <button onClick={() => {
                        if (selectedIdeas.length > 0 && confirm(`${selectedIdeas.length}å€‹ã®ãƒã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                          setData({ ...data, creative: { ...creative, ideas: ideas.filter(i => !selectedIdeas.includes(i.id)) } });
                          setSelectedIdeas([]);
                        }
                      }} disabled={selectedIdeas.length === 0} style={{ padding: '4px 8px', background: selectedIdeas.length > 0 ? theme.error : theme.bgTertiary, color: selectedIdeas.length > 0 ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: selectedIdeas.length > 0 ? 'pointer' : 'not-allowed', fontSize: '9px' }}>
                        ğŸ—‘ï¸ å‰Šé™¤ ({selectedIdeas.length})
                      </button>
                      <button onClick={() => { setCheckboxMode(false); setSelectedIdeas([]); }} style={{ padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer', fontSize: '9px' }}>
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                    </>
                  )}
                </div>
              </div>
              {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
              <div style={{ padding: '6px 10px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '4px', flexWrap: 'wrap', alignItems: 'center' }}>
                <span style={{ fontSize: '9px', color: theme.textSecondary }}>çµè¾¼:</span>
                {['all', 'unused', 'tweeted', 'posted', 'used'].map(s => {
                  const count = s === 'all' ? ideas.length : ideas.filter(i => i.status === s).length;
                  if (s !== 'all' && count === 0) return null;
                  return (
                    <button 
                      key={s}
                      onClick={() => setIdeaStatusFilter(s)}
                      style={{ 
                        padding: '2px 6px', fontSize: '9px', borderRadius: '4px', cursor: 'pointer',
                        background: ideaStatusFilter === s ? (s === 'all' ? theme.accent : statusColors[s] || theme.accent) : theme.bgTertiary,
                        color: ideaStatusFilter === s ? '#fff' : theme.textSecondary,
                        border: 'none'
                      }}
                    >
                      {s === 'all' ? 'ã™ã¹ã¦' : statusLabels[s]} ({count})
                    </button>
                  );
                })}
              </div>
              <div style={{ padding: '8px' }}>
                {filteredIdeas.map(idea => {
                  const charCount = (idea.content || '').replace(/[\s\n]/g, '').length;
                  const isSelected = selectedIdeas.includes(idea.id);
                  return (
                  <div key={idea.id} onClick={() => !checkboxMode && setSelectedItem({ ...idea, isIdea: true })} style={{ padding: '10px 12px', marginBottom: '4px', borderRadius: '8px', cursor: 'pointer', background: selectedItem?.id === idea.id ? theme.highlight : theme.bgTertiary, border: isSelected ? `3px solid ${theme.accent}` : `1px solid ${selectedItem?.id === idea.id ? theme.accent : 'transparent'}`, position: 'relative' }}>
                    {checkboxMode && (
                      <input 
                        type="checkbox" 
                        checked={isSelected}
                        onChange={(e) => {
                          e.stopPropagation();
                          if (e.target.checked) {
                            setSelectedIdeas(prev => [...prev, idea.id]);
                          } else {
                            setSelectedIdeas(prev => prev.filter(id => id !== idea.id));
                          }
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{ position: 'absolute', top: '8px', right: '8px', width: '18px', height: '18px', cursor: 'pointer' }}
                      />
                    )}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                      <Icons.Lightbulb />
                      {editingIdeaId === idea.id ? (
                        <input type="text" value={idea.title} onChange={(e) => updateIdea(idea.id, 'title', e.target.value)} onBlur={() => setEditingIdeaId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingIdeaId(null)} autoFocus onClick={(e) => e.stopPropagation()} style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '2px 6px', color: theme.text, fontSize: '12px', outline: 'none' }} />
                      ) : (
                        <span onDoubleClick={(e) => { e.stopPropagation(); setEditingIdeaId(idea.id); }} style={{ flex: 1, fontSize: '12px', fontWeight: '500' }}>{idea.title}</span>
                      )}
                      <span style={{ fontSize: '9px', color: charCount >= 900 && charCount <= 1100 ? theme.success : theme.accent, fontWeight: '500' }}>{charCount.toLocaleString()}å­—</span>
                      <span style={{ fontSize: '9px', padding: '2px 6px', background: statusColors[idea.status], color: '#fff', borderRadius: '4px' }}>{statusLabels[idea.status]}</span>
                    </div>
                    <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginBottom: '4px' }}>
                      {(idea.tags || []).map(tag => (
                        <span key={tag} style={{ fontSize: '9px', padding: '2px 5px', background: theme.accent, color: '#fff', borderRadius: '3px' }}>{tag}</span>
                      ))}
                    </div>
                    {idea.content && (
                      <div style={{ fontSize: '10px', color: theme.textSecondary, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{idea.content.substring(0, 40)}...</div>
                    )}
                    <div style={{ display: 'flex', gap: '4px', marginTop: '6px' }}>
                      {idea.status === 'unused' && (
                        <button onClick={(e) => { e.stopPropagation(); updateIdea(idea.id, 'status', 'tweeted'); }} style={{ padding: '3px 8px', fontSize: '9px', background: theme.warning, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>ğŸ“± ãƒ„ã‚¤ãƒãƒ™åŒ–</button>
                      )}
                      {idea.status === 'tweeted' && (
                        <button onClick={(e) => { e.stopPropagation(); updateIdea(idea.id, 'status', 'posted'); }} style={{ padding: '3px 8px', fontSize: '9px', background: '#9b59b6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>âœ“ æŠ•ç¨¿æ¸ˆã¿ã«</button>
                      )}
                      {idea.status === 'posted' && (
                        <button onClick={(e) => { e.stopPropagation(); updateIdea(idea.id, 'status', 'tweeted'); }} style={{ padding: '3px 8px', fontSize: '9px', background: theme.warning, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>â†© æœªæŠ•ç¨¿ã«æˆ»ã™</button>
                      )}
                      {(idea.status === 'unused' || idea.status === 'tweeted') && (
                        <button onClick={(e) => { e.stopPropagation(); convertIdeaToProject(idea); }} style={{ padding: '3px 8px', fontSize: '9px', background: theme.success, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>â†’ ä½œå“åŒ–</button>
                      )}
                      <button onClick={(e) => { e.stopPropagation(); deleteIdea(idea.id); }} style={{ padding: '3px 8px', fontSize: '9px', background: theme.error, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>å‰Šé™¤</button>
                    </div>
                  </div>
                  );
                })}
                {filteredIdeas.length === 0 && <div style={{ textAlign: 'center', color: theme.textSecondary, padding: '40px 20px', fontSize: '12px' }}>ãƒã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br/>ã€Œ+ è¿½åŠ ã€ã§ä½œæˆã—ã¦ã­</div>}
              </div>
            </div>
          )}

          {activeTab === 'stickies' && (() => {
            const stickyColors = data.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'];
            const colorNames = { '#FFEB3B': 'ğŸŸ¡', '#FF9800': 'ğŸŸ ', '#E91E63': 'ğŸ©·', '#4CAF50': 'ğŸŸ¢', '#2196F3': 'ğŸ”µ', '#9C27B0': 'ğŸŸ£' };
            const filteredStickies = stickyColorFilter === 'all' ? stickies : stickies.filter(s => s.color === stickyColorFilter);
            const allCollapsed = filteredStickies.length > 0 && filteredStickies.every(s => collapsedStickies[s.id]);
            
            return (
              <div style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column' }}>
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div style={{ padding: '8px 10px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                  <span style={{ fontSize: '10px', color: theme.textSecondary }}>å‰µä½œå…¨èˆ¬ã®ãƒ¡ãƒ¢</span>
                  <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                    {!checkboxMode ? (
                      <>
                        <button onClick={() => {
                          const newCollapsed = {};
                          filteredStickies.forEach(s => { newCollapsed[s.id] = !allCollapsed; });
                          setCollapsedStickies(prev => ({ ...prev, ...newCollapsed }));
                        }} style={{ padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer', fontSize: '9px' }}>
                          {allCollapsed ? 'ğŸ“‚ å…¨é–‹ã' : 'ğŸ“ å…¨é–‰ã˜ã‚‹'}
                        </button>
                        <button onClick={() => setCheckboxMode(true)} style={{ padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer', fontSize: '9px' }}>
                          â˜‘ï¸ é¸æŠ
                        </button>
                        <button onClick={() => {
                          const newSticky = { id: `sticky-${Date.now()}`, content: '', color: stickyColors[stickies.length % stickyColors.length], createdAt: new Date().toISOString() };
                          setData({ ...data, creative: { ...creative, stickies: [newSticky, ...stickies] } });
                        }} style={{ padding: '4px 10px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> è¿½åŠ </button>
                      </>
                    ) : (
                      <>
                        <button onClick={() => {
                          if (selectedStickies.length > 0 && confirm(`${selectedStickies.length}å€‹ã®ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            setData({ ...data, creative: { ...creative, stickies: stickies.filter(s => !selectedStickies.includes(s.id)) } });
                            setSelectedStickies([]);
                          }
                        }} disabled={selectedStickies.length === 0} style={{ padding: '4px 8px', background: selectedStickies.length > 0 ? theme.error : theme.bgTertiary, color: selectedStickies.length > 0 ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: selectedStickies.length > 0 ? 'pointer' : 'not-allowed', fontSize: '9px' }}>
                          ğŸ—‘ï¸ å‰Šé™¤ ({selectedStickies.length})
                        </button>
                        <button onClick={() => { setCheckboxMode(false); setSelectedStickies([]); }} style={{ padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer', fontSize: '9px' }}>
                          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                      </>
                    )}
                  </div>
                </div>
                
                {/* è‰²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                <div style={{ padding: '6px 10px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '4px', alignItems: 'center', flexWrap: 'wrap' }}>
                  <span style={{ fontSize: '9px', color: theme.textSecondary }}>è‰²:</span>
                  <button onClick={() => setStickyColorFilter('all')} style={{ padding: '2px 8px', fontSize: '9px', background: stickyColorFilter === 'all' ? theme.accent : theme.bgTertiary, color: stickyColorFilter === 'all' ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>All</button>
                  {stickyColors.map(color => {
                    const count = stickies.filter(s => s.color === color).length;
                    if (count === 0) return null;
                    return (
                      <button key={color} onClick={() => setStickyColorFilter(color)} style={{ padding: '2px 8px', fontSize: '9px', background: stickyColorFilter === color ? color : theme.bgTertiary, color: stickyColorFilter === color ? '#333' : theme.textSecondary, border: stickyColorFilter === color ? '2px solid #333' : `1px solid ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>
                        {colorNames[color] || 'â—'} ({count})
                      </button>
                    );
                  })}
                </div>
                
                {/* ä»˜ç®‹ä¸€è¦§ */}
                <div style={{ flex: 1, overflow: 'auto', padding: '8px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {filteredStickies.map(sticky => {
                    const isCollapsed = collapsedStickies[sticky.id];
                    const isSelected = selectedStickies.includes(sticky.id);
                    return (
                      <div key={sticky.id} style={{ background: sticky.color, borderRadius: '8px', padding: isCollapsed ? '8px 12px' : '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', position: 'relative', border: isSelected ? '3px solid #333' : 'none' }}>
                        {checkboxMode && (
                          <input 
                            type="checkbox" 
                            checked={isSelected}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedStickies(prev => [...prev, sticky.id]);
                              } else {
                                setSelectedStickies(prev => prev.filter(id => id !== sticky.id));
                              }
                            }}
                            style={{ position: 'absolute', top: '8px', right: '8px', width: '18px', height: '18px', cursor: 'pointer' }}
                          />
                        )}
                        {isCollapsed ? (
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }} onClick={() => setCollapsedStickies(prev => ({ ...prev, [sticky.id]: false }))}>
                            <span style={{ color: '#333', fontSize: '12px' }}>â–¶</span>
                            <span style={{ flex: 1, fontSize: '11px', color: '#333', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                              {sticky.content ? sticky.content.substring(0, 30) + (sticky.content.length > 30 ? '...' : '') : '(ç©º)'}
                            </span>
                            <button 
                              onClick={(e) => { e.stopPropagation(); if (confirm('ã“ã®ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) setData({ ...data, creative: { ...creative, stickies: stickies.filter(s => s.id !== sticky.id) } }); }}
                              style={{ padding: '2px 6px', fontSize: '9px', background: 'rgba(0,0,0,0.2)', color: '#333', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                            >ğŸ—‘ï¸</button>
                          </div>
                        ) : (
                          <>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                              <span style={{ color: '#333', fontSize: '12px', cursor: 'pointer' }} onClick={() => setCollapsedStickies(prev => ({ ...prev, [sticky.id]: true }))}>â–¼ æŠ˜ã‚ŠãŸãŸã‚€</span>
                            </div>
                            <textarea 
                              value={sticky.content} 
                              onChange={(e) => {
                                const newStickies = stickies.map(s => s.id === sticky.id ? { ...s, content: e.target.value } : s);
                                setData({ ...data, creative: { ...creative, stickies: newStickies } });
                                autoResize(e.target);
                              }}
                              ref={(el) => el && autoResize(el)}
                              placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
                              style={{ width: '100%', minHeight: '60px', background: 'rgba(255,255,255,0.3)', border: 'none', borderRadius: '4px', padding: '8px', fontSize: '12px', lineHeight: '1.6', color: '#333', resize: 'none', outline: 'none', fontFamily: '"Noto Sans JP", sans-serif', overflow: 'hidden' }}
                            />
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '8px' }}>
                              <div style={{ display: 'flex', gap: '4px' }}>
                                {stickyColors.map(color => (
                                  <button 
                                    key={color}
                                    onClick={() => {
                                      const newStickies = stickies.map(s => s.id === sticky.id ? { ...s, color } : s);
                                      setData({ ...data, creative: { ...creative, stickies: newStickies } });
                                    }}
                                    style={{ width: '16px', height: '16px', background: color, border: sticky.color === color ? '2px solid #333' : '1px solid rgba(0,0,0,0.2)', borderRadius: '50%', cursor: 'pointer' }}
                                  />
                                ))}
                              </div>
                              <button 
                                onClick={() => {
                                  if (confirm('ã“ã®ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                    setData({ ...data, creative: { ...creative, stickies: stickies.filter(s => s.id !== sticky.id) } });
                                  }
                                }}
                                style={{ padding: '2px 6px', fontSize: '9px', background: 'rgba(0,0,0,0.2)', color: '#333', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                              >ğŸ—‘ï¸</button>
                            </div>
                          </>
                        )}
                      </div>
                    );
                  })}
                  {filteredStickies.length === 0 && (
                    <div style={{ textAlign: 'center', color: theme.textSecondary, padding: '40px 20px', fontSize: '12px' }}>
                      {stickyColorFilter === 'all' ? 'ä»˜ç®‹ãŒã‚ã‚Šã¾ã›ã‚“' : 'ã“ã®è‰²ã®ä»˜ç®‹ã¯ã‚ã‚Šã¾ã›ã‚“'}<br/>ã€Œ+ è¿½åŠ ã€ã§ä½œæˆã—ã¦ã­
                    </div>
                  )}
                </div>
              </div>
            );
          })()}
        </div>
      );
    };

    // ==================== åˆ†å‰²ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒšã‚¤ãƒ³ç”¨ï¼‰ ====================
    const SplitEditor = React.memo(({ pane, onUpdate, theme, data, setData, scrollPositions }) => {
      const [showIdeaTagSelector, setShowIdeaTagSelector] = useState(false);
      const [showReplace, setShowReplace] = useState(false);
      const [searchText, setSearchText] = useState('');
      const [replaceText, setReplaceText] = useState('');
      const [showHighlights, setShowHighlights] = useState(false);
      const [selectedText, setSelectedText] = useState('');
      const [selectionPos, setSelectionPos] = useState(null);
      const [newHighlightNote, setNewHighlightNote] = useState('');
      const [showAddHighlight, setShowAddHighlight] = useState(false);
      const [highlightColor, setHighlightColor] = useState('#FFEB3B');
      const [showSceneProgress, setShowSceneProgress] = useState(false);
      const [highlightCheckboxMode, setHighlightCheckboxMode] = useState(false);
      const [selectedHighlights, setSelectedHighlights] = useState([]);
      const textareaRef = useRef(null);

      // ã‚·ãƒ¼ãƒ³æ¤œå‡ºï¼ˆ### ã‚·ãƒ¼ãƒ³å å½¢å¼ï¼‰
      const detectScenes = (content) => {
        if (!content) return [];
        const lines = content.split('\n');
        const scenes = [];
        let currentScene = null;
        let charCount = 0;
        
        lines.forEach((line, idx) => {
          const sceneMatch = line.match(/^###\s+(.+)$/);
          if (sceneMatch) {
            if (currentScene) {
              currentScene.charCount = charCount;
              scenes.push(currentScene);
            }
            currentScene = {
              id: `scene-${scenes.length}`,
              name: sceneMatch[1].trim(),
              lineIndex: idx
            };
            charCount = 0;
          } else if (currentScene) {
            charCount += line.replace(/\s/g, '').length;
          }
        });
        
        if (currentScene) {
          currentScene.charCount = charCount;
          scenes.push(currentScene);
        }
        
        return scenes;
      };

      // ã‚·ãƒ¼ãƒ³é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const getSceneProgress = () => {
        if (!pane.projectId || !pane.status) return {};
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.sceneProgress || {};
      };

      // ã‚·ãƒ¼ãƒ³é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆè©±ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚è‡ªå‹•æ›´æ–°ï¼‰
      const updateSceneProgress = (sceneId, field, value) => {
        if (!pane.projectId || !pane.status) return;
        const scenes = detectScenes(pane.content);
        
        const updatedProjects = data.creative[pane.status].map(p => {
          if (p.id === pane.projectId) {
            return {
              ...p,
              items: p.items.map(item => {
                if (item.id === pane.id) {
                  const newSceneProgress = {
                    ...item.sceneProgress,
                    [sceneId]: {
                      ...(item.sceneProgress?.[sceneId] || {}),
                      [field]: value
                    }
                  };
                  
                  // å…¨ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ©ãƒ•ãƒˆ/åŸç¨¿å®Œäº†çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                  const allDraftDone = scenes.length > 0 && scenes.every(s => newSceneProgress[s.id]?.draft);
                  const allManuscriptDone = scenes.length > 0 && scenes.every(s => newSceneProgress[s.id]?.manuscript);
                  
                  // è©±ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è‡ªå‹•æ›´æ–°
                  let newProgress = 'none';
                  if (allManuscriptDone) {
                    newProgress = 'completed';
                  } else if (allDraftDone) {
                    newProgress = 'draft_done';
                  }
                  
                  return { ...item, sceneProgress: newSceneProgress, progress: newProgress };
                }
                return item;
              })
            };
          }
          return p;
        });
        setData({ ...data, creative: { ...data.creative, [pane.status]: updatedProjects } });
      };

      const scenes = detectScenes(pane.content);
      const sceneProgress = getSceneProgress();

      // ã‚·ãƒ¼ãƒ³ã¸ã‚¸ãƒ£ãƒ³ãƒ—
      const jumpToScene = (scene) => {
        if (!textareaRef.current) return;
        const lines = (pane.content || '').split('\n');
        let charPos = 0;
        for (let i = 0; i < scene.lineIndex; i++) {
          charPos += lines[i].length + 1;
        }
        textareaRef.current.focus();
        textareaRef.current.setSelectionRange(charPos, charPos);
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´
        const lineHeight = 20;
        textareaRef.current.scrollTop = scene.lineIndex * lineHeight - 50;
      };

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
      const getHighlights = () => {
        if (!pane.projectId || !pane.status) return [];
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.highlights || [];
      };

      const setHighlights = (newHighlights) => {
        if (!pane.projectId || !pane.status) return;
        const updatedProjects = data.creative[pane.status].map(p => {
          if (p.id === pane.projectId) {
            return {
              ...p,
              items: p.items.map(item => 
                item.id === pane.id ? { ...item, highlights: newHighlights } : item
              )
            };
          }
          return p;
        });
        setData({ ...data, creative: { ...data.creative, [pane.status]: updatedProjects } });
      };

      const highlights = getHighlights();

      // è©±å…¨ä½“ã®ãƒ¡ãƒ¢ã‚’å–å¾—ãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
      const getItemNote = () => {
        if (!pane.projectId || !pane.status) return '';
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.note || '';
      };

      const setItemNote = (note) => {
        if (!pane.projectId || !pane.status) return;
        const updatedProjects = data.creative[pane.status].map(p => {
          if (p.id === pane.projectId) {
            return {
              ...p,
              items: p.items.map(item => 
                item.id === pane.id ? { ...item, note } : item
              )
            };
          }
          return p;
        });
        setData({ ...data, creative: { ...data.creative, [pane.status]: updatedProjects } });
      };

      const itemNote = getItemNote();

      // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚ã®å‡¦ç†
      const handleTextSelect = () => {
        if (!textareaRef.current) return;
        const start = textareaRef.current.selectionStart;
        const end = textareaRef.current.selectionEnd;
        const text = textareaRef.current.value.substring(start, end);
        if (text.length > 0) {
          setSelectedText(text);
          setSelectionPos({ start, end });
        } else {
          setSelectedText('');
          setSelectionPos(null);
        }
      };

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¿½åŠ 
      const addHighlight = () => {
        if (!selectedText) return;
        const newHighlight = {
          id: `hl-${Date.now()}`,
          text: selectedText,
          note: newHighlightNote,
          color: highlightColor,
          position: selectionPos,
          createdAt: new Date().toISOString()
        };
        // æœ€æ–°ã®highlightsã‚’å–å¾—ã—ã¦ã‹ã‚‰è¿½åŠ 
        const currentHighlights = getHighlights();
        setHighlights([...currentHighlights, newHighlight]);
        setSelectedText('');
        setSelectionPos(null);
        setNewHighlightNote('');
        setShowAddHighlight(false);
      };

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‰Šé™¤
      const deleteHighlight = (id) => {
        const currentHighlights = getHighlights();
        setHighlights(currentHighlights.filter(h => h.id !== id));
      };

      // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: Ctrl+Shift+P ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ç®‹è¿½åŠ 
      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'P' && pane.type === 'chapter') {
            // ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            if (selectedText && selectedText.length > 0) {
              e.preventDefault();
              e.stopPropagation();
              setShowAddHighlight(true);
            }
          }
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [selectedText, pane.type]);

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆç®‡æ‰€ã«ã‚¸ãƒ£ãƒ³ãƒ—
      const jumpToHighlight = (highlight) => {
        if (!textareaRef.current) return;
        const content = textareaRef.current.value;
        const index = content.indexOf(highlight.text);
        if (index !== -1) {
          textareaRef.current.focus();
          textareaRef.current.setSelectionRange(index, index + highlight.text.length);
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
          const lineHeight = 24;
          const linesBeforeSelection = content.substring(0, index).split('\n').length;
          textareaRef.current.scrollTop = Math.max(0, (linesBeforeSelection - 3) * lineHeight);
        } else {
          alert('è©²å½“ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰');
        }
      };

      // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´æ™‚ï¼ˆè¦ªã«é€šçŸ¥ã®ã¿ï¼‰
      const handleTextChange = (e) => {
        onUpdate(e.target.value);
      };

      const handleReplace = () => {
        if (!searchText || !textareaRef.current) return;
        const content = textareaRef.current.value;
        const newContent = content.split(searchText).join(replaceText);
        textareaRef.current.value = newContent;
        onUpdate(newContent);
      };

      const handleReplaceAll = () => {
        if (!searchText || !textareaRef.current) return;
        const content = textareaRef.current.value;
        const newContent = content.split(searchText).join(replaceText);
        textareaRef.current.value = newContent;
        onUpdate(newContent);
        const count = (content.match(new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
        alert(`${count}ä»¶ã‚’ç½®æ›ã—ã¾ã—ãŸ`);
      };

      // ãƒã‚¿ç·¨é›†
      if (pane.isIdea) {
        const ideas = data.creative.ideas || [];
        const currentIdea = ideas.find(i => i.id === pane.id) || pane;
        const ideaCharCount = (currentIdea.content || '').replace(/[\s\n]/g, '').length;
        
        const updateIdea = (field, value) => {
          const newIdeas = ideas.map(i => i.id === pane.id ? { ...i, [field]: value } : i);
          setData({ ...data, creative: { ...data.creative, ideas: newIdeas } });
        };

        return (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
            <div style={{ padding: '8px 12px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '8px', background: theme.bgSecondary }}>
              <select value={currentIdea.status} onChange={(e) => updateIdea('status', e.target.value)} style={{ padding: '4px 8px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, fontSize: '11px' }}>
                <option value="unused">æœªä½¿ç”¨</option>
                <option value="tweeted">ãƒ„ã‚¤ãƒãƒ™</option>
                <option value="posted">æŠ•ç¨¿æ¸ˆ</option>
                <option value="used">ä½¿ç”¨æ¸ˆ</option>
              </select>
              <div style={{ flex: 1 }} />
              <span style={{ 
                fontSize: '12px', 
                fontWeight: '600',
                color: ideaCharCount >= 900 && ideaCharCount <= 1100 ? theme.success : ideaCharCount > 1100 ? theme.error : theme.textSecondary
              }}>
                {ideaCharCount.toLocaleString()} å­—
                {ideaCharCount >= 900 && ideaCharCount <= 1100 && ' âœ“'}
                {ideaCharCount > 1100 && ' (é•·ã‚)'}
              </span>
              <span style={{ fontSize: '10px', color: theme.textSecondary }}>ç›®å®‰: 1,000å­—</span>
            </div>
            <textarea value={currentIdea.content || ''} onChange={(e) => { updateIdea('content', e.target.value); onUpdate(e.target.value); }} placeholder="ãƒã‚¿ã®è©³ç´°..." style={{ flex: 1, padding: '16px', background: theme.bg, border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
          </div>
        );
      }

      // ä¿ç•™ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†
      if (pane.isHoldItem) {
        const holdItems = data.creative.holdItems || [];
        const currentItem = holdItems.find(i => i.id === pane.id) || pane;
        
        return (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
            <textarea value={currentItem.content || ''} onChange={(e) => onUpdate(e.target.value)} placeholder="ã“ã“ã«åŸ·ç­†..." style={{ flex: 1, padding: '16px', background: theme.bg, border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
          </div>
        );
      }

      // é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†
      const charCount = (pane.content || '').replace(/[\s\n]/g, '').length;

      return (
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          {pane.type === 'chapter' && (
            <div style={{ padding: '6px 12px', borderBottom: `1px solid ${theme.border}`, fontSize: '11px', color: theme.textSecondary, background: theme.bgSecondary, display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px', flexWrap: 'wrap' }}>
              <span><span style={{ color: theme.accent, fontWeight: '600' }}>{charCount.toLocaleString()}</span> å­—</span>
              <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>
                {selectedText && (
                  <button onClick={() => setShowAddHighlight(true)} style={{ padding: '2px 8px', fontSize: '10px', background: '#FFEB3B', color: '#333', border: 'none', borderRadius: '3px', cursor: 'pointer' }}>ğŸ“Œ é¸æŠéƒ¨åˆ†ã«ä»˜ç®‹</button>
                )}
                {scenes.length > 0 && (
                  <button onClick={() => setShowSceneProgress(!showSceneProgress)} style={{ padding: '2px 8px', fontSize: '10px', background: showSceneProgress ? '#9c27b0' : theme.bgTertiary, color: showSceneProgress ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}>
                    ğŸ“Š ã‚·ãƒ¼ãƒ³ ({scenes.filter(s => sceneProgress[s.id]?.draft).length}/{scenes.length})
                  </button>
                )}
                <button onClick={() => setShowHighlights(!showHighlights)} style={{ padding: '2px 8px', fontSize: '10px', background: showHighlights ? theme.accent : theme.bgTertiary, color: showHighlights ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}>
                  ğŸ“ ãƒ¡ãƒ¢ {highlights.length > 0 || itemNote ? `(${highlights.length}${itemNote ? '+1' : ''})` : ''}
                </button>
                <button onClick={() => setShowReplace(!showReplace)} style={{ padding: '2px 8px', fontSize: '10px', background: showReplace ? theme.accent : theme.bgTertiary, color: showReplace ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: 'pointer' }}>ğŸ” ç½®æ›</button>
              </div>
            </div>
          )}
          {/* ã‚·ãƒ¼ãƒ³é€²æ—ãƒ‘ãƒãƒ« */}
          {showSceneProgress && scenes.length > 0 && pane.type === 'chapter' && (
            <div style={{ padding: '12px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary, maxHeight: '200px', overflow: 'auto' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                <span style={{ fontSize: '12px', fontWeight: '600', color: theme.text }}>ğŸ“Š ã‚·ãƒ¼ãƒ³é€²æ—</span>
                <div style={{ display: 'flex', gap: '8px', fontSize: '10px' }}>
                  <span style={{ color: '#2196f3' }}>ãƒ‰ãƒ©ãƒ•ãƒˆ {scenes.filter(s => sceneProgress[s.id]?.draft).length}/{scenes.length}</span>
                  <span style={{ color: '#4caf50' }}>åŸç¨¿ {scenes.filter(s => sceneProgress[s.id]?.manuscript).length}/{scenes.length}</span>
                </div>
              </div>
              {scenes.map((scene, idx) => (
                <div 
                  key={scene.id} 
                  style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: '8px', 
                    marginBottom: '4px', 
                    background: theme.bgTertiary, 
                    borderRadius: '6px',
                    borderLeft: `3px solid ${sceneProgress[scene.id]?.manuscript ? '#4caf50' : sceneProgress[scene.id]?.draft ? '#2196f3' : theme.border}`
                  }}
                >
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div 
                      style={{ fontSize: '11px', fontWeight: '500', color: theme.text, cursor: 'pointer', marginBottom: '2px' }}
                      onClick={() => jumpToScene(scene)}
                      title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—"
                    >
                      {scene.name}
                    </div>
                    <div style={{ fontSize: '9px', color: theme.textSecondary }}>
                      {scene.charCount.toLocaleString()} å­—
                    </div>
                  </div>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', fontSize: '9px', color: '#2196f3' }}>
                    <input 
                      type="checkbox" 
                      checked={sceneProgress[scene.id]?.draft || false}
                      onChange={(e) => updateSceneProgress(scene.id, 'draft', e.target.checked)}
                      style={{ width: '14px', height: '14px', accentColor: '#2196f3' }}
                    />
                    ãƒ‰ãƒ©ãƒ•ãƒˆ
                  </label>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', fontSize: '9px', color: '#4caf50' }}>
                    <input 
                      type="checkbox" 
                      checked={sceneProgress[scene.id]?.manuscript || false}
                      onChange={(e) => updateSceneProgress(scene.id, 'manuscript', e.target.checked)}
                      style={{ width: '14px', height: '14px', accentColor: '#4caf50' }}
                    />
                    åŸç¨¿
                  </label>
                </div>
              ))}
              <div style={{ fontSize: '9px', color: theme.textSecondary, marginTop: '8px', padding: '4px' }}>
                ğŸ’¡ åŸç¨¿ã« <code style={{ background: theme.bgTertiary, padding: '1px 4px', borderRadius: '2px' }}>### ã‚·ãƒ¼ãƒ³å</code> ã¨æ›¸ãã¨è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™
              </div>
            </div>
          )}
          {showReplace && pane.type === 'chapter' && (
            <div style={{ padding: '8px 12px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary, display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap' }}>
              <input type="text" value={searchText} onChange={(e) => setSearchText(e.target.value)} placeholder="æ¤œç´¢..." style={{ flex: 1, minWidth: '80px', padding: '4px 8px', fontSize: '11px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, outline: 'none' }} />
              <span style={{ color: theme.textSecondary }}>â†’</span>
              <input type="text" value={replaceText} onChange={(e) => setReplaceText(e.target.value)} placeholder="ç½®æ›..." style={{ flex: 1, minWidth: '80px', padding: '4px 8px', fontSize: '11px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, outline: 'none' }} />
              <button onClick={handleReplaceAll} style={{ padding: '4px 10px', fontSize: '10px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>å…¨ç½®æ›</button>
            </div>
          )}
          {/* ä»˜ç®‹è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showAddHighlight && selectedText && (
            <div style={{ padding: '12px', borderBottom: `1px solid ${theme.border}`, background: highlightColor }}>
              <div style={{ marginBottom: '8px', fontSize: '11px', color: '#333' }}>
                <strong>é¸æŠãƒ†ã‚­ã‚¹ãƒˆ:</strong> "{selectedText.substring(0, 50)}{selectedText.length > 50 ? '...' : ''}"
              </div>
              <textarea 
                value={newHighlightNote}
                onChange={(e) => setNewHighlightNote(e.target.value)}
                placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰..."
                style={{ width: '100%', minHeight: '50px', padding: '8px', background: 'rgba(255,255,255,0.5)', border: 'none', borderRadius: '4px', fontSize: '12px', color: '#333', resize: 'none', outline: 'none', marginBottom: '8px' }}
              />
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', gap: '4px' }}>
                  {(data.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0']).map(color => (
                    <button 
                      key={color}
                      onClick={() => setHighlightColor(color)}
                      style={{ width: '20px', height: '20px', background: color, border: highlightColor === color ? '2px solid #333' : '1px solid rgba(0,0,0,0.2)', borderRadius: '50%', cursor: 'pointer' }}
                    />
                  ))}
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button onClick={() => { setShowAddHighlight(false); setNewHighlightNote(''); }} style={{ padding: '4px 12px', fontSize: '11px', background: 'rgba(0,0,0,0.2)', color: '#333', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  <button onClick={addHighlight} style={{ padding: '4px 12px', fontSize: '11px', background: '#333', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>ğŸ“Œ è¿½åŠ </button>
                </div>
              </div>
            </div>
          )}
          {pane.type === 'memo' ? (
            <div style={{ flex: 1, overflow: 'auto' }}>
              <OutlineEditor content={pane.content || ''} onChange={onUpdate} theme={theme} />
            </div>
          ) : (
            <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
              {/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */}
              <textarea 
                ref={textareaRef} 
                key={pane.id}
                defaultValue={pane.content || ''} 
                onChange={handleTextChange} 
                onSelect={handleTextSelect}
                onMouseUp={handleTextSelect}
                onKeyUp={handleTextSelect}
                placeholder="ã“ã“ã«åŸ·ç­†..." 
                style={{ flex: 1, padding: '16px', background: theme.bg, border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} 
              />
              {/* ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ç®‹ãƒ‘ãƒãƒ« */}
              {showHighlights && pane.type === 'chapter' && (
                <div style={{ width: '220px', borderLeft: `1px solid ${theme.border}`, background: theme.bgSecondary, overflow: 'auto', flexShrink: 0 }}>
                  {/* è©±å…¨ä½“ã®ãƒ¡ãƒ¢ */}
                  <div style={{ padding: '8px 12px', borderBottom: `1px solid ${theme.border}`, fontSize: '11px', fontWeight: '600', color: theme.textSecondary }}>
                    ğŸ“ ã“ã®è©±ã®ãƒ¡ãƒ¢
                  </div>
                  <div style={{ padding: '8px' }}>
                    <textarea 
                      defaultValue={itemNote}
                      onChange={(e) => setItemNote(e.target.value)}
                      placeholder="ã“ã®è©±å…¨ä½“ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢..."
                      style={{ 
                        width: '100%', 
                        minHeight: '60px', 
                        padding: '8px', 
                        background: theme.bgTertiary, 
                        border: `1px solid ${theme.border}`, 
                        borderRadius: '6px', 
                        fontSize: '11px', 
                        color: theme.text, 
                        resize: 'vertical', 
                        outline: 'none',
                        fontFamily: '"Noto Serif JP", serif',
                        lineHeight: '1.6'
                      }}
                    />
                  </div>
                  {/* ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ç®‹ */}
                  <div style={{ padding: '8px 12px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '4px' }}>
                    <span style={{ fontSize: '11px', fontWeight: '600', color: theme.textSecondary }}>ğŸ“Œ ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ç®‹</span>
                    {highlights.length > 0 && (
                      <div style={{ display: 'flex', gap: '4px' }}>
                        {!highlightCheckboxMode ? (
                          <button onClick={() => setHighlightCheckboxMode(true)} style={{ padding: '2px 6px', fontSize: '9px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }}>
                            â˜‘ï¸
                          </button>
                        ) : (
                          <>
                            <button onClick={() => {
                              if (selectedHighlights.length > 0 && confirm(`${selectedHighlights.length}å€‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                const currentHighlights = getHighlights();
                                setHighlights(currentHighlights.filter(h => !selectedHighlights.includes(h.id)));
                                setSelectedHighlights([]);
                              }
                            }} disabled={selectedHighlights.length === 0} style={{ padding: '2px 6px', fontSize: '9px', background: selectedHighlights.length > 0 ? theme.error : theme.bgTertiary, color: selectedHighlights.length > 0 ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '3px', cursor: selectedHighlights.length > 0 ? 'pointer' : 'not-allowed' }}>
                              ğŸ—‘ï¸ ({selectedHighlights.length})
                            </button>
                            <button onClick={() => { setHighlightCheckboxMode(false); setSelectedHighlights([]); }} style={{ padding: '2px 6px', fontSize: '9px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '3px', cursor: 'pointer' }}>
                              Ã—
                            </button>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                  <div style={{ padding: '8px' }}>
                    {highlights.length === 0 ? (
                      <div style={{ padding: '12px', textAlign: 'center', fontSize: '10px', color: theme.textSecondary }}>
                        ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦<br/>ã€ŒğŸ“Œ é¸æŠéƒ¨åˆ†ã«ä»˜ç®‹ã€ã§è¿½åŠ 
                      </div>
                    ) : (
                      highlights.map(hl => {
                        const isSelected = selectedHighlights.includes(hl.id);
                        return (
                        <div 
                          key={hl.id} 
                          style={{ 
                            background: hl.color, 
                            borderRadius: '6px', 
                            padding: '8px', 
                            marginBottom: '6px', 
                            cursor: highlightCheckboxMode ? 'default' : 'pointer',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                            border: isSelected ? '3px solid #333' : 'none',
                            position: 'relative'
                          }}
                          onClick={() => !highlightCheckboxMode && jumpToHighlight(hl)}
                        >
                          {highlightCheckboxMode && (
                            <input 
                              type="checkbox" 
                              checked={isSelected}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setSelectedHighlights(prev => [...prev, hl.id]);
                                } else {
                                  setSelectedHighlights(prev => prev.filter(id => id !== hl.id));
                                }
                              }}
                              onClick={(e) => e.stopPropagation()}
                              style={{ position: 'absolute', top: '6px', right: '6px', width: '16px', height: '16px', cursor: 'pointer' }}
                            />
                          )}
                          <div style={{ fontSize: '10px', color: '#333', marginBottom: '4px', fontStyle: 'italic', borderLeft: '2px solid #333', paddingLeft: '6px' }}>
                            "{hl.text.substring(0, 30)}{hl.text.length > 30 ? '...' : ''}"
                          </div>
                          {hl.note && (
                            <div style={{ fontSize: '11px', color: '#333', marginTop: '4px' }}>
                              {hl.note}
                            </div>
                          )}
                          {!highlightCheckboxMode && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '6px' }}>
                              <span style={{ fontSize: '9px', color: 'rgba(0,0,0,0.5)' }}>ã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—</span>
                              <button 
                                onClick={(e) => { e.stopPropagation(); deleteHighlight(hl.id); }}
                                style={{ padding: '2px 6px', fontSize: '9px', background: 'rgba(0,0,0,0.2)', color: '#333', border: 'none', borderRadius: '3px', cursor: 'pointer' }}
                              >ğŸ—‘ï¸</button>
                            </div>
                          )}
                        </div>
                      );
                      })
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }, (prevProps, nextProps) => {
      // pane.idã¨contentãŒåŒã˜ã§ã€ã‹ã¤ã‚·ãƒ¼ãƒ³é€²æ—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ãƒ¡ãƒ¢ã‚‚åŒã˜ãªã‚‰å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„
      if (prevProps.pane.id !== nextProps.pane.id) return false;
      if (prevProps.pane.content !== nextProps.pane.content) return false;
      
      // ã‚·ãƒ¼ãƒ³é€²æ—ã®æ¯”è¼ƒï¼ˆdataã‹ã‚‰å–å¾—ï¼‰
      const getSceneProgress = (props) => {
        const { pane, data } = props;
        if (!pane.projectId || !pane.status) return null;
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.sceneProgress;
      };
      const prevSP = getSceneProgress(prevProps);
      const nextSP = getSceneProgress(nextProps);
      if (JSON.stringify(prevSP) !== JSON.stringify(nextSP)) return false;
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®æ¯”è¼ƒ
      const getHighlights = (props) => {
        const { pane, data } = props;
        if (!pane.projectId || !pane.status) return [];
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.highlights || [];
      };
      const prevHighlights = getHighlights(prevProps);
      const nextHighlights = getHighlights(nextProps);
      if (JSON.stringify(prevHighlights) !== JSON.stringify(nextHighlights)) return false;
      
      // ãƒ¡ãƒ¢ã®æ¯”è¼ƒ
      const getNote = (props) => {
        const { pane, data } = props;
        if (!pane.projectId || !pane.status) return '';
        const project = data.creative[pane.status]?.find(p => p.id === pane.projectId);
        const item = project?.items?.find(i => i.id === pane.id);
        return item?.note || '';
      };
      const prevNote = getNote(prevProps);
      const nextNote = getNote(nextProps);
      if (prevNote !== nextNote) return false;
      
      return true;
    });

    // ==================== ã‚¨ãƒ‡ã‚£ã‚¿ ====================
    const Editor = ({ item, onUpdate, theme, data, setData }) => {
      const [showPreview, setShowPreview] = useState(false);
      const [showIdeaTagSelector, setShowIdeaTagSelector] = useState(false);

      if (!item) return <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary }}>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã­</div>;

      // ãƒã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
      if (item.isIdea) {
        const ideas = data.creative.ideas || [];
        const currentIdea = ideas.find(i => i.id === item.id) || item;
        const ideaCharCount = (currentIdea.content || '').replace(/[\s\n]/g, '').length;
        
        const updateIdea = (field, value) => {
          const newIdeas = ideas.map(i => i.id === item.id ? { ...i, [field]: value } : i);
          setData({ ...data, creative: { ...data.creative, ideas: newIdeas } });
        };

        const addTagToIdea = (tag) => {
          if (!(currentIdea.tags || []).includes(tag)) {
            updateIdea('tags', [...(currentIdea.tags || []), tag]);
          }
        };

        const removeTagFromIdea = (tag) => {
          updateIdea('tags', (currentIdea.tags || []).filter(t => t !== tag));
        };

        const statusLabels = { unused: 'æœªä½¿ç”¨', tweeted: 'ãƒ„ã‚¤ãƒãƒ™', posted: 'æŠ•ç¨¿æ¸ˆ', used: 'ä½¿ç”¨æ¸ˆ' };

        return (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }} onClick={() => setShowIdeaTagSelector(false)}>
            <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '12px', background: theme.bgSecondary }}>
              <Icons.Lightbulb />
              <span style={{ fontSize: '15px', fontWeight: '500' }}>{currentIdea.title}</span>
              <div style={{ flex: 1 }} />
              <select value={currentIdea.status} onChange={(e) => updateIdea('status', e.target.value)} style={{ padding: '6px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '12px' }}>
                <option value="unused">æœªä½¿ç”¨</option>
                <option value="tweeted">ãƒ„ã‚¤ãƒãƒ™</option>
                <option value="posted">æŠ•ç¨¿æ¸ˆ</option>
                <option value="used">ä½¿ç”¨æ¸ˆ</option>
              </select>
            </div>
            {/* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ */}
            <div style={{ padding: '8px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: theme.bgSecondary }}>
              <span style={{ fontSize: '10px', color: theme.textSecondary }}>ç›®å®‰: 1,000å­—</span>
              <span style={{ 
                fontSize: '13px', 
                fontWeight: '600',
                color: ideaCharCount >= 900 && ideaCharCount <= 1100 ? theme.success : ideaCharCount > 1100 ? theme.error : theme.textSecondary
              }}>
                {ideaCharCount.toLocaleString()} å­—
                {ideaCharCount >= 900 && ideaCharCount <= 1100 && ' âœ“'}
                {ideaCharCount > 1100 && ' (é•·ã‚)'}
              </span>
            </div>
            {/* ã‚¿ã‚° */}
            <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap', background: theme.bgSecondary }}>
              <Icons.Tag />
              {(currentIdea.tags || []).map(tag => (
                <span key={tag} style={{ fontSize: '11px', padding: '4px 8px', background: theme.accent, color: '#fff', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                  {tag}
                  <button onClick={() => removeTagFromIdea(tag)} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex' }}><Icons.X /></button>
                </span>
              ))}
              <div style={{ position: 'relative' }} onClick={(e) => e.stopPropagation()}>
                <button onClick={() => setShowIdeaTagSelector(!showIdeaTagSelector)} style={{ fontSize: '11px', padding: '4px 8px', background: theme.bgTertiary, color: theme.textSecondary, border: `1px dashed ${theme.border}`, borderRadius: '4px', cursor: 'pointer' }}>+ ã‚¿ã‚°è¿½åŠ </button>
                {showIdeaTagSelector && (
                  <div style={{ position: 'absolute', top: '100%', left: 0, background: theme.bgSecondary, border: `1px solid ${theme.border}`, borderRadius: '6px', padding: '8px', zIndex: 100, minWidth: '120px', boxShadow: '0 4px 12px rgba(0,0,0,0.2)' }}>
                    {data.tags.filter(t => !(currentIdea.tags || []).includes(t)).map(tag => (
                      <div key={tag} onClick={() => { addTagToIdea(tag); setShowIdeaTagSelector(false); }} style={{ padding: '4px 8px', fontSize: '11px', cursor: 'pointer', borderRadius: '4px', color: theme.text }} onMouseOver={(e) => e.target.style.background = theme.bgTertiary} onMouseOut={(e) => e.target.style.background = 'transparent'}>{tag}</div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <textarea value={currentIdea.content || ''} onChange={(e) => updateIdea('content', e.target.value)} placeholder="ãƒã‚¿ã®è©³ç´°ã‚’å…¥åŠ›...&#10;&#10;ã‚ã‚‰ã™ã˜ã€ã‚­ãƒ£ãƒ©è¨­å®šã€ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©è‡ªç”±ã«æ›¸ã„ã¦ã­" style={{ flex: 1, padding: '20px 24px', background: theme.bg, border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
          </div>
        );
      }

      // é€šå¸¸ã®ä½œå“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
      const charCount = (item.content || '').replace(/[\s\n]/g, '').length;

      const updateContent = (content) => {
        onUpdate(item.id, content);
      };

      return (
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: theme.bgSecondary }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <span style={{ fontSize: '15px', fontWeight: '500' }}>{item.name}</span>
              {item.type === 'chapter' && <span style={{ fontSize: '12px', color: theme.textSecondary }}><span style={{ color: theme.accent, fontWeight: '600' }}>{charCount.toLocaleString()}</span> å­—</span>}
              {item.type === 'memo' && <span style={{ fontSize: '10px', padding: '2px 8px', background: theme.bgTertiary, borderRadius: '4px', color: theme.textSecondary }}>ã‚«ã‚¦ãƒ³ãƒˆå¯¾è±¡å¤–</span>}
            </div>
            <button onClick={() => setShowPreview(true)} style={{ padding: '6px 12px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.Eye /> ç¸¦æ›¸ã</button>
          </div>
          <div style={{ flex: 1, overflow: 'auto', background: theme.bg }}>
            {item.type === 'memo' ? (
              <OutlineEditor content={item.content || ''} onChange={updateContent} theme={theme} />
            ) : (
              <textarea value={item.content || ''} onChange={(e) => updateContent(e.target.value)} placeholder="ã“ã“ã«åŸ·ç­†..." style={{ width: '100%', height: '100%', padding: '24px', background: 'transparent', border: 'none', outline: 'none', resize: 'none', fontSize: '15px', lineHeight: '2', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
            )}
          </div>
          {showPreview && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowPreview(false)}>
              <div style={{ background: theme.bgSecondary, borderRadius: '12px', width: '90%', height: '85%', maxWidth: '900px', overflow: 'hidden', display: 'flex', flexDirection: 'column' }} onClick={(e) => e.stopPropagation()}>
                <div style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '500' }}>ç¸¦æ›¸ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                  <button onClick={() => setShowPreview(false)} style={{ background: 'none', border: 'none', color: theme.text, cursor: 'pointer', padding: '4px' }}><Icons.X /></button>
                </div>
                <div style={{ flex: 1, padding: '40px', overflow: 'auto' }}>
                  <div style={{ writingMode: 'vertical-rl', textOrientation: 'mixed', height: '100%', fontFamily: '"Noto Serif JP", serif', fontSize: '16px', lineHeight: '2.2', color: theme.text, whiteSpace: 'pre-wrap' }}>{item.content || 'ï¼ˆå†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰'}</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== ãƒã‚¿ä¿ç®¡åº«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ====================
    const IdeasSection = ({ data, setData, theme }) => {
      const [selectedIdea, setSelectedIdea] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [filter, setFilter] = useState('all'); // all, unused, posted, used

      const ideas = data.creative.ideas || [];

      const addIdea = () => {
        const newIdea = {
          id: `idea-${Date.now()}`,
          title: 'æ–°ã—ã„ãƒã‚¿',
          content: '',
          tags: [],
          status: 'unused', // unused | posted | used
          createdAt: new Date().toISOString()
        };
        setData({ ...data, creative: { ...data.creative, ideas: [newIdea, ...ideas] } });
        setSelectedIdea(newIdea);
      };

      const updateIdea = (id, field, value) => {
        const newIdeas = ideas.map(i => i.id === id ? { ...i, [field]: value } : i);
        setData({ ...data, creative: { ...data.creative, ideas: newIdeas } });
        if (selectedIdea?.id === id) setSelectedIdea({ ...selectedIdea, [field]: value });
      };

      const deleteIdea = (id) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setData({ ...data, creative: { ...data.creative, ideas: ideas.filter(i => i.id !== id) } });
          if (selectedIdea?.id === id) setSelectedIdea(null);
        }
      };

      const addTagToIdea = (ideaId, tag) => {
        const idea = ideas.find(i => i.id === ideaId);
        if (idea && !idea.tags.includes(tag)) {
          updateIdea(ideaId, 'tags', [...idea.tags, tag]);
        }
      };

      const removeTagFromIdea = (ideaId, tag) => {
        const idea = ideas.find(i => i.id === ideaId);
        if (idea) {
          updateIdea(ideaId, 'tags', idea.tags.filter(t => t !== tag));
        }
      };

      const filteredIdeas = ideas.filter(i => {
        if (filter === 'all') return true;
        return i.status === filter;
      });

      const statusLabels = { unused: 'æœªä½¿ç”¨', tweeted: 'ãƒ„ã‚¤ãƒãƒ™', posted: 'æŠ•ç¨¿æ¸ˆ', used: 'ä½¿ç”¨æ¸ˆ' };
      const statusColors = { unused: theme.accent, tweeted: theme.warning, posted: '#9b59b6', used: theme.success };

      return (
        <div style={{ display: 'flex', height: '100%' }}>
          {/* ãƒªã‚¹ãƒˆ */}
          <div style={{ width: '320px', borderRight: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', background: theme.bgSecondary }}>
            <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}` }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                <span style={{ fontWeight: '600' }}>ğŸ’¡ ãƒã‚¿ä¿ç®¡åº«</span>
                <button onClick={addIdea} style={{ padding: '6px 12px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Plus /> è¿½åŠ </button>
              </div>
              <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                {['all', 'unused', 'tweeted', 'posted', 'used'].map(f => {
                  const count = f === 'all' ? ideas.length : ideas.filter(i => i.status === f).length;
                  if (f !== 'all' && count === 0) return null;
                  return (
                  <button key={f} onClick={() => setFilter(f)} style={{ padding: '6px 8px', fontSize: '10px', background: filter === f ? (f === 'all' ? theme.accent : statusColors[f]) : theme.bgTertiary, color: filter === f ? '#fff' : theme.textSecondary, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                    {f === 'all' ? 'ã™ã¹ã¦' : statusLabels[f]} ({count})
                  </button>
                  );
                })}
              </div>
            </div>
            <div style={{ flex: 1, overflow: 'auto', padding: '8px' }}>
              {filteredIdeas.map(idea => {
                const charCount = (idea.content || '').replace(/[\s\n]/g, '').length;
                return (
                <div key={idea.id} onClick={() => setSelectedIdea(idea)} style={{ padding: '12px', marginBottom: '4px', borderRadius: '8px', cursor: 'pointer', background: selectedIdea?.id === idea.id ? theme.highlight : 'transparent', border: `1px solid ${selectedIdea?.id === idea.id ? theme.accent : 'transparent'}` }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                    {editingId === idea.id ? (
                      <input type="text" value={idea.title} onChange={(e) => updateIdea(idea.id, 'title', e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} autoFocus onClick={(e) => e.stopPropagation()} style={{ flex: 1, background: theme.bg, border: `1px solid ${theme.accent}`, borderRadius: '4px', padding: '2px 6px', color: theme.text, fontSize: '13px', outline: 'none' }} />
                    ) : (
                      <span onDoubleClick={(e) => { e.stopPropagation(); setEditingId(idea.id); }} style={{ flex: 1, fontWeight: '500', fontSize: '13px' }}>{idea.title}</span>
                    )}
                    <span style={{ fontSize: '10px', color: charCount >= 900 && charCount <= 1100 ? theme.success : theme.textSecondary, fontWeight: '500' }}>{charCount.toLocaleString()}å­—</span>
                    <span style={{ fontSize: '10px', padding: '2px 6px', background: statusColors[idea.status], color: '#fff', borderRadius: '4px' }}>
                      {statusLabels[idea.status]}
                    </span>
                  </div>
                  {/* ã‚¿ã‚°è¡¨ç¤º */}
                  <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                    {(idea.tags || []).map(tag => (
                      <span key={tag} style={{ fontSize: '10px', padding: '2px 6px', background: theme.bgTertiary, borderRadius: '4px', color: theme.textSecondary }}>{tag}</span>
                    ))}
                  </div>
                  {idea.content && (
                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '6px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                      {idea.content.substring(0, 50)}...
                    </div>
                  )}
                </div>
                );
              })}
              {filteredIdeas.length === 0 && <div style={{ textAlign: 'center', color: theme.textSecondary, padding: '40px 20px', fontSize: '13px' }}>ãƒã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br/>ã€Œ+ è¿½åŠ ã€ã§ä½œæˆã—ã¦ã­</div>}
            </div>
          </div>

          {/* ã‚¨ãƒ‡ã‚£ã‚¿ */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: theme.bg }}>
            {selectedIdea ? (() => {
              const editorCharCount = (selectedIdea.content || '').replace(/[\s\n]/g, '').length;
              return (
              <>
                <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '12px', background: theme.bgSecondary }}>
                  <span style={{ fontWeight: '500', fontSize: '15px' }}>{selectedIdea.title}</span>
                  <div style={{ flex: 1 }} />
                  <select value={selectedIdea.status} onChange={(e) => updateIdea(selectedIdea.id, 'status', e.target.value)} style={{ padding: '6px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '12px' }}>
                    <option value="unused">æœªä½¿ç”¨</option>
                    <option value="tweeted">ãƒ„ã‚¤ãƒãƒ™</option>
                    <option value="posted">æŠ•ç¨¿æ¸ˆ</option>
                    <option value="used">ä½¿ç”¨æ¸ˆ</option>
                  </select>
                  <button onClick={() => deleteIdea(selectedIdea.id)} style={{ padding: '6px 12px', background: theme.error, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>å‰Šé™¤</button>
                </div>
                {/* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ */}
                <div style={{ padding: '8px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: theme.bgSecondary }}>
                  <span style={{ fontSize: '11px', color: theme.textSecondary }}>ç›®å®‰: 1,000å­—</span>
                  <span style={{ 
                    fontSize: '13px', 
                    fontWeight: '600',
                    color: editorCharCount >= 900 && editorCharCount <= 1100 ? theme.success : editorCharCount > 1100 ? theme.error : theme.textSecondary
                  }}>
                    {editorCharCount.toLocaleString()} å­—
                    {editorCharCount >= 900 && editorCharCount <= 1100 && ' âœ“'}
                    {editorCharCount > 1100 && ' (é•·ã‚)'}
                  </span>
                </div>
                {/* ã‚¿ã‚° */}
                <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap', background: theme.bgSecondary }}>
                  <Icons.Tag />
                  {(selectedIdea.tags || []).map(tag => (
                    <span key={tag} style={{ fontSize: '11px', padding: '4px 8px', background: theme.accent, color: '#fff', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                      {tag}
                      <button onClick={() => removeTagFromIdea(selectedIdea.id, tag)} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex' }}><Icons.X /></button>
                    </span>
                  ))}
                  <select value="" onChange={(e) => { if (e.target.value) addTagToIdea(selectedIdea.id, e.target.value); }} style={{ padding: '4px 8px', fontSize: '11px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '4px', color: theme.text, cursor: 'pointer' }}>
                    <option value="">+ ã‚¿ã‚°è¿½åŠ </option>
                    {data.tags.filter(t => !(selectedIdea.tags || []).includes(t)).map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
                <textarea value={selectedIdea.content || ''} onChange={(e) => updateIdea(selectedIdea.id, 'content', e.target.value)} placeholder="ãƒã‚¿ã®è©³ç´°ã‚’å…¥åŠ›...&#10;&#10;ã‚ã‚‰ã™ã˜ã€ã‚­ãƒ£ãƒ©è¨­å®šã€ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©è‡ªç”±ã«æ›¸ã„ã¦ã­" style={{ flex: 1, padding: '20px 24px', background: 'transparent', border: 'none', outline: 'none', resize: 'none', fontSize: '14px', lineHeight: '1.8', color: theme.text, fontFamily: '"Noto Serif JP", serif' }} />
              </>
              );
            })() : (
              <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary }}>ãƒã‚¿ã‚’é¸æŠã—ã¦ã­</div>
            )}
          </div>
        </div>
      );
    };

    // ==================== è¨­å®šç”»é¢ ====================
    const SettingsScreen = ({ data, setData, theme, syncSettings, setSyncSettings, onSaveToGist, onLoadFromGist, syncStatus }) => {
      const inputTags = data.inputTags || ['å°èª¬', 'æ¼«ç”»', 'Audible', 'æ˜ ç”»', 'ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'YouTube'];
      const dailyTags = data.dailyTags || ['ä»•äº‹', 'è²·ã„ç‰©', 'ã‚¢ã‚¤ãƒ‡ã‚¢', 'æ—¥è¨˜'];
      const [showToken, setShowToken] = useState(false);
      const [showPassword, setShowPassword] = useState(false);
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      
      const handlePasswordChange = async () => {
        if (!newPassword) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (newPassword !== confirmPassword) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
          return;
        }
        if (newPassword.length < 4) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
          return;
        }
        const hash = await CryptoUtils.hashPassword(newPassword);
        setSyncSettings(prev => ({ ...prev, passwordHash: hash, password: newPassword }));
        localStorage.setItem('noteAppPasswordHash', hash);
        // rememberPasswordãŒONãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚‚ä¿å­˜
        if (syncSettings.rememberPassword) {
          localStorage.setItem('noteAppSavedPw', newPassword);
        }
        setNewPassword('');
        setConfirmPassword('');
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸï¼');
      };
      
      return (
        <div style={{ padding: '24px', height: '100%', overflow: 'auto' }}>
          <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '24px', color: theme.text }}>âš™ï¸ è¨­å®š</h2>
          
          {/* ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', marginBottom: '16px', border: `1px solid ${theme.accent}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.Cloud /> ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆGitHub Gistï¼‰</h3>
            <p style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '16px' }}>
              ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ã¦GitHub Gistã«ä¿å­˜ã—ã€è¤‡æ•°ç«¯æœ«ã§åŒæœŸã§ãã¾ã™ã€‚<br/>
              <span style={{ color: theme.accent }}>â€» ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã•ã‚Œã‚‹ã®ã§ã€Gistã‚’è¦‹ã‚‰ã‚Œã¦ã‚‚ä¸­èº«ã¯èª­ã‚ã¾ã›ã‚“</span>
            </p>
            
            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š */}
            <div style={{ background: theme.bg, borderRadius: '8px', padding: '16px', marginBottom: '16px' }}>
              <h4 style={{ fontSize: '13px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.Lock /> æš—å·åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</h4>
              <p style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '12px' }}>
                {syncSettings.passwordHash ? 'âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ¸ˆã¿ï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆã¯ä¸‹ã«å…¥åŠ›ï¼‰' : 'âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®šï¼ˆåŒæœŸã‚’ä½¿ã†ã«ã¯è¨­å®šãŒå¿…è¦ã§ã™ï¼‰'}
              </p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '8px' }}>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                  <div style={{ position: 'relative', flex: 1, minWidth: '140px' }}>
                    <input 
                      type={showPassword ? 'text' : 'password'}
                      value={newPassword}
                      onChange={(e) => setNewPassword(e.target.value)}
                      placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                      style={{ width: '100%', padding: '8px 36px 8px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none', boxSizing: 'border-box' }}
                    />
                    <button onClick={() => setShowPassword(!showPassword)} style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '4px' }}>
                      {showPassword ? <Icons.EyeOff /> : <Icons.Eye />}
                    </button>
                  </div>
                  <input 
                    type={showPassword ? 'text' : 'password'}
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="ç¢ºèªç”¨"
                    style={{ flex: 1, minWidth: '100px', padding: '8px 12px', background: theme.bgTertiary, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none', boxSizing: 'border-box' }}
                  />
                  <button 
                    onClick={handlePasswordChange} 
                    onTouchEnd={(e) => { e.preventDefault(); handlePasswordChange(); }}
                    style={{ padding: '8px 16px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', whiteSpace: 'nowrap', WebkitTapHighlightColor: 'transparent', touchAction: 'manipulation' }}
                  >è¨­å®š</button>
                </div>
              </div>
              <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '11px', color: theme.textSecondary, cursor: 'pointer' }}>
                <input 
                  type="checkbox" 
                  checked={syncSettings.rememberPassword}
                  onChange={(e) => {
                    setSyncSettings(prev => ({ ...prev, rememberPassword: e.target.checked }));
                    if (e.target.checked) {
                      localStorage.setItem('noteAppRememberPw', 'true');
                      // ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ä¿å­˜
                      if (syncSettings.password) {
                        localStorage.setItem('noteAppSavedPw', syncSettings.password);
                      }
                    } else {
                      localStorage.removeItem('noteAppRememberPw');
                      localStorage.removeItem('noteAppSavedPw');
                    }
                  }}
                />
                ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨˜æ†¶ã™ã‚‹ï¼ˆæ¬¡å›èµ·å‹•æ™‚ã«å…¥åŠ›ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼†åŒæœŸæ™‚ã‚‚å…¥åŠ›ä¸è¦ï¼‰
              </label>
            </div>
            
            {/* GitHub Token */}
            <div style={{ marginBottom: '12px' }}>
              <label style={{ fontSize: '12px', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>GitHub Personal Access Token</label>
              <div style={{ display: 'flex', gap: '8px' }}>
                <div style={{ position: 'relative', flex: 1 }}>
                  <input 
                    type={showToken ? 'text' : 'password'}
                    value={syncSettings.githubToken || ''}
                    onChange={(e) => {
                      setSyncSettings(prev => ({ ...prev, githubToken: e.target.value }));
                      localStorage.setItem('noteAppGithubToken', e.target.value);
                    }}
                    onBlur={(e) => {
                      localStorage.setItem('noteAppGithubToken', e.target.value);
                    }}
                    placeholder="ghp_xxxxxxxxxxxx"
                    style={{ width: '100%', padding: '8px 36px 8px 12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '12px', outline: 'none', fontFamily: 'monospace' }}
                  />
                  <button onClick={() => setShowToken(!showToken)} style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer' }}>
                    {showToken ? <Icons.EyeOff /> : <Icons.Eye />}
                  </button>
                </div>
              </div>
              <p style={{ fontSize: '10px', color: theme.textSecondary, marginTop: '4px' }}>
                <a href="https://github.com/settings/tokens/new?scopes=gist&description=NoteApp" target="_blank" rel="noopener" style={{ color: theme.accent }}>ã“ã¡ã‚‰ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ</a>ï¼ˆgist ã‚¹ã‚³ãƒ¼ãƒ—ã®ã¿å¿…è¦ï¼‰
              </p>
            </div>
            
            {/* Gist ID */}
            <div style={{ marginBottom: '16px' }}>
              <label style={{ fontSize: '12px', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>Gist IDï¼ˆåˆå›ä¿å­˜å¾Œã«è‡ªå‹•è¨­å®š / ä»–ç«¯æœ«ã§ä½¿ã†å ´åˆã¯ã‚³ãƒ”ãƒšï¼‰</label>
              <input 
                type="text"
                value={syncSettings.gistId || ''}
                onChange={(e) => {
                  setSyncSettings(prev => ({ ...prev, gistId: e.target.value }));
                  localStorage.setItem('noteAppGistId', e.target.value);
                }}
                onBlur={(e) => {
                  localStorage.setItem('noteAppGistId', e.target.value);
                }}
                placeholder="åˆå›ä¿å­˜æ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™"
                style={{ width: '100%', padding: '8px 12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '12px', outline: 'none', fontFamily: 'monospace' }}
              />
            </div>
            
            {/* è¨­å®šçŠ¶æ…‹ã®ç¢ºèª */}
            <div style={{ marginBottom: '16px', padding: '12px', background: theme.bg, borderRadius: '8px', fontSize: '11px' }}>
              <div style={{ marginBottom: '4px', fontWeight: '600', color: theme.textSecondary }}>è¨­å®šçŠ¶æ…‹:</div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                <span style={{ color: syncSettings.githubToken ? theme.success : theme.error }}>
                  {syncSettings.githubToken ? 'âœ…' : 'âŒ'} GitHubãƒˆãƒ¼ã‚¯ãƒ³
                </span>
                <span style={{ color: syncSettings.gistId ? theme.success : theme.warning }}>
                  {syncSettings.gistId ? 'âœ…' : 'âš ï¸'} Gist ID {!syncSettings.gistId && '(åˆå›ä¿å­˜ã§è‡ªå‹•ç”Ÿæˆ)'}
                </span>
                <span style={{ color: syncSettings.passwordHash ? theme.success : theme.error }}>
                  {syncSettings.passwordHash ? 'âœ…' : 'âŒ'} æš—å·åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                </span>
              </div>
            </div>
            
            {/* åŒæœŸãƒœã‚¿ãƒ³ */}
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              <button 
                onClick={onSaveToGist}
                onTouchEnd={(e) => { e.preventDefault(); onSaveToGist(); }}
                disabled={!syncSettings.githubToken || !syncSettings.passwordHash || syncStatus === 'saving'}
                style={{ 
                  padding: '10px 20px', 
                  background: (!syncSettings.githubToken || !syncSettings.passwordHash) ? theme.bgTertiary : theme.success, 
                  color: (!syncSettings.githubToken || !syncSettings.passwordHash) ? theme.textSecondary : '#fff', 
                  border: 'none', borderRadius: '8px', cursor: (!syncSettings.githubToken || !syncSettings.passwordHash) ? 'not-allowed' : 'pointer', 
                  fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px',
                  opacity: syncStatus === 'saving' ? 0.7 : 1,
                  WebkitTapHighlightColor: 'transparent',
                  touchAction: 'manipulation'
                }}
              >
                <Icons.CloudUpload /> {syncStatus === 'saving' ? 'ä¿å­˜ä¸­...' : 'Gistã«ä¿å­˜'}
              </button>
              <button 
                onClick={() => onLoadFromGist()}
                onTouchEnd={(e) => { e.preventDefault(); onLoadFromGist(); }}
                disabled={!syncSettings.githubToken || !syncSettings.gistId || !syncSettings.passwordHash || syncStatus === 'loading'}
                style={{ 
                  padding: '10px 20px', 
                  background: (!syncSettings.githubToken || !syncSettings.gistId || !syncSettings.passwordHash) ? theme.bgTertiary : theme.accent, 
                  color: (!syncSettings.githubToken || !syncSettings.gistId || !syncSettings.passwordHash) ? theme.textSecondary : '#fff', 
                  border: 'none', borderRadius: '8px', cursor: (!syncSettings.githubToken || !syncSettings.gistId || !syncSettings.passwordHash) ? 'not-allowed' : 'pointer', 
                  fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px',
                  opacity: syncStatus === 'loading' ? 0.7 : 1,
                  WebkitTapHighlightColor: 'transparent',
                  touchAction: 'manipulation'
                }}
              >
                <Icons.CloudDownload /> {syncStatus === 'loading' ? 'èª­ã¿è¾¼ã¿ä¸­...' : 'Gistã‹ã‚‰èª­ã¿è¾¼ã¿'}
              </button>
            </div>
            {syncStatus === 'saved' && <p style={{ fontSize: '11px', color: theme.success, marginTop: '8px' }}>âœ… ä¿å­˜å®Œäº†ï¼</p>}
            {syncStatus === 'loaded' && <p style={{ fontSize: '11px', color: theme.success, marginTop: '8px' }}>âœ… èª­ã¿è¾¼ã¿å®Œäº†ï¼</p>}
            {syncStatus === 'error' && <p style={{ fontSize: '11px', color: theme.error, marginTop: '8px' }}>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>}
          </div>
          
          {/* Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', marginBottom: '16px', border: `1px solid ${theme.border}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.Calendar /> Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŸ‹ã‚è¾¼ã¿</h3>
            <p style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '12px' }}>
              Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ã­ã€‚<br/>
              ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ è¨­å®š â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®çµ±åˆ â†’ åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼‰<br/>
              <span style={{ color: theme.accent }}>â€» ãƒ›ãƒ¼ãƒ ç”»é¢ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆï¼</span>
            </p>
            <textarea 
              value={data.settings.calendarEmbed || ''} 
              onChange={(e) => setData({...data, settings: {...data.settings, calendarEmbed: e.target.value}})}
              placeholder='<iframe src="https://calendar.google.com/..." ...></iframe>'
              style={{ width: '100%', height: '100px', padding: '12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '8px', color: theme.text, fontSize: '12px', resize: 'vertical', outline: 'none', fontFamily: 'monospace' }}
            />
          </div>

          {/* å‰µä½œã‚¿ã‚°ç®¡ç† */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', marginBottom: '16px', border: `1px solid ${theme.border}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.Tag /> å‰µä½œã‚¿ã‚°ç®¡ç†</h3>
            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
              {data.tags.map((tag, i) => (
                <span key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '6px 10px', background: theme.tagColors[i % theme.tagColors.length], color: '#fff', borderRadius: '6px', fontSize: '12px' }}>
                  {tag}
                  <button onClick={() => setData({...data, tags: data.tags.filter(t => t !== tag)})} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex', opacity: 0.8 }}><Icons.X /></button>
                </span>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <input type="text" id="newTagInput" placeholder="æ–°ã—ã„ã‚¿ã‚°..." style={{ flex: 1, padding: '8px 12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none' }} />
              <button onClick={() => {
                const input = document.getElementById('newTagInput');
                if (input.value.trim() && !data.tags.includes(input.value.trim())) {
                  setData({...data, tags: [...data.tags, input.value.trim()]});
                  input.value = '';
                }
              }} style={{ padding: '8px 16px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>è¿½åŠ </button>
            </div>
          </div>

          {/* æ—¥å¸¸ãƒ¡ãƒ¢ã‚¿ã‚°ç®¡ç† */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', marginBottom: '16px', border: `1px solid ${theme.border}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.FileText /> æ—¥å¸¸ãƒ¡ãƒ¢ã‚¿ã‚°ç®¡ç†</h3>
            <p style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '12px' }}>
              æ—¥å¸¸ãƒ¡ãƒ¢ã®åˆ†é¡ã«ä½¿ã†ã‚¿ã‚°ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆ
            </p>
            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
              {dailyTags.map((tag, i) => (
                <span key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '6px 10px', background: theme.success, color: '#fff', borderRadius: '6px', fontSize: '12px' }}>
                  {tag}
                  <button onClick={() => setData({...data, dailyTags: dailyTags.filter(t => t !== tag)})} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex', opacity: 0.8 }}><Icons.X /></button>
                </span>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <input type="text" id="newDailyTagInput" placeholder="æ–°ã—ã„æ—¥å¸¸ã‚¿ã‚°..." style={{ flex: 1, padding: '8px 12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none' }} />
              <button onClick={() => {
                const input = document.getElementById('newDailyTagInput');
                if (input.value.trim() && !dailyTags.includes(input.value.trim())) {
                  setData({...data, dailyTags: [...dailyTags, input.value.trim()]});
                  input.value = '';
                  input.value = '';
                }
              }} style={{ padding: '8px 16px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>è¿½åŠ </button>
            </div>
          </div>

          {/* Inputã‚¿ã‚°ç®¡ç† */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', marginBottom: '16px', border: `1px solid ${theme.border}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.Book /> Inputã‚¿ã‚°ç®¡ç†</h3>
            <p style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '12px' }}>
              èª­æ›¸ãƒ»æ˜ ç”»ãªã©ã®è¨˜éŒ²ã«ä½¿ã†ã‚¿ã‚°ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆ
            </p>
            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
              {inputTags.map((tag, i) => (
                <span key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '6px 10px', background: theme.accentLight, color: '#fff', borderRadius: '6px', fontSize: '12px' }}>
                  {tag}
                  <button onClick={() => setData({...data, inputTags: inputTags.filter(t => t !== tag)})} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: 0, display: 'flex', opacity: 0.8 }}><Icons.X /></button>
                </span>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <input type="text" id="newInputTagInput" placeholder="æ–°ã—ã„Inputã‚¿ã‚°..." style={{ flex: 1, padding: '8px 12px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '6px', color: theme.text, fontSize: '13px', outline: 'none' }} />
              <button onClick={() => {
                const input = document.getElementById('newInputTagInput');
                if (input.value.trim() && !inputTags.includes(input.value.trim())) {
                  setData({...data, inputTags: [...inputTags, input.value.trim()]});
                  input.value = '';
                }
              }} style={{ padding: '8px 16px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>è¿½åŠ </button>
            </div>
          </div>

          {/* ãƒ‡ãƒ¼ã‚¿ç®¡ç† */}
          <div style={{ background: theme.bgSecondary, borderRadius: '12px', padding: '20px', border: `1px solid ${theme.border}` }}>
            <h3 style={{ fontSize: '15px', fontWeight: '600', marginBottom: '12px' }}>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              <button onClick={() => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `note-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
              }} style={{ padding: '10px 20px', background: theme.accent, color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Download /> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(JSON)
              </button>
              <button onClick={() => {
                // å…¨ä½œå“ã‚’TXTã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const allProjects = [...(data.creative.inProgress || []), ...(data.creative.completed || []), ...(data.creative.onHold || [])];
                let txtContent = '';
                allProjects.forEach(project => {
                  txtContent += 'â•'.repeat(50) + '\n';
                  txtContent += `ã€${project.name}ã€‘\n`;
                  txtContent += 'â•'.repeat(50) + '\n\n';
                  const chapters = project.items.filter(i => i.type === 'chapter');
                  chapters.forEach(chapter => {
                    txtContent += `â”€â”€ ${chapter.name} â”€â”€\n\n`;
                    txtContent += (chapter.content || '') + '\n\n';
                  });
                  txtContent += '\n\n';
                });
                const blob = new Blob([txtContent], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ä½œå“ä¸€æ‹¬_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
              }} style={{ padding: '10px 20px', background: theme.success, color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Download /> ä½œå“ä¸€æ‹¬DL(TXT)
              </button>
              <button onClick={() => {
                // åŸ·ç­†ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const progress = data.progress || {};
                const adjustments = data.progressAdjustments || {};
                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
                const dates = Object.keys(progress).sort();
                if (dates.length === 0) {
                  alert('åŸ·ç­†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                  return;
                }
                // CSVä½œæˆ
                let csv = 'æ—¥ä»˜,åŸ·ç­†æ–‡å­—æ•°,èª¿æ•´å€¤,åˆè¨ˆ\n';
                dates.forEach(date => {
                  const raw = progress[date] || 0;
                  const adj = adjustments[date] || 0;
                  const total = Math.max(0, raw + adj);
                  csv += `${date},${raw},${adj},${total}\n`;
                });
                // BOMä»˜ãUTF-8ã§å‡ºåŠ›ï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ãªã„ï¼‰
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csv], { type: 'text/csv; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `åŸ·ç­†è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
              }} style={{ padding: '10px 20px', background: '#9c27b0', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Download /> åŸ·ç­†è¨˜éŒ²DL(CSV)
              </button>
              <label style={{ padding: '10px 20px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '8px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Upload /> ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                <input type="file" accept=".json" onChange={(e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                      try {
                        const imported = JSON.parse(ev.target.result);
                        if (imported.creative) { setData(imported); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼'); }
                        else { alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™'); }
                      } catch { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); }
                    };
                    reader.readAsText(file);
                  }
                  e.target.value = '';
                }} style={{ display: 'none' }} />
              </label>
              <button onClick={() => {
                if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ï¼‰')) {
                  localStorage.removeItem('noteAppDataV2');
                  location.reload();
                }
              }} style={{ padding: '10px 20px', background: theme.error, color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
            <p style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '12px' }}>
              â€» ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€Œãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã€ã§åˆæœŸåŒ–ã—ã¦ãã ã•ã„
            </p>
          </div>
        </div>
      );
    };

    // ==================== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ====================
    function NoteApp() {
      const [darkMode, setDarkMode] = useState(true);
      const [currentSection, setCurrentSection] = useState('home');
      const [openPanes, setOpenPanes] = useState([]); // é–‹ã„ã¦ã„ã‚‹ãƒšã‚¤ãƒ³ï¼ˆæœ€å¤§3ã¤ï¼‰
      const [activePaneId, setActivePaneId] = useState(null); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ã®ID
      const [paneWidths, setPaneWidths] = useState({}); // å„ãƒšã‚¤ãƒ³ã®å¹…ï¼ˆflexå€¤ï¼‰
      const [resizingPane, setResizingPane] = useState(null); // ãƒªã‚µã‚¤ã‚ºä¸­ã®ãƒšã‚¤ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      const [draggingPaneId, setDraggingPaneId] = useState(null); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒšã‚¤ãƒ³ID
      const [dragOverPaneId, setDragOverPaneId] = useState(null); // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ä¸­ã®ãƒšã‚¤ãƒ³ID
      const paneScrollPositions = useRef({}); // å„ãƒšã‚¤ãƒ³ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
      const [sidebarWidth, setSidebarWidth] = useState(280);
      const [isResizing, setIsResizing] = useState(false);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false); // ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿
      const [showFloatingTimer, setShowFloatingTimer] = useState(false); // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
      const [creativeActiveTab, setCreativeActiveTab] = useState('works'); // å‰µä½œã‚¿ãƒ–ï¼ˆä½œå“/ãƒã‚¿/ä»˜ç®‹ï¼‰
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·é–¢é€£
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [passwordInput, setPasswordInput] = useState('');
      const [passwordError, setPasswordError] = useState('');
      const [showPasswordInput, setShowPasswordInput] = useState(false);
      const [secretTapCount, setSecretTapCount] = useState(0); // ç§˜å¯†ã®5å›ã‚¿ãƒƒãƒ—ç”¨
      
      // åŒæœŸè¨­å®š
      const [syncSettings, setSyncSettings] = useState(() => ({
        githubToken: localStorage.getItem('noteAppGithubToken') || '',
        gistId: localStorage.getItem('noteAppGistId') || '',
        passwordHash: localStorage.getItem('noteAppPasswordHash') || '',
        rememberPassword: localStorage.getItem('noteAppRememberPw') === 'true',
        password: localStorage.getItem('noteAppRememberPw') === 'true' ? (localStorage.getItem('noteAppSavedPw') || '') : '', // è¨˜æ†¶ONãªã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
      }));
      const [syncStatus, setSyncStatus] = useState(''); // '', 'saving', 'saved', 'loading', 'loaded', 'error'
      const [showGistPasswordModal, setShowGistPasswordModal] = useState(false); // Gistèª­ã¿è¾¼ã¿ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
      const [gistPasswordInput, setGistPasswordInput] = useState(''); // Gistèª­ã¿è¾¼ã¿ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
      
      // èµ·å‹•æ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
      useEffect(() => {
        const checkPassword = async () => {
          const savedHash = localStorage.getItem('noteAppPasswordHash');
          const rememberPw = localStorage.getItem('noteAppRememberPw') === 'true';
          const hasData = localStorage.getItem('noteAppDataV2');
          
          if (!savedHash && !hasData) {
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®šã€ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰â†’ ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¶­æŒï¼ˆ5å›ã‚¿ãƒƒãƒ—å¿…è¦ï¼‰
            setIsUnlocked(false);
          } else if (!savedHash) {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®šã ãŒãƒ‡ãƒ¼ã‚¿ã‚ã‚Š â†’ ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
            setIsUnlocked(true);
          } else if (rememberPw) {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨˜æ†¶ãŒON â†’ ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
            setIsUnlocked(true);
          } else {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãŒå¿…è¦
            setIsUnlocked(false);
          }
        };
        checkPassword();
      }, []);
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
      const handlePasswordSubmit = async () => {
        if (!passwordInput) {
          setPasswordError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          const inputHash = await CryptoUtils.hashPassword(passwordInput);
          if (inputHash === syncSettings.passwordHash) {
            setSyncSettings(prev => ({ ...prev, password: passwordInput }));
            // rememberPasswordãŒONãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚‚ä¿å­˜
            if (syncSettings.rememberPassword) {
              localStorage.setItem('noteAppSavedPw', passwordInput);
            }
            setIsUnlocked(true);
            setPasswordError('');
            setPasswordInput('');
          } else {
            setPasswordError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
          }
        } catch (e) {
          setPasswordError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      };
      
      const [data, setData] = useState(() => {
        try { 
          const saved = localStorage.getItem('noteAppDataV2'); 
          if (saved) {
            const parsed = JSON.parse(saved);
            // ä¸è¶³ã—ã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’initialDataã‹ã‚‰è£œå®Œï¼ˆç©ºé…åˆ—ã®å ´åˆã‚‚initialDataä½¿ç”¨ï¼‰
            return { 
              ...initialData,
              ...parsed,
              tags: (parsed.tags && parsed.tags.length > 0) ? parsed.tags : initialData.tags,
              dailyTags: (parsed.dailyTags && parsed.dailyTags.length > 0) ? parsed.dailyTags : initialData.dailyTags,
              inputTags: (parsed.inputTags && parsed.inputTags.length > 0) ? parsed.inputTags : initialData.inputTags,
              widgetLayout: initialData.widgetLayout,
              creative: {
                ...initialData.creative,
                ...parsed.creative,
              }
            };
          }
          return initialData; 
        }
        catch { return initialData; }
      });

      const theme = getTheme(darkMode);
      
      // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      const exportToJSON = () => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `note-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        setTimeout(() => alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼'), 100);
      };
      
      // Gistã«ä¿å­˜
      const handleSaveToGist = async () => {
        // Web Crypto APIã®ãƒã‚§ãƒƒã‚¯
        const cryptoCheck = CryptoUtils.isAvailable();
        if (!cryptoCheck.available) {
          alert(`æš—å·åŒ–æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“\n\n${cryptoCheck.reason}`);
          return;
        }
        
        if (!syncSettings.githubToken || !syncSettings.passwordHash) {
          alert('GitHubãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„');
          return;
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆè¨˜æ†¶ã•ã‚Œã¦ã‚‹å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã—ï¼‰
        let password = syncSettings.password;
        if (!password) {
          password = prompt('æš—å·åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
          if (!password) return;
          
          // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
          const inputHash = await CryptoUtils.hashPassword(password);
          if (inputHash !== syncSettings.passwordHash) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
            return;
          }
          setSyncSettings(prev => ({ ...prev, password }));
          // rememberPasswordãŒONãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚‚ä¿å­˜
          if (syncSettings.rememberPassword) {
            localStorage.setItem('noteAppSavedPw', password);
          }
        }
        
        try {
          setSyncStatus('saving');
          
          // localStorageã‹ã‚‰ç›´æ¥JSONã‚’å–å¾—ï¼ˆæ—¢ã«ã‚¯ãƒªãƒ¼ãƒ³ãªæ–‡å­—åˆ—ï¼‰
          const jsonString = localStorage.getItem('noteAppDataV2');
          if (!jsonString) {
            throw new Error('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          }
          
          const encrypted = await CryptoUtils.encrypt(jsonString, password);
          const result = await GistAPI.saveToGist(
            syncSettings.githubToken,
            syncSettings.gistId,
            encrypted,
            syncSettings.passwordHash
          );
          
          // æ–°è¦ä½œæˆã®å ´åˆã€Gist IDã‚’ä¿å­˜
          if (!syncSettings.gistId) {
            setSyncSettings(prev => ({ ...prev, gistId: result.id }));
            localStorage.setItem('noteAppGistId', result.id);
          }
          
          setSyncStatus('saved');
          alert('GitHubã«ä¿å­˜ã—ã¾ã—ãŸï¼');
          setTimeout(() => setSyncStatus(''), 3000);
        } catch (e) {
          console.error('Gist save error:', e);
          setSyncStatus('error');
          alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
          setTimeout(() => setSyncStatus(''), 3000);
        }
      };
      
      // Gistã‹ã‚‰èª­ã¿è¾¼ã¿
      const handleLoadFromGist = async (passwordFromModal) => {
        // Web Crypto APIã®ãƒã‚§ãƒƒã‚¯
        const cryptoCheck = CryptoUtils.isAvailable();
        if (!cryptoCheck.available) {
          alert(`æš—å·åŒ–æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“\n\n${cryptoCheck.reason}`);
          return;
        }
        
        // ã©ã‚ŒãŒè¶³ã‚Šãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const missing = [];
        if (!syncSettings.githubToken) missing.push('GitHubãƒˆãƒ¼ã‚¯ãƒ³');
        if (!syncSettings.gistId) missing.push('Gist ID');
        if (!syncSettings.passwordHash) missing.push('æš—å·åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
        
        if (missing.length > 0) {
          alert(`ä»¥ä¸‹ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼š\n\n${missing.join('\n')}\n\nè¨­å®šç”»é¢ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          return;
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
        let password = syncSettings.password || passwordFromModal;
        if (!password) {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
          setShowGistPasswordModal(true);
          return;
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
        const inputHash = await CryptoUtils.hashPassword(password);
        if (inputHash !== syncSettings.passwordHash) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
          setGistPasswordInput('');
          return;
        }
        
        setSyncSettings(prev => ({ ...prev, password }));
        // rememberPasswordãŒONãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚‚ä¿å­˜
        if (syncSettings.rememberPassword) {
          localStorage.setItem('noteAppSavedPw', password);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        setShowGistPasswordModal(false);
        setGistPasswordInput('');
        
        if (!confirm('ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰')) {
          return;
        }
        
        try {
          setSyncStatus('loading');
          
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—1: Gistã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
          const gistData = await GistAPI.loadFromGist(syncSettings.githubToken, syncSettings.gistId);
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—2: Gistãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
          
          // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®æ¤œè¨¼
          if (gistData.hash !== syncSettings.passwordHash) {
            throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚');
          }
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼å®Œäº†');
          
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—4: å¾©å·åŒ–é–‹å§‹');
          const decrypted = await CryptoUtils.decrypt(gistData.encrypted, password);
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—5: å¾©å·åŒ–å®Œäº†');
          
          // ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const currentData = JSON.parse(localStorage.getItem('noteAppDataV2') || '{}');
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
          
          // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒãƒ¼ã‚¸ï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«ãªã„å ´åˆã«ä¿æŒï¼‰
          const mergedData = {
            ...decrypted,
            // progressAdjustments: å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ãªã‘ã‚Œã°ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            progressAdjustments: decrypted.progressAdjustments || currentData.progressAdjustments || {},
            // stickyColors: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            stickyColors: decrypted.stickyColors || currentData.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'],
            // creativeå†…ã®stickiesã‚‚ä¿æŒ
            creative: {
              ...decrypted.creative,
              stickies: decrypted.creative?.stickies || currentData.creative?.stickies || [],
            }
          };
          console.log('[Gistèª­ã¿è¾¼ã¿] ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å®Œäº†');
          
          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ä»˜ç®‹ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚ãƒãƒ¼ã‚¸
          ['inProgress', 'completed', 'onHold'].forEach(status => {
            if (mergedData.creative[status]) {
              mergedData.creative[status] = mergedData.creative[status].map(project => {
                // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åŒã˜IDã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™
                const currentProject = currentData.creative?.[status]?.find(p => p.id === project.id);
                return {
                  ...project,
                  // ä»˜ç®‹ãŒãªã‘ã‚Œã°ç¾åœ¨ã®ã‚’ä¿æŒ
                  stickies: project.stickies || currentProject?.stickies || [],
                  // itemsã®ä¸­ã®highlightsã‚‚ãƒãƒ¼ã‚¸
                  items: (project.items || []).map(item => {
                    const currentItem = currentProject?.items?.find(i => i.id === item.id);
                    return {
                      ...item,
                      highlights: item.highlights || currentItem?.highlights || []
                    };
                  })
                };
              });
            }
          });
          
          // ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’ç¢ºèª
          const inProgressCount = mergedData?.creative?.inProgress?.length || 0;
          const completedCount = mergedData?.creative?.completed?.length || 0;
          const onHoldCount = mergedData?.creative?.onHold?.length || 0;
          const dailyMemoCount = mergedData?.dailyMemos?.length || 0;
          const inputCount = mergedData?.input?.length || 0;
          
          // localStorageã«ä¿å­˜
          localStorage.setItem('noteAppDataV2', JSON.stringify(mergedData));
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
          alert(`èª­ã¿è¾¼ã¿å®Œäº†ï¼\n\né€²è¡Œä¸­: ${inProgressCount}\nå®Œäº†: ${completedCount}\nä¸­æ–­: ${onHoldCount}\næ—¥å¸¸ãƒ¡ãƒ¢: ${dailyMemoCount}\nInput: ${inputCount}\n\nãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™ã€‚`);
          window.location.reload();
          
        } catch (e) {
          console.error('Gist load error:', e);
          console.error('Error stack:', e.stack);
          setSyncStatus('error');
          
          // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          let errorMsg = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n';
          errorMsg += `ã‚¨ãƒ©ãƒ¼: ${e.message}\n\n`;
          
          if (e.message.includes('fetch') || e.message.includes('network')) {
            errorMsg += 'ã€åŸå› ã€‘ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n';
            errorMsg += 'ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n';
            errorMsg += 'ãƒ»GitHubãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„';
          } else if (e.message.includes('decrypt') || e.message.includes('crypto')) {
            errorMsg += 'ã€åŸå› ã€‘å¾©å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ\n';
            errorMsg += 'ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„\n';
            errorMsg += 'ãƒ»iOS/Safariã®å ´åˆã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ã‚’è§£é™¤ã—ã¦ãã ã•ã„';
          } else if (e.message.includes('JSON') || e.message.includes('parse')) {
            errorMsg += 'ã€åŸå› ã€‘ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n';
            errorMsg += 'ãƒ»Gistã®ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
          } else {
            errorMsg += 'ã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã€‘\n';
            errorMsg += 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
          }
          
          alert(errorMsg);
          setTimeout(() => setSyncStatus(''), 3000);
        }
      };

      // Ctrl+S / Cmd+S ã§ä¿å­˜
      useEffect(() => {
        const handleKeyDown = (e) => {
          // Ctrl+S (Windows/Linux) ã¾ãŸã¯ Cmd+S (Mac)
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's' && !e.shiftKey) {
            e.preventDefault();
            e.stopPropagation();
            if (syncSettings.githubToken && syncSettings.passwordHash) {
              handleSaveToGist();
            } else {
              alert('GitHubãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆè¨­å®šç”»é¢ã‹ã‚‰ï¼‰');
            }
            return;
          }

          // Ctrl+Shift+L ã§Gistèª­ã¿è¾¼ã¿ï¼ˆå…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€šï¼‰
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'L') {
            e.preventDefault();
            e.stopPropagation();
            handleLoadFromGist();
            return;
          }

          // Ctrl+Shift+E ã§JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€šï¼‰
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'E') {
            e.preventDefault();
            e.stopPropagation();
            exportToJSON();
            return;
          }

          // Ctrl+Shift+I ã§JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€šï¼‰
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'I') {
            e.preventDefault();
            e.stopPropagation();
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  try {
                    const imported = JSON.parse(e.target.result);
                    setData(imported);
                    localStorage.setItem('noteAppDataV2', e.target.result);
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                  } catch (err) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                  }
                };
                reader.readAsText(file);
              }
            };
            input.click();
            return;
          }

          // å‰µä½œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã®ã¿æœ‰åŠ¹ãªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
          if (currentSection === 'creative') {
            // Ctrl+1/2/3 ã§ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
              if (e.key === '1') {
                e.preventDefault();
                e.stopPropagation();
                setCreativeActiveTab('works');
                return;
              } else if (e.key === '2') {
                e.preventDefault();
                e.stopPropagation();
                setCreativeActiveTab('ideas');
                return;
              } else if (e.key === '3') {
                e.preventDefault();
                e.stopPropagation();
                setCreativeActiveTab('stickies');
                return;
              }
            }

            // Ctrl+Shift+M ã§ãƒã‚¿è¿½åŠ 
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'M') {
              e.preventDefault();
              e.stopPropagation();
              setCreativeActiveTab('ideas');
              // ãƒã‚¿ã‚’è¿½åŠ 
              const newIdea = { 
                id: `idea-${Date.now()}`, 
                title: 'æ–°ã—ã„ãƒã‚¿', 
                content: '', 
                tags: [], 
                status: 'unused', 
                createdAt: new Date().toISOString() 
              };
              setData(prev => ({ 
                ...prev, 
                creative: { 
                  ...prev.creative, 
                  ideas: [newIdea, ...(prev.creative.ideas || [])] 
                } 
              }));
              // æ–°ã—ã„ãƒã‚¿ã‚’é–‹ã
              setTimeout(() => {
                setSelectedItem({ ...newIdea, isIdea: true });
              }, 100);
              return;
            }

            // Ctrl+Shift+P ã§ä»˜ç®‹è¿½åŠ ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã§ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã—ã¦ãªã„æ™‚ã®ã¿ï¼‰
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'P') {
              // ã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã—ã¦ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆSplitEditorã§ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ç®‹ã¨ã—ã¦å‡¦ç†ï¼‰
              const activeElement = document.activeElement;
              const isInEditor = activeElement && activeElement.tagName === 'TEXTAREA' && activeElement.selectionStart !== activeElement.selectionEnd;
              
              if (!isInEditor) {
                e.preventDefault();
                e.stopPropagation();
                setCreativeActiveTab('stickies');
                // ä»˜ç®‹ã‚’è¿½åŠ 
                const stickyColors = data.stickyColors || ['#FFEB3B', '#FF9800', '#E91E63', '#4CAF50', '#2196F3', '#9C27B0'];
                const stickies = data.creative?.stickies || [];
                const newSticky = { 
                  id: `sticky-${Date.now()}`, 
                  content: '', 
                  color: stickyColors[stickies.length % stickyColors.length], 
                  createdAt: new Date().toISOString() 
                };
                setData(prev => ({ 
                  ...prev, 
                  creative: { 
                    ...prev.creative, 
                    stickies: [newSticky, ...(prev.creative.stickies || [])] 
                  } 
                }));
                return;
              }
            }
          }
        };

        document.addEventListener('keydown', handleKeyDown, true); // useCapture=trueã§å„ªå…ˆçš„ã«ã‚­ãƒ£ãƒƒãƒ
        return () => document.removeEventListener('keydown', handleKeyDown, true);
      }, [syncSettings.githubToken, syncSettings.passwordHash, handleSaveToGist, handleLoadFromGist, exportToJSON, currentSection, data, setData, setSelectedItem, setCreativeActiveTab]);

      // äº’æ›æ€§ã®ãŸã‚
      const selectedItem = openPanes.find(p => p.id === activePaneId) || openPanes[0] || null;

      // ã‚¢ã‚¤ãƒ†ãƒ ã‚’é–‹ãï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ã§é–‹ãã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼‰
      const setSelectedItem = (item) => {
        if (!item) return;
        // æ—¢ã«é–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèª
        const existingIndex = openPanes.findIndex(p => p.id === item.id);
        if (existingIndex >= 0) {
          // æ—¢ã«é–‹ã„ã¦ã„ã‚‹ â†’ ãã®ãƒšã‚¤ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
          setActivePaneId(item.id);
          return;
        }
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ãŒã‚ã‚Œã°ã€ãã®å†…å®¹ã‚’ç½®ãæ›ãˆ
        if (activePaneId && openPanes.some(p => p.id === activePaneId)) {
          setOpenPanes(prev => prev.map(p => p.id === activePaneId ? item : p));
          setActivePaneId(item.id);
        } else if (openPanes.length > 0) {
          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ãŒãªã„ã‘ã©ãƒšã‚¤ãƒ³ãŒã‚ã‚‹ â†’ æœ€åˆã®ãƒšã‚¤ãƒ³ã‚’ç½®ãæ›ãˆ
          setOpenPanes(prev => [item, ...prev.slice(1)]);
          setActivePaneId(item.id);
        } else {
          // ãƒšã‚¤ãƒ³ãŒãªã„ â†’ æ–°è¦ä½œæˆ
          setOpenPanes([item]);
          setActivePaneId(item.id);
        }
      };

      // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
      const openInNewPane = (item) => {
        if (!item) return;
        // æ—¢ã«é–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèª
        const existingIndex = openPanes.findIndex(p => p.id === item.id);
        if (existingIndex >= 0) {
          setActivePaneId(item.id);
          return;
        }
        
        // æœ€å¤§3ãƒšã‚¤ãƒ³ã¾ã§
        if (openPanes.length >= 3) {
          setOpenPanes(prev => [...prev.slice(1), item]);
        } else {
          setOpenPanes(prev => [...prev, item]);
        }
        setActivePaneId(item.id);
      };

      // ãƒšã‚¤ãƒ³ã‚’é–‰ã˜ã‚‹
      const closePane = (paneId) => {
        setOpenPanes(prev => {
          const newPanes = prev.filter(p => p.id !== paneId);
          // é–‰ã˜ãŸã®ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ã ã£ãŸå ´åˆã€åˆ¥ã®ãƒšã‚¤ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
          if (paneId === activePaneId && newPanes.length > 0) {
            setActivePaneId(newPanes[newPanes.length - 1].id);
          } else if (newPanes.length === 0) {
            setActivePaneId(null);
          }
          return newPanes;
        });
      };

      // ãƒšã‚¤ãƒ³ã®å†…å®¹ã‚’æ›´æ–°
      const updatePaneContent = (paneId, content) => {
        setOpenPanes(prev => prev.map(p => p.id === paneId ? { ...p, content } : p));
      };

      useEffect(() => {
        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®æ™‚ã ã‘è‡ªå‹•ä¿å­˜ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç”»é¢ã§ã¯ä¿å­˜ã—ãªã„ï¼‰
        if (!isUnlocked) return;
        const timer = setTimeout(() => localStorage.setItem('noteAppDataV2', JSON.stringify(data)), 500);
        return () => clearTimeout(timer);
      }, [data, isUnlocked]);

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚µã‚¤ã‚º
      const handleMouseDown = () => setIsResizing(true);
      useEffect(() => {
        const handleMouseMove = (e) => {
          if (isResizing) {
            const newWidth = Math.min(Math.max(200, e.clientX - 64), 500);
            setSidebarWidth(newWidth);
          }
        };
        const handleMouseUp = () => setIsResizing(false);
        if (isResizing) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isResizing]);

      // ãƒšã‚¤ãƒ³ãƒªã‚µã‚¤ã‚º
      const paneContainerRef = useRef(null);
      const handlePaneResizeStart = (index) => setResizingPane(index);
      useEffect(() => {
        const handlePaneMouseMove = (e) => {
          if (resizingPane !== null && paneContainerRef.current) {
            const container = paneContainerRef.current;
            const rect = container.getBoundingClientRect();
            const totalWidth = rect.width;
            const mouseX = e.clientX - rect.left;
            
            // ãƒªã‚µã‚¤ã‚¶ãƒ¼ã®å·¦å´ã®ãƒšã‚¤ãƒ³ãŸã¡ã®åˆè¨ˆå¹…ã‚’è¨ˆç®—
            let leftPanesWidth = 0;
            for (let i = 0; i < resizingPane; i++) {
              leftPanesWidth += (paneWidths[openPanes[i]?.id] || 1) / openPanes.length * totalWidth;
            }
            
            // æ–°ã—ã„å¹…ã‚’è¨ˆç®—ï¼ˆæœ€å°300pxï¼‰
            const newWidth = Math.max(300, mouseX - leftPanesWidth);
            const newFlex = (newWidth / totalWidth) * openPanes.length;
            
            setPaneWidths(prev => ({
              ...prev,
              [openPanes[resizingPane].id]: Math.max(0.3, Math.min(2.5, newFlex))
            }));
          }
        };
        const handlePaneMouseUp = () => setResizingPane(null);
        if (resizingPane !== null) {
          document.addEventListener('mousemove', handlePaneMouseMove);
          document.addEventListener('mouseup', handlePaneMouseUp);
        }
        return () => {
          document.removeEventListener('mousemove', handlePaneMouseMove);
          document.removeEventListener('mouseup', handlePaneMouseUp);
        };
      }, [resizingPane, openPanes, paneWidths]);

      // ãƒšã‚¤ãƒ³ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å…¥ã‚Œæ›¿ãˆ
      const handlePaneDragStart = (e, paneId) => {
        setDraggingPaneId(paneId);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', paneId);
      };
      
      const handlePaneDragOver = (e, paneId) => {
        e.preventDefault();
        if (draggingPaneId && draggingPaneId !== paneId) {
          setDragOverPaneId(paneId);
        }
      };
      
      const handlePaneDragLeave = () => {
        setDragOverPaneId(null);
      };
      
      const handlePaneDrop = (e, targetPaneId) => {
        e.preventDefault();
        if (draggingPaneId && draggingPaneId !== targetPaneId) {
          const dragIndex = openPanes.findIndex(p => p.id === draggingPaneId);
          const dropIndex = openPanes.findIndex(p => p.id === targetPaneId);
          if (dragIndex !== -1 && dropIndex !== -1) {
            const newPanes = [...openPanes];
            const [draggedPane] = newPanes.splice(dragIndex, 1);
            newPanes.splice(dropIndex, 0, draggedPane);
            setOpenPanes(newPanes);
          }
        }
        setDraggingPaneId(null);
        setDragOverPaneId(null);
      };
      
      const handlePaneDragEnd = () => {
        setDraggingPaneId(null);
        setDragOverPaneId(null);
      };

      const updateItemContent = (itemId, content, paneItem) => {
        if (!paneItem) return;
        
        setData(prev => {
          let newData = { ...prev };
          
          // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°ï¼ˆchapterã‚¿ã‚¤ãƒ—ã®ã¿ï¼‰
          if (paneItem.type === 'chapter' && !paneItem.isIdea && !paneItem.isHoldItem) {
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            // paneItemã¯å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸæ›´æ–°å‰ã®å€¤ã‚’ä½¿ã†ï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£å•é¡Œã‚’å›é¿ï¼‰
            const prevContent = paneItem.content || '';
            const prevCount = prevContent.replace(/[\s\n]/g, '').length;
            const newCount = content.replace(/[\s\n]/g, '').length;
            const diff = newCount - prevCount;
            if (diff !== 0) {
              const currentProgress = prev.progress[today] || 0;
              const newProgress = Math.max(0, currentProgress + diff);
              newData = { ...newData, progress: { ...newData.progress, [today]: newProgress } };
            }
          }
          
          // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ›´æ–°
          if (paneItem.isIdea) {
            const ideas = prev.creative.ideas || [];
            newData = { ...newData, creative: { ...newData.creative, ideas: ideas.map(i => i.id === itemId ? { ...i, content } : i) } };
          } else if (paneItem.isHoldItem) {
            newData = { ...newData, creative: { ...newData.creative, holdItems: (prev.creative.holdItems || []).map(i => i.id === itemId ? { ...i, content } : i) } };
          } else {
            const { status } = paneItem;
            newData = { ...newData, creative: { ...newData.creative, [status]: prev.creative[status].map(p => p.id === paneItem.projectId ? { ...p, items: p.items.map(i => i.id === itemId ? { ...i, content } : i) } : p) } };
          }
          
          return newData;
        });
        
        // openPanesã‚‚æ›´æ–°ã™ã‚‹ï¼ˆReact.memoãŒcontentã‚’æ¯”è¼ƒã™ã‚‹ãŸã‚å¿…è¦ï¼‰
        updatePaneContent(itemId, content);
      };

      // ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
      const [showMobileSidebar, setShowMobileSidebar] = useState(false);
      
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      const navItems = [
        { id: 'home', icon: <Icons.Home />, label: 'ãƒ›ãƒ¼ãƒ ' },
        { id: 'creative', icon: <Icons.Edit />, label: 'å‰µä½œ' },
        { id: 'daily', icon: <Icons.FileText />, label: 'æ—¥å¸¸' },
        { id: 'input', icon: <Icons.Book />, label: 'Input' },
      ];

      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯ç”»é¢ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ¸ˆã¿ã®å ´åˆï¼‰
      if (!isUnlocked && syncSettings.passwordHash) {
        return (
          <div style={{ display: 'flex', height: '100vh', background: theme.bg, color: theme.text, fontFamily: '"Noto Sans JP", sans-serif', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ background: theme.bgSecondary, borderRadius: '16px', padding: '40px', maxWidth: '400px', width: '90%', border: `1px solid ${theme.border}`, textAlign: 'center' }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ”</div>
              <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px' }}>NoteApp</h2>
              <p style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '24px' }}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
              
              <div style={{ position: 'relative', marginBottom: '16px' }}>
                <input 
                  type={showPasswordInput ? 'text' : 'password'}
                  value={passwordInput}
                  onChange={(e) => { setPasswordInput(e.target.value); setPasswordError(''); }}
                  onKeyDown={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                  placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                  autoFocus
                  style={{ 
                    width: '100%', 
                    padding: '14px 44px 14px 16px', 
                    background: theme.bg, 
                    border: `1px solid ${passwordError ? theme.error : theme.border}`, 
                    borderRadius: '8px', 
                    color: theme.text, 
                    fontSize: '15px', 
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                />
                <button 
                  onClick={() => setShowPasswordInput(!showPasswordInput)} 
                  style={{ 
                    position: 'absolute', 
                    right: '12px', 
                    top: '50%', 
                    transform: 'translateY(-50%)', 
                    background: 'none', 
                    border: 'none', 
                    color: theme.textSecondary, 
                    cursor: 'pointer',
                    padding: '4px'
                  }}
                >
                  {showPasswordInput ? <Icons.EyeOff /> : <Icons.Eye />}
                </button>
              </div>
              
              <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '16px', fontSize: '12px', color: theme.textSecondary, cursor: 'pointer' }}>
                <input 
                  type="checkbox"
                  checked={syncSettings.rememberPassword}
                  onChange={(e) => {
                    setSyncSettings(prev => ({ ...prev, rememberPassword: e.target.checked }));
                    if (e.target.checked) {
                      localStorage.setItem('noteAppRememberPw', 'true');
                    } else {
                      localStorage.removeItem('noteAppRememberPw');
                      localStorage.removeItem('noteAppSavedPw');
                    }
                  }}
                />
                ã“ã®ç«¯æœ«ã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨˜æ†¶ã™ã‚‹
              </label>
              
              {passwordError && (
                <p style={{ fontSize: '12px', color: theme.error, marginBottom: '16px' }}>{passwordError}</p>
              )}
              
              <button 
                onClick={handlePasswordSubmit}
                style={{ 
                  width: '100%', 
                  padding: '14px', 
                  background: theme.accent, 
                  color: '#fff', 
                  border: 'none', 
                  borderRadius: '8px', 
                  cursor: 'pointer', 
                  fontSize: '15px',
                  fontWeight: '500'
                }}
              >
                ãƒ­ãƒƒã‚¯è§£é™¤
              </button>
              
              <p style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '24px' }}>
                ğŸ›¡ï¸ ãƒ‡ãƒ¼ã‚¿ã¯æš—å·åŒ–ã•ã‚Œã¦ä¿è­·ã•ã‚Œã¦ã„ã¾ã™
              </p>
            </div>
          </div>
        );
      }
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®š ã‹ã¤ localStorageã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ ã‹ã¤ ãƒ­ãƒƒã‚¯çŠ¶æ…‹ â†’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç”»é¢
      const hasLocalData = localStorage.getItem('noteAppDataV2');
      
      if (!isUnlocked && !syncSettings.passwordHash && !hasLocalData) {
        // ç§˜å¯†ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: ãƒ­ã‚´ã‚’5å›ã‚¿ãƒƒãƒ—ã§è¨­å®šç”»é¢ã¸
        const handleSecretTap = () => {
          const newCount = secretTapCount + 1;
          setSecretTapCount(newCount);
          if (newCount >= 5) {
            setIsUnlocked(true);
            setCurrentSection('settings');
            setSecretTapCount(0);
          }
        };
        
        return (
          <div style={{ display: 'flex', height: '100vh', background: theme.bg, color: theme.text, fontFamily: '"Noto Sans JP", sans-serif', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ background: theme.bgSecondary, borderRadius: '16px', padding: '40px', maxWidth: '400px', width: '90%', border: `1px solid ${theme.border}`, textAlign: 'center' }}>
              <div 
                onClick={handleSecretTap} 
                style={{ fontSize: '48px', marginBottom: '16px', cursor: 'default', userSelect: 'none', WebkitTapHighlightColor: 'transparent' }}
              >ğŸ”’</div>
              <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px' }}>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¢ãƒ—ãƒª</h2>
              <p style={{ fontSize: '13px', color: theme.textSecondary }}>
                ã“ã®ã‚¢ãƒ—ãƒªã¯éå…¬é–‹ã§ã™
              </p>
            </div>
          </div>
        );
      }

      return (
        <div style={{ display: 'flex', flexDirection: isMobile ? 'column' : 'row', height: '100vh', background: theme.bg, color: theme.text, fontFamily: '"Noto Sans JP", sans-serif', overflow: 'hidden' }}>
          
          {/* PCç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå·¦ã‚µã‚¤ãƒ‰ï¼‰ */}
          {!isMobile && (
            <div style={{ width: '64px', background: theme.bgSecondary, borderRight: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '16px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '24px' }}>ğŸ““</div>
              {navItems.map(item => (
                <button key={item.id} onClick={() => setCurrentSection(item.id)} title={item.label} style={{ width: '44px', height: '44px', borderRadius: '12px', border: 'none', background: currentSection === item.id ? theme.accent : 'transparent', color: currentSection === item.id ? '#fff' : theme.textSecondary, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '8px', transition: 'all 0.2s' }}>{item.icon}</button>
              ))}
              <div style={{ flex: 1 }} />
              <button onClick={() => setDarkMode(!darkMode)} style={{ width: '44px', height: '44px', borderRadius: '12px', border: 'none', background: 'transparent', color: theme.textSecondary, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }} title={darkMode ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'}>{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
              <button onClick={() => setCurrentSection('settings')} style={{ width: '44px', height: '44px', borderRadius: '12px', border: 'none', background: currentSection === 'settings' ? theme.accent : 'transparent', color: currentSection === 'settings' ? '#fff' : theme.textSecondary, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', marginTop: '8px' }} title="è¨­å®š"><Icons.Settings /></button>
            </div>
          )}

          {/* PCç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå‰µä½œæ™‚ã®ã¿ï¼‰ */}
          {!isMobile && currentSection === 'creative' && (
            <>
              {sidebarCollapsed ? (
                /* æŠ˜ã‚ŠãŸãŸã¿æ™‚ï¼šç´°ã„ãƒãƒ¼ã¨ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
                <div style={{ width: '40px', background: theme.bgSecondary, borderRight: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', alignItems: 'center', paddingTop: '12px' }}>
                  <button 
                    onClick={() => setSidebarCollapsed(false)}
                    style={{ background: theme.accent, border: 'none', color: '#fff', cursor: 'pointer', padding: '8px', borderRadius: '6px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '8px' }}
                    title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã"
                  >
                    <Icons.ChevronRight />
                  </button>
                  <div style={{ writingMode: 'vertical-rl', fontSize: '12px', color: theme.textSecondary, letterSpacing: '2px' }}>âœï¸ å‰µä½œ</div>
                </div>
              ) : (
                /* å±•é–‹æ™‚ï¼šé€šå¸¸ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
                <div style={{ width: sidebarWidth, background: theme.bgSecondary, borderRight: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                  <div style={{ padding: '12px 16px', borderBottom: `1px solid ${theme.border}`, fontWeight: '600', fontSize: '15px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                    <span>âœï¸ å‰µä½œ</span>
                    <button 
                      onClick={() => setSidebarCollapsed(true)}
                      style={{ background: theme.bgTertiary, border: `1px solid ${theme.border}`, color: theme.textSecondary, cursor: 'pointer', padding: '4px 6px', borderRadius: '4px', display: 'flex', alignItems: 'center' }}
                      title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹"
                    >
                      <Icons.ChevronLeft />
                    </button>
                  </div>
                  <CreativeSection data={data} setData={setData} selectedItem={selectedItem} setSelectedItem={setSelectedItem} openInNewPane={openInNewPane} theme={theme} sidebarWidth={sidebarWidth} activeTab={creativeActiveTab} setActiveTab={setCreativeActiveTab} />
                </div>
              )}
              {!sidebarCollapsed && <div className="resizer" onMouseDown={handleMouseDown} style={{ background: isResizing ? theme.accent : 'transparent' }} />}
            </>
          )}

          {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */}
          {isMobile && showMobileSidebar && currentSection === 'creative' && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 60, background: theme.bgSecondary, zIndex: 999, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
              <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}`, fontWeight: '600', fontSize: '15px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span>âœï¸ å‰µä½œ</span>
                <button onClick={() => setShowMobileSidebar(false)} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '8px' }}><Icons.X /></button>
              </div>
              <CreativeSection 
                data={data} 
                setData={setData} 
                selectedItem={selectedItem} 
                setSelectedItem={(item) => { setSelectedItem(item); setShowMobileSidebar(false); }} 
                openInNewPane={(item) => { openInNewPane(item); setShowMobileSidebar(false); }} 
                theme={theme} 
                sidebarWidth={window.innerWidth} 
                activeTab={creativeActiveTab}
                setActiveTab={setCreativeActiveTab}
              />
            </div>
          )}

          {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', paddingBottom: isMobile ? '60px' : 0 }}>
            
            {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå‰µä½œæ™‚ã®ã¿ï¼‰ */}
            {isMobile && currentSection === 'creative' && (
              <div style={{ padding: '12px 16px', background: theme.bgSecondary, borderBottom: `1px solid ${theme.border}`, display: 'flex', alignItems: 'center', gap: '12px' }}>
                <button onClick={() => setShowMobileSidebar(true)} style={{ background: theme.accent, border: 'none', color: '#fff', cursor: 'pointer', padding: '8px 12px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' }}>
                  <Icons.Folder /> ä½œå“ä¸€è¦§
                </button>
                {selectedItem && <span style={{ fontSize: '13px', color: theme.textSecondary, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{selectedItem.name}</span>}
              </div>
            )}
            
            {currentSection === 'home' && <HomeScreen data={data} setData={setData} theme={theme} />}
            {currentSection === 'creative' && (
              <div ref={paneContainerRef} style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                {openPanes.length === 0 ? (
                  isMobile ? (
                    // ãƒ¢ãƒã‚¤ãƒ«ï¼šopenPanesãŒãªã‘ã‚Œã°è‡ªå‹•ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º
                    <div style={{ width: '100%', display: 'flex', flexDirection: 'column', background: theme.bgSecondary, overflow: 'hidden' }}>
                      <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}`, fontWeight: '600', fontSize: '15px' }}>âœï¸ å‰µä½œ</div>
                      <CreativeSection 
                        data={data} 
                        setData={setData} 
                        selectedItem={selectedItem} 
                        setSelectedItem={(item) => { setSelectedItem(item); }} 
                        openInNewPane={(item) => { openInNewPane(item); }} 
                        theme={theme} 
                        sidebarWidth={window.innerWidth} 
                        activeTab={creativeActiveTab}
                        setActiveTab={setCreativeActiveTab}
                      />
                    </div>
                  ) : (
                    // PCï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>
                      å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã­<br/>
                      <span style={{ fontSize: '12px', marginTop: '8px', opacity: 0.7 }}>è¤‡æ•°é¸æŠã™ã‚‹ã¨ç”»é¢åˆ†å‰²ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆ</span>
                    </div>
                  )
                ) : (
                  isMobile ? (
                    // ãƒ¢ãƒã‚¤ãƒ«ï¼š1ãƒšã‚¤ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆæœ€å¾Œã«é¸æŠã—ãŸã‚‚ã®ï¼‰
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                      <SplitEditor pane={openPanes[openPanes.length - 1]} onUpdate={(content) => updateItemContent(openPanes[openPanes.length - 1].id, content, openPanes[openPanes.length - 1])} theme={theme} data={data} setData={setData} scrollPositions={paneScrollPositions} />
                    </div>
                  ) : (
                    // PCï¼šè¤‡æ•°ãƒšã‚¤ãƒ³
                    openPanes.map((pane, index) => (
                      <React.Fragment key={pane.id}>
                        {index > 0 && (
                          <div 
                            onMouseDown={() => handlePaneResizeStart(index - 1)}
                            style={{ width: '6px', background: resizingPane === index - 1 ? theme.accent : theme.border, cursor: 'col-resize', transition: 'background 0.2s', flexShrink: 0 }} 
                            onMouseOver={(e) => e.target.style.background = theme.accent}
                            onMouseOut={(e) => { if (resizingPane !== index - 1) e.target.style.background = theme.border; }}
                          />
                        )}
                        <div 
                          style={{ 
                            flex: paneWidths[pane.id] || 1, 
                            display: 'flex', 
                            flexDirection: 'column', 
                            overflow: 'hidden', 
                            minWidth: '300px',
                            border: dragOverPaneId === pane.id ? `2px dashed ${theme.accent}` : '2px solid transparent',
                            opacity: draggingPaneId === pane.id ? 0.5 : 1,
                            transition: 'border 0.2s, opacity 0.2s'
                          }}
                          onDragOver={(e) => handlePaneDragOver(e, pane.id)}
                          onDragLeave={handlePaneDragLeave}
                          onDrop={(e) => handlePaneDrop(e, pane.id)}
                        >
                          <div 
                            draggable
                            onDragStart={(e) => handlePaneDragStart(e, pane.id)}
                            onDragEnd={handlePaneDragEnd}
                            onClick={() => activePaneId !== pane.id && setActivePaneId(pane.id)}
                            style={{ 
                              padding: '8px 12px', 
                              background: dragOverPaneId === pane.id ? theme.highlight : theme.bgSecondary, 
                              borderBottom: activePaneId === pane.id ? `2px solid ${theme.accent}` : `1px solid ${theme.border}`, 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '8px', 
                              cursor: 'grab'
                            }}
                          >
                            <span style={{ cursor: 'grab', color: theme.textSecondary, fontSize: '12px' }}>â ¿</span>
                            {pane.isIdea ? <Icons.Lightbulb /> : pane.isHoldItem ? <Icons.Pause /> : pane.type === 'memo' ? <Icons.File /> : <Icons.FileText />}
                            <span style={{ flex: 1, fontSize: '12px', fontWeight: activePaneId === pane.id ? '600' : '500', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', color: activePaneId === pane.id ? theme.accent : theme.text }}>
                              {pane.isIdea ? pane.title : pane.name}
                            </span>
                            <button onClick={(e) => { e.stopPropagation(); closePane(pane.id); }} style={{ background: 'none', border: 'none', color: theme.textSecondary, cursor: 'pointer', padding: '2px', display: 'flex' }}><Icons.X /></button>
                          </div>
                          <SplitEditor key={pane.id} pane={pane} onUpdate={(content) => updateItemContent(pane.id, content, pane)} theme={theme} data={data} setData={setData} scrollPositions={paneScrollPositions} />
                        </div>
                      </React.Fragment>
                    ))
                  )
                )}
              </div>
            )}
            {currentSection === 'daily' && <DailySection data={data} setData={setData} theme={theme} />}
            {currentSection === 'input' && <InputSection data={data} setData={setData} theme={theme} />}
            {currentSection === 'settings' && <SettingsScreen data={data} setData={setData} theme={theme} syncSettings={syncSettings} setSyncSettings={setSyncSettings} onSaveToGist={handleSaveToGist} onLoadFromGist={handleLoadFromGist} syncStatus={syncStatus} />}
          </div>

          {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
          {isMobile && (
            <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, height: '60px', background: theme.bgSecondary, borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-around', alignItems: 'center', zIndex: 1000 }}>
              {navItems.map(item => (
                <button key={item.id} onClick={() => { setCurrentSection(item.id); setShowMobileSidebar(false); }} style={{ flex: 1, height: '100%', border: 'none', background: 'transparent', color: currentSection === item.id ? theme.accent : theme.textSecondary, cursor: 'pointer', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                  {item.icon}
                  <span style={{ fontSize: '10px' }}>{item.label}</span>
                </button>
              ))}
              <button onClick={() => setCurrentSection('settings')} style={{ flex: 1, height: '100%', border: 'none', background: 'transparent', color: currentSection === 'settings' ? theme.accent : theme.textSecondary, cursor: 'pointer', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                <Icons.Settings />
                <span style={{ fontSize: '10px' }}>è¨­å®š</span>
              </button>
              <button onClick={() => setDarkMode(!darkMode)} style={{ flex: 1, height: '100%', border: 'none', background: 'transparent', color: theme.textSecondary, cursor: 'pointer', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                <span style={{ fontSize: '10px' }}>{darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</span>
              </button>
            </div>
          )}

          {/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼ˆå‰µä½œç”»é¢ã®ã¿ï¼‰ */}
          {currentSection === 'creative' && (
            <>
              {showFloatingTimer ? (
                <FloatingPomodoro theme={theme} onClose={() => setShowFloatingTimer(false)} />
              ) : (
                <button 
                  onClick={() => setShowFloatingTimer(true)}
                  style={{ 
                    position: 'fixed', bottom: isMobile ? '80px' : '20px', right: '20px', zIndex: 1001,
                    background: theme.accent, color: '#fff', border: 'none', borderRadius: '50%',
                    width: '50px', height: '50px', cursor: 'pointer', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px'
                  }}
                  title="ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼"
                >
                  ğŸ…
                </button>
              )}
            </>
          )}
          
          {/* Gistèª­ã¿è¾¼ã¿ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showGistPasswordModal && (
            <div style={{ 
              position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, 
              background: 'rgba(0,0,0,0.7)', zIndex: 2000,
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              padding: '20px'
            }}>
              <div style={{ 
                background: theme.bgSecondary, borderRadius: '16px', padding: '24px',
                maxWidth: '320px', width: '100%', boxShadow: '0 8px 32px rgba(0,0,0,0.3)'
              }}>
                <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', textAlign: 'center' }}>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h3>
                <p style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '16px', textAlign: 'center' }}>Gistã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
                <input 
                  type="password"
                  value={gistPasswordInput}
                  onChange={(e) => setGistPasswordInput(e.target.value)}
                  placeholder="æš—å·åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                  autoFocus
                  style={{ 
                    width: '100%', padding: '12px', fontSize: '14px',
                    background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '8px',
                    color: theme.text, marginBottom: '16px', outline: 'none'
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && gistPasswordInput) {
                      handleLoadFromGist(gistPasswordInput);
                    }
                  }}
                />
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button 
                    onClick={() => { setShowGistPasswordModal(false); setGistPasswordInput(''); }}
                    style={{ 
                      flex: 1, padding: '12px', fontSize: '14px',
                      background: theme.bgTertiary, color: theme.textSecondary, 
                      border: 'none', borderRadius: '8px', cursor: 'pointer'
                    }}
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button 
                    onClick={() => handleLoadFromGist(gistPasswordInput)}
                    disabled={!gistPasswordInput}
                    style={{ 
                      flex: 1, padding: '12px', fontSize: '14px',
                      background: gistPasswordInput ? theme.accent : theme.bgTertiary, 
                      color: gistPasswordInput ? '#fff' : theme.textSecondary, 
                      border: 'none', borderRadius: '8px', cursor: gistPasswordInput ? 'pointer' : 'not-allowed'
                    }}
                  >
                    èª­ã¿è¾¼ã¿
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<NoteApp />);
  </script>
</body>
</html>
